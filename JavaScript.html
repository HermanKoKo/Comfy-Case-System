<script>
let currentClient = null;

window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
  loadSystemStaff();
  updateNavState();
};

// 載入醫師、護理師、治療師名單
function loadSystemStaff() {
  google.script.run.withSuccessHandler(staff => {
    // 醫師 (A欄)
    const docSelect = document.getElementById('selectDoctor');
    if(docSelect) {
      docSelect.innerHTML = '<option value="" disabled selected>請選擇醫師</option>';
      staff.doctors.forEach(name => docSelect.innerHTML += `<option value="${name}">${name}</option>`);
    }
    // 護理師 (B欄)
    const nurseSelect = document.getElementById('selectNurse');
    if(nurseSelect) {
      nurseSelect.innerHTML = '<option value="" disabled selected>請選擇護理師</option>';
      staff.nurses.forEach(name => nurseSelect.innerHTML += `<option value="${name}">${name}</option>`);
    }
    // 治療師 (C欄)
    const therapistSelect = document.getElementById('inputTherapist');
    if(therapistSelect) {
      therapistSelect.innerHTML = '<option value="" disabled selected>請選擇治療師</option>';
      staff.therapists.forEach(name => therapistSelect.innerHTML += `<option value="${name}">${name}</option>`);
    }
  }).getSystemStaff();
}

// 導覽切換
function navTo(viewName) {
  if (!currentClient && viewName !== 'search') { alert("請先選取個案。"); return; }
  const views = ['search', 'basic', 'images', 'treatment', 'maintenance', 'doctor', 'tracking', 'overview'];
  views.forEach(v => {
    document.getElementById('view-' + v)?.classList.add('hidden');
    document.getElementById('btn-' + v)?.classList.remove('active');
  });
  document.getElementById('view-' + viewName)?.classList.remove('hidden');
  document.getElementById('btn-' + viewName)?.classList.add('active');

  if(viewName === 'doctor') loadDoctorHistory();
  if(viewName === 'treatment') loadTreatmentHistory();
}

// 載入歷史看診
function loadDoctorHistory() {
  const container = document.getElementById('doctorHistoryList');
  container.innerHTML = '<div class="py-10 flex justify-center"><div class="loader"></div></div>';
  google.script.run.withSuccessHandler(logs => {
    if (!logs || logs.length === 0) {
      container.innerHTML = '<div class="bg-gray-50 border-2 border-dashed border-gray-100 rounded-2xl py-12 text-center text-gray-400 text-sm">尚無歷史紀錄</div>';
      return;
    }
    let html = '';
    logs.forEach(log => {
      html += `
        <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
          <div class="flex justify-between items-center mb-4">
            <span class="text-xs font-bold bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full border border-emerald-100">${log['日期']}</span>
            <span class="text-sm font-bold text-gray-700">醫師: ${log['看診醫師']} | 護理: ${log['護理師']}</span>
          </div>
          <div class="grid grid-cols-2 gap-3 text-xs">
            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-400 mb-1">主訴 (S)</p>${log['主訴']||'--'}</div>
            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-400 mb-1">檢查 (O)</p>${log['客觀檢查']||'--'}</div>
          </div>
        </div>`;
    });
    container.innerHTML = html;
  }).getClientHistory(currentClient['個案編號'], 'Doctor_Consultation');
}

// 通用提交
function submitForm(type) {
  const config = {
    'doctor': { id: 'doctorForm', sheet: 'Doctor_Consultation', callback: loadDoctorHistory },
    'treatment': { id: 'treatmentForm', sheet: 'Treatment_Logs', callback: loadTreatmentHistory }
  };
  const settings = config[type];
  const form = document.getElementById(settings.id);
  const formData = new FormData(form);
  const data = {};
  formData.forEach((v, k) => data[k] = v);

  google.script.run.withSuccessHandler(res => {
    alert(res.message);
    form.reset();
    document.querySelectorAll('.auto-fill-id').forEach(i => i.value = currentClient['個案編號']);
    settings.callback();
  }).saveData(settings.sheet, data);
}
</script>