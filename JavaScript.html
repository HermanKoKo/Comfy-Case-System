<script>
let currentClient = null;

window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
  loadSystemStaff();
};

function loadSystemStaff() {
  google.script.run.withSuccessHandler(staff => {
    // 醫師 (A欄)
    const docSelect = document.getElementById('selectDoctor');
    if(docSelect) {
      docSelect.innerHTML = '<option value="" disabled selected>請選擇醫師</option>';
      staff.doctors.forEach(name => docSelect.innerHTML += `<option value="${name}">${name}</option>`);
    }
    // 護理師 (B欄)
    const nurseSelect = document.getElementById('selectNurse');
    if(nurseSelect) {
      nurseSelect.innerHTML = '<option value="" disabled selected>請選擇護理師</option>';
      staff.nurses.forEach(name => nurseSelect.innerHTML += `<option value="${name}">${name}</option>`);
    }
  }).getSystemStaff();
}

function navTo(viewName) {
  if (!currentClient && viewName !== 'search') { alert("請先選取個案。"); return; }
  const views = ['search', 'basic', 'treatment', 'doctor'];
  views.forEach(v => {
    const el = document.getElementById('view-' + v);
    if(el) el.classList.add('hidden');
    const btn = document.getElementById('btn-' + v);
    if(btn) btn.classList.remove('bg-emerald-500', 'text-white');
  });
  
  const targetView = document.getElementById('view-' + viewName);
  if(targetView) targetView.classList.remove('hidden');
  const targetBtn = document.getElementById('btn-' + viewName);
  if(targetBtn) targetBtn.classList.add('bg-emerald-500', 'text-white');

  if(viewName === 'doctor') loadDoctorHistory();
}

function handleSearch() {
  const keyword = document.getElementById('searchInput').value.trim();
  if (!keyword) return;
  const container = document.getElementById('searchResults');
  container.innerHTML = '<div class="text-center py-10 text-gray-400">搜尋中...</div>';
  google.script.run.withSuccessHandler(data => {
    container.innerHTML = '';
    if(data.length === 0) { container.innerHTML = '<div class="text-center py-10">查無資料</div>'; return; }
    data.forEach(client => {
      const div = document.createElement('div');
      div.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 hover:border-emerald-500 cursor-pointer transition";
      div.onclick = () => selectClient(client);
      div.innerHTML = `<div class="font-bold">${client['姓名']} (${client['個案編號']})</div><div class="text-sm text-gray-500">${client['電話']}</div>`;
      container.appendChild(div);
    });
  }).searchClient(keyword);
}

function selectClient(client) {
  currentClient = client;
  document.getElementById('topBarClientInfo').classList.remove('hidden');
  document.getElementById('headerClientName').textContent = client['姓名'];
  document.getElementById('headerClientDob').textContent = client['生日'];
  document.querySelectorAll('.auto-fill-id').forEach(el => el.value = client['個案編號']);
  navTo('doctor');
}

function loadDoctorHistory() {
  const container = document.getElementById('doctorHistoryList');
  container.innerHTML = '<div class="text-center py-10">讀取紀錄中...</div>';
  google.script.run.withSuccessHandler(logs => {
    if(!logs || logs.length === 0) { container.innerHTML = '<div class="text-center py-10 text-gray-400">尚無紀錄</div>'; return; }
    let html = '';
    logs.forEach(log => {
      html += `
        <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
          <div class="flex justify-between items-center mb-3">
            <span class="text-xs font-bold bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full">${log['日期']}</span>
            <span class="text-sm font-bold text-gray-700">醫師: ${log['看診醫師']} | 護理: ${log['護理師']}</span>
          </div>
          <div class="grid grid-cols-2 gap-4 text-xs">
            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-400 mb-1 font-bold">主訴 (S)</p>${log['主訴']||'--'}</div>
            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-400 mb-1 font-bold">診斷 (A)</p>${log['診斷']||'--'}</div>
          </div>
        </div>`;
    });
    container.innerHTML = html;
  }).getClientHistory(currentClient['個案編號'], 'Doctor_Consultation');
}

function submitForm(type) {
  const formMap = { 'doctor': { id: 'doctorForm', sheet: 'Doctor_Consultation', cb: loadDoctorHistory } };
  const target = formMap[type];
  const form = document.getElementById(target.id);
  const data = {};
  new FormData(form).forEach((v, k) => data[k] = v);

  google.script.run.withSuccessHandler(res => {
    alert(res.message);
    form.reset();
    document.querySelectorAll('.auto-fill-id').forEach(el => el.value = currentClient['個案編號']);
    target.cb();
  }).saveData(target.sheet, data);
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
</script>