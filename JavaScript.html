<script>
let currentClient = null;
let lastSearchResults = [];
let allTreatmentLogs = []; 
let filterState = { date: null, therapist: null }; 

window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('input[type="date"]').forEach(el => {
    if(!el.value) el.value = today;
  });
  updateNavState();
  loadTherapistOptions(); 
  renderCalendar();
};

function autoDetectGender(input) {
  const idValue = input.value.trim();
  const genderInput = document.getElementById('genderInput');
  if (idValue.length >= 2) {
    const secondChar = idValue.charAt(1);
    genderInput.value = secondChar === '1' ? 'ç”·' : (secondChar === '2' ? 'å¥³' : '');
  } else {
    genderInput.value = '';
  }
}

// è¼‰å…¥æ²»ç™‚å¸«åå–® (ä¿®æ­£ï¼šå®Œå…¨ç§»é™¤ã€Œå…¶ä»–ã€)
function loadTherapistOptions() {
  const inputSel = document.getElementById('inputTherapist');
  const filterSel = document.getElementById('filterTherapist');
  
  if(!inputSel || !filterSel) return;

  // è¼‰å…¥ä¸­ç‹€æ…‹
  inputSel.innerHTML = '<option value="" disabled selected>è¼‰å…¥ä¸­...</option>';
  filterSel.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';

  google.script.run.withSuccessHandler(list => {
     inputSel.innerHTML = '';
     filterSel.innerHTML = '';

     // è¡¨å–®é¸å–®ï¼šé è¨­é¡¯ç¤ºã€Œè«‹é¸æ“‡æ²»ç™‚å¸«ã€
     const defaultInputOpt = document.createElement('option');
     defaultInputOpt.value = "";
     defaultInputOpt.textContent = "è«‹é¸æ“‡æ²»ç™‚å¸«";
     defaultInputOpt.disabled = true;
     defaultInputOpt.selected = true;
     inputSel.appendChild(defaultInputOpt);

     // ç¯©é¸é¸å–®ï¼šé è¨­é¡¯ç¤ºã€Œæ‰€æœ‰åŸ·è¡Œäººå“¡ã€
     const defaultFilterOpt = document.createElement('option');
     defaultFilterOpt.value = "";
     defaultFilterOpt.textContent = "æ‰€æœ‰åŸ·è¡Œäººå“¡";
     filterSel.appendChild(defaultFilterOpt);
     
     // å¡«å…¥åå–®
     list.forEach(name => {
         // è¡¨å–®
         const opt1 = document.createElement('option');
         opt1.value = name;
         opt1.textContent = name;
         inputSel.appendChild(opt1);

         // ç¯©é¸
         const opt2 = document.createElement('option');
         opt2.value = name;
         opt2.textContent = name;
         filterSel.appendChild(opt2);
     });
  }).getSystemTherapists();
}

// è¼‰å…¥å€‹æ¡ˆæ­·å²ç´€éŒ„
function loadTreatmentHistory() {
  if (!currentClient) return;
  const container = document.getElementById('historyListContainer');
  container.innerHTML = '<div class="flex justify-center py-8"><div class="loader"></div></div>';
  
  allTreatmentLogs = [];
  
  google.script.run
    .withSuccessHandler(logs => {
       allTreatmentLogs = logs;
       applyLogFilters(); 
    })
    .withFailureHandler(error => {
       container.innerHTML = `<p class="text-center text-red-400 py-8">è¼‰å…¥å¤±æ•—ï¼š${error}</p>`;
       console.error(error);
    })
    .getClientHistory(currentClient['å€‹æ¡ˆç·¨è™Ÿ']);
}

// Calendar Logic
let currentCalendarDate = new Date();
function renderCalendar() {
  const container = document.getElementById('customCalendar');
  if(!container) return;
  
  const year = currentCalendarDate.getFullYear();
  const month = currentCalendarDate.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  let html = `<div class="flex justify-between items-center mb-4 text-sm font-bold text-gray-700"><button onclick="changeMonth(-1)" class="p-1 hover:bg-gray-100 rounded">&lt;</button><span>${year}å¹´ ${month + 1}æœˆ</span><button onclick="changeMonth(1)" class="p-1 hover:bg-gray-100 rounded">&gt;</button></div><div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 mb-2"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span></div><div class="grid grid-cols-7 gap-1">`;
  for(let i=0; i<firstDay; i++) html += `<div class="calendar-day empty"></div>`;
  const todayStr = new Date().toISOString().split('T')[0];
  const selectedStr = filterState.date;
  for(let d=1; d<=daysInMonth; d++) {
     const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
     let classes = "calendar-day";
     if (dateStr === todayStr) classes += " today";
     if (dateStr === selectedStr) classes += " selected";
     html += `<div class="${classes}" onclick="selectCalendarDate('${dateStr}')">${d}</div>`;
  }
  html += `</div>`;
  container.innerHTML = html;
}
function changeMonth(delta) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta); renderCalendar(); }
function selectCalendarDate(dateStr) {
  filterState.date = (filterState.date === dateStr) ? null : dateStr;
  document.getElementById('filterDate').value = filterState.date || '';
  renderCalendar();
  applyLogFilters();
}
function resetFilters() {
  filterState = { date: null, therapist: null };
  document.getElementById('filterDate').value = '';
  document.getElementById('filterTherapist').value = '';
  renderCalendar();
  applyLogFilters();
}
function applyLogFilters() {
  const domDate = document.getElementById('filterDate').value;
  const domTherapist = document.getElementById('filterTherapist').value;
  if (domDate) filterState.date = domDate;
  filterState.therapist = domTherapist;
  
  const filtered = allTreatmentLogs.filter(log => {
     let matchDate = true;
     let matchTherapist = true;
     if (filterState.date) matchDate = log['æ²»ç™‚æ—¥æœŸ'] === filterState.date;
     if (filterState.therapist) matchTherapist = log['åŸ·è¡Œæ²»ç™‚å¸«'] === filterState.therapist;
     return matchDate && matchTherapist;
  });
  renderHistoryList(filtered);
}

function renderHistoryList(logs) {
  const container = document.getElementById('historyListContainer');
  document.getElementById('historyCount').textContent = logs.length;
  container.innerHTML = '';
  
  if (logs.length === 0) { 
    if(allTreatmentLogs.length === 0) {
        container.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-gray-400"><p class="text-sm">å°šç„¡ç´€éŒ„</p></div>`;
    } else {
        container.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-gray-400"><p class="text-sm">è©²æ—¥æœŸç¯„åœå…§æ²’æœ‰æ²»ç™‚ç´€éŒ„</p></div>`;
    }
    return; 
  }

  // ä½¿ç”¨ window å…¨åŸŸè®Šæ•¸æš«å­˜ï¼Œä¾›ç·¨è¼¯åŠŸèƒ½ä½¿ç”¨
  window.currentRenderedLogs = logs;

  logs.forEach((log, index) => {
     const div = document.createElement('div');
     div.className = "bg-white border border-gray-100 rounded-lg p-4 hover:shadow-md transition group relative mb-3";
     div.innerHTML = `
       <div class="flex justify-between items-start mb-2">
         <div class="flex items-center gap-3">
            <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded font-medium border border-gray-200">${log['æ²»ç™‚æ—¥æœŸ']}</span>
            <span class="text-sm font-bold text-emerald-600">${log['åŸ·è¡Œæ²»ç™‚å¸«'] || 'æœªç´€éŒ„'}</span>
         </div>
         <button onclick="editLogFromRendered(${index})" class="text-gray-300 hover:text-emerald-600 transition p-1" title="ç·¨è¼¯æ­¤ç´€éŒ„">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
         </button>
       </div>
       <div class="pl-1">
         ${log['ç•¶æ—¥ä¸»è¨´'] ? `<p class="text-xs text-gray-500 mb-1 line-clamp-1"><span class="font-bold mr-1">ä¸»è¨´:</span>${log['ç•¶æ—¥ä¸»è¨´']}</p>` : ''}
         <p class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed mt-2">${log['æ²»ç™‚å…§å®¹'] || '<span class="text-gray-300 italic">ç„¡å…§å®¹</span>'}</p>
       </div>
     `;
     container.appendChild(div);
  });
}

function editLogFromRendered(index) {
  const log = window.currentRenderedLogs[index];
  if(log) editLog(log);
}

function editLog(log) {
  document.getElementById('logId').value = log['ç´€éŒ„ID'];
  document.getElementById('inputDate').value = log['æ²»ç™‚æ—¥æœŸ'];
  
  // æª¢æŸ¥é¸å–®
  const sel = document.getElementById('inputTherapist');
  const exists = [...sel.options].some(o => o.value === log['åŸ·è¡Œæ²»ç™‚å¸«']);
  if (!exists && log['åŸ·è¡Œæ²»ç™‚å¸«']) {
      const opt = document.createElement('option');
      opt.value = log['åŸ·è¡Œæ²»ç™‚å¸«'];
      opt.textContent = log['åŸ·è¡Œæ²»ç™‚å¸«'] + " (æ­·å²)";
      sel.appendChild(opt);
  }
  sel.value = log['åŸ·è¡Œæ²»ç™‚å¸«'];

  document.getElementById('inputComplaint').value = log['ç•¶æ—¥ä¸»è¨´'] || '';
  document.getElementById('inputContent').value = log['æ²»ç™‚å…§å®¹'] || '';
  document.getElementById('inputNote').value = log['å‚™è¨»/ä¸‹æ¬¡æ²»ç™‚'] || '';
  
  const title = document.getElementById('formTitle');
  title.textContent = 'ç·¨è¼¯ç´€éŒ„';
  title.className = "text-lg font-bold text-emerald-600";
  
  document.getElementById('treatmentForm').scrollIntoView({ behavior: 'smooth' });
}

function resetTreatmentForm() {
  document.getElementById('treatmentForm').reset();
  document.getElementById('logId').value = '';
  const title = document.getElementById('formTitle');
  title.textContent = 'æ–°å¢ç´€éŒ„';
  title.className = "text-lg font-bold text-gray-700";
  document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('inputTherapist').selectedIndex = 0;
  if(currentClient) document.querySelectorAll('.auto-fill-id').forEach(i => i.value = currentClient['å€‹æ¡ˆç·¨è™Ÿ']);
}

// Nav
function navTo(viewName) {
  if (!currentClient && viewName !== 'search') { alert("è«‹å…ˆæœå°‹ä¸¦é¸å–å€‹æ¡ˆã€‚"); navTo('search'); return; }
  ['search', 'basic', 'images', 'treatment', 'maintenance', 'doctor', 'tracking', 'overview'].forEach(v => {
    document.getElementById('view-' + v).classList.add('hidden');
    document.getElementById('btn-' + v)?.classList.remove('active');
  });
  document.getElementById('view-' + viewName).classList.remove('hidden');
  document.getElementById('btn-' + viewName)?.classList.add('active');
  const titleMap = { 'search': 'æœå°‹å€‹æ¡ˆ', 'basic': 'åŸºæœ¬è³‡æ–™', 'images': 'å½±åƒç¸½è¦½', 'treatment': 'æ²»ç™‚ç´€éŒ„', 'maintenance': 'ä¿é¤Šé …ç›®', 'doctor': 'é†«å¸«çœ‹è¨º', 'tracking': 'å€‹ç®¡è¿½è¹¤', 'overview': 'å€‹æ¡ˆç¸½è¦½' };
  document.getElementById('pageTitle').textContent = titleMap[viewName] || 'åº·é£›é‹é†«';
  if(viewName === 'images') loadClientImages();
  if(viewName === 'treatment') { 
      loadTreatmentHistory(); 
      resetTreatmentForm(); 
  }
}

function selectClient(client) {
  currentClient = client;
  updateNavState();
  renderBasicInfoView(client);
  document.querySelectorAll('.auto-fill-id').forEach(input => input.value = client['å€‹æ¡ˆç·¨è™Ÿ']);
  navTo('treatment');
}

function updateNavState() {
  const infoBar = document.getElementById('topBarClientInfo');
  if (currentClient) {
    infoBar.classList.remove('hidden');
    document.getElementById('headerClientName').textContent = currentClient['å§“å'];
    document.getElementById('headerClientDob').textContent = currentClient['ç”Ÿæ—¥'] || 'ç„¡ç”Ÿæ—¥';
  } else {
    infoBar.classList.add('hidden');
  }
}

function resetSearch() {
  currentClient = null;
  updateNavState();
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').innerHTML = '';
  navTo('search');
}

function handleSearch() {
  const keyword = document.getElementById('searchInput').value.trim();
  if (!keyword) return;
  const container = document.getElementById('searchResults');
  container.innerHTML = '<div class="text-center py-10"><div class="loader mx-auto"></div><p class="text-gray-400 mt-4">æœå°‹è³‡æ–™åº«ä¸­...</p></div>';
  google.script.run.withSuccessHandler(renderSearchResults).searchClient(keyword);
}

function renderSearchResults(data) {
  const container = document.getElementById('searchResults');
  container.innerHTML = '';
  if (data.length === 0) { container.innerHTML = '<div class="text-center py-10 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">æŸ¥ç„¡æ­¤äºº</div>'; return; }
  data.forEach(client => {
    const div = document.createElement('div');
    div.className = "bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:border-emerald-400 cursor-pointer transition flex justify-between items-center group";
    div.onclick = () => selectClient(client);
    div.innerHTML = `<div class="flex items-center gap-4"><div class="h-10 w-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center font-bold text-lg">${client['å§“å'][0]}</div><div><div class="flex items-center gap-2"><span class="font-bold text-gray-800 text-lg">${client['å§“å']}</span><span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200">${client['æ€§åˆ¥'] || 'æœªå¡«'}</span></div><div class="text-sm text-gray-500 mt-0.5 flex gap-3"><span>ID: ${client['å€‹æ¡ˆç·¨è™Ÿ']}</span><span>ğŸ“ ${client['é›»è©±']}</span></div></div></div><div class="text-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>`;
    container.appendChild(div);
  });
}

function renderBasicInfoView(client) {
  const container = document.getElementById('basicInfoContent');
  const fields = [{label:'å§“å',key:'å§“å'},{label:'å€‹æ¡ˆç·¨è™Ÿ',key:'å€‹æ¡ˆç·¨è™Ÿ'},{label:'é›»è©±',key:'é›»è©±'},{label:'ç”Ÿæ—¥',key:'ç”Ÿæ—¥'},{label:'èº«åˆ†è­‰å­—è™Ÿ',key:'èº«åˆ†è­‰å­—è™Ÿ'},{label:'æ€§åˆ¥',key:'æ€§åˆ¥'},{label:'ç‰¹æ®Šç–¾ç—…',key:'æ…¢æ€§ç—…æˆ–ç‰¹æ®Šç–¾ç—…'},{label:'å»ºç«‹æ—¥æœŸ',key:'å»ºç«‹æ—¥æœŸ'}];
  let html = '';
  fields.forEach(f => { html += `<div class="p-4 bg-gray-50 rounded-lg border border-gray-100"><p class="text-xs text-gray-400 mb-1">${f.label}</p><p class="font-medium text-gray-800 break-words">${client[f.key]||'--'}</p></div>`; });
  if(client['GoogleDriveè³‡æ–™å¤¾é€£çµ']) html += `<div class="col-span-2 p-4 bg-blue-50 rounded-lg border border-blue-100 flex items-center justify-between"><div><p class="text-xs text-blue-400 mb-1">é›²ç«¯è³‡æ–™å¤¾</p><p class="text-sm text-blue-800">å·²é€£çµè‡³ Google Drive</p></div><a href="${client['GoogleDriveè³‡æ–™å¤¾é€£çµ']}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition">é–‹å•Ÿè³‡æ–™å¤¾</a></div>`;
  container.innerHTML = html;
}

function loadClientImages(){
  const container = document.getElementById('imageGalleryContainer');
  if(!currentClient||!currentClient['GoogleDriveè³‡æ–™å¤¾é€£çµ']){ container.innerHTML='<p class="col-span-full text-center text-gray-400 py-10">ç„¡è³‡æ–™å¤¾é€£çµ</p>'; return; }
  container.innerHTML='<div class="col-span-full text-center py-10"><div class="loader mx-auto"></div></div>';
  google.script.run.withSuccessHandler(imgs => {
    container.innerHTML='';
    if(!imgs.length){ container.innerHTML='<p class="col-span-full text-center text-gray-400 py-10">å°šç„¡å½±åƒ</p>'; return; }
    imgs.forEach(img => {
       const div = document.createElement('div');
       div.className="group relative aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-200 cursor-pointer";
       div.onclick=()=>window.open(img.url,'_blank');
       div.innerHTML=`<img src="${img.thumbnail}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500"><div class="absolute bottom-0 left-0 right-0 bg-black/60 p-2 opacity-0 group-hover:opacity-100 transition"><p class="text-white text-[10px] truncate">${new Date(img.created).toLocaleDateString()}</p></div>`;
       container.appendChild(div);
    });
  }).getCaseImages(currentClient['GoogleDriveè³‡æ–™å¤¾é€£çµ']);
}

function triggerImageUpload(){
   const input = document.getElementById('caseImageInput');
   const btn = document.getElementById('uploadBtnText');
   if(input.files.length===0) return alert("è«‹é¸æ“‡æª”æ¡ˆ");
   btn.textContent='...';
   const file = input.files[0];
   const reader = new FileReader();
   reader.onload=e=>{
     google.script.run.withSuccessHandler(res=>{
        btn.textContent='ä¸Šå‚³';
        if(res.success){ alert("æˆåŠŸ"); loadClientImages(); } else alert("å¤±æ•—: "+res.message);
     }).uploadCaseImage(e.target.result.split(',')[1], file.type, file.name, currentClient['GoogleDriveè³‡æ–™å¤¾é€£çµ']);
   };
   reader.readAsDataURL(file);
}

function submitForm(type) {
  if (!currentClient) return alert("æœªé¸å–å€‹æ¡ˆ");
  const config = { 'treatment': {id:'treatmentForm', func:'saveData', sheet:'Treatment_Logs'}, 'doctor': {id:'doctorForm', func:'saveDoctorConsultation'}, 'tracking': {id:'trackingForm', func:'saveCaseTracking'} };
  const setting = config[type];
  const form = document.getElementById(setting.id);
  if(!form.checkValidity()){ form.reportValidity(); return; }
  const formData = new FormData(form);
  const data = {};
  formData.forEach((v,k)=>data[k]=v);
  if(type==='treatment') google.script.run.withSuccessHandler(onSubmitSuccess).saveData(setting.sheet, data);
  else google.script.run.withSuccessHandler(onSubmitSuccess)[setting.func](data);
  function onSubmitSuccess(res) {
    alert(res.message || "å„²å­˜æˆåŠŸï¼");
    form.reset();
    document.querySelectorAll('.auto-fill-id').forEach(i=>i.value=currentClient['å€‹æ¡ˆç·¨è™Ÿ']);
    if(type==='treatment') { loadTreatmentHistory(); resetTreatmentForm(); }
  }
}

function submitNewClient(){
  const form=document.getElementById('addClientForm');
  if(!form.checkValidity()){ form.reportValidity(); return; }
  const data={}; new FormData(form).forEach((v,k)=>data[k]=v);
  if(!data['å€‹æ¡ˆç·¨è™Ÿ']) data['å€‹æ¡ˆç·¨è™Ÿ']='CF'+new Date().toISOString().slice(2,8).replace(/-/g,'')+Math.floor(Math.random()*1000).toString().padStart(3,'0');
  google.script.run.withSuccessHandler(()=>{ alert("å»ºç«‹æˆåŠŸ"); closeModal('addClientModal'); form.reset(); }).saveData('Client_Basic_Info', data);
}

function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
</script>