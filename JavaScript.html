<script>
// ==========================================
// å…¨åŸŸè®Šæ•¸å®£å‘Š
// ==========================================
let currentClient = null;
let allTreatmentLogs = [];
let allOverviewRecords = [];
let currentOverviewCategory = 'all';
let filesToUpload = [];
let searchTimer = null;
let allCalendarEvents = [];
let isEditingClient = false;

// â˜…â˜…â˜… å„ªåŒ–ï¼šæ–°å¢ Map å¿«å–ï¼Œç”¨æ–¼å­˜å„²æœå°‹çµæœç‰©ä»¶ï¼Œé¿å…åœ¨ HTML ä¸­å‚³ééå¤šè³‡æ–™ â˜…â˜…â˜…
let searchResultCache = new Map(); 

// ==========================================
// æ ¼å¼åŒ–è¼”åŠ©å‡½å¼ (å‡ç´šç‰ˆ)
// ==========================================

// é€šç”¨æ—¥æœŸæ ¼å¼åŒ–ï¼šæ”¯æ´ YYYYMMDD, Date ç‰©ä»¶, ISO å­—ä¸² -> YYYY-MM-DD
function formatYmd(val) {
  if (!val) return '';
  // å¦‚æœæ˜¯ Google Sheets å›å‚³çš„ Date ç‰©ä»¶æˆ– ISO å­—ä¸²
  if (val instanceof Date) return val.toISOString().split('T')[0];
  let str = String(val).trim();
  if (str.includes('T')) return str.split('T')[0]; // è™•ç† ISO å­—ä¸²
  
  // è™•ç†èˆŠæ ¼å¼ YYYYMMDD
  if (/^\d{8}$/.test(str)) {
    return str.substring(0, 4) + '-' + str.substring(4, 6) + '-' + str.substring(6, 8);
  }
  return str;
}

// 09xxxxxxxx -> 09xx-xxx-xxx
function formatPhone(str) {
  if (!str) return '';
  str = String(str).trim();
  const cleanNum = str.replace(/\D/g, '');
  if (cleanNum.length === 10 && cleanNum.startsWith('09')) {
      return cleanNum.replace(/(\d{4})(\d{3})(\d{3})/, '$1-$2-$3');
  }
  return str;
}

// ==========================================
// åˆå§‹åŒ–èˆ‡ UI è¨­å®š
// ==========================================

function setupEnhancedFlatpickr(selector, options = {}) {
  const defaults = {
    locale: "zh_tw",
    dateFormat: "Y-m-d",
    disableMobile: true,
    allowInput: true,
    static: false,
    position: "auto center",
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      if (!dayElem || !dayElem.dateObj) return;
      const dateKey = dayElem.dateObj.toISOString().split('T')[0];
      // é€™è£¡ä½¿ç”¨å…¨åŸŸ allCalendarEvents ä¾†æ¨™è¨˜æ—¥æœŸé»
      const dayEvents = allCalendarEvents.filter(e => e.date === dateKey);

      if (dayEvents.length > 0) {
        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'dots-container';
        const categories = [...new Set(dayEvents.map(e => e.category))];

        categories.forEach(cat => {
          const dot = document.createElement('div');
          dot.className = 'cal-dot';
          if (cat === 'treatment') dot.classList.add('dot-treatment');
          else if (cat === 'maintenance') dot.classList.add('dot-maintenance');
          else if (cat === 'doctor') dot.classList.add('dot-doctor');
          else if (cat === 'tracking') dot.classList.add('dot-tracking');
          dotsContainer.appendChild(dot);
        });
        dayElem.appendChild(dotsContainer);
      }
    }
  };
  return flatpickr(selector, { ...defaults, ...options });
}

window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('#treatmentDate, #maintenanceDate, #doctorConsultDate, #trackDate').forEach(el => el.value = today);
  
  // åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨
  setupEnhancedFlatpickr('input[type="date"], #trackDate');

  // è¨­å®šå€‹æ¡ˆç¸½è¦½çš„æ—¥æœŸç¯©é¸ç›£è½ (ä¿®å¾©å•é¡ŒäºŒçš„é—œéµå…¥å£)
  const overviewConfig = { onChange: function() { renderOverviewList(); } };
  setupEnhancedFlatpickr('#overviewStartDate', overviewConfig);
  setupEnhancedFlatpickr('#overviewEndDate', overviewConfig);

  // åˆå§‹åŒ–å€‹æ¡ˆè³‡æ–™åº« (é è¼‰)
  initClientDatabase(); 
  initDropZone();
  
  // â˜… [ä¿®å¾©å•é¡Œä¸€] çµ±ä¸€è¼‰å…¥æ‰€æœ‰ä¸‹æ‹‰é¸å–® (æ²»ç™‚å¸«ã€é†«å¸«ã€é …ç›®ç­‰)
  // ç§»é™¤èˆŠçš„ loadTreatmentItems å’Œ loadTherapistOptionsï¼Œæ”¹ç”¨é€™å€‹çµ±ä¸€ç®¡ç†
  loadSystemStaff();      
};

/**
 * â˜…â˜…â˜… [å·²ä¿®å¾©] çµ±ä¸€è¼‰å…¥ç³»çµ±ä¸‹æ‹‰é¸å–® (åŒ…å«æ²»ç™‚å¸«ã€é†«å¸«ã€é …ç›®ç­‰) â˜…â˜…â˜…
 * å°æ‡‰å•é¡Œä¸€ï¼šè‡ªå‹•æŠ“å– System é é¢æ›´æ–°
 */
function loadSystemStaff() {
  const CACHE_KEY = 'SYSTEM_STAFF_CACHE_V2';
  
  // 1. å„ªå…ˆå˜—è©¦å¾ LocalStorage è®€å– (æå‡é«”é©—)
  const cached = localStorage.getItem(CACHE_KEY);
  if (cached) {
    try {
      renderStaffOptions(JSON.parse(cached));
    } catch (e) { console.error('Cache parse error', e); }
  }

  // 2. å‘¼å«å¾Œç«¯å–å¾—æœ€æ–° Sheet è³‡æ–™
  google.script.run.withSuccessHandler(staff => {
    // å„²å­˜åˆ° LocalStorage
    localStorage.setItem(CACHE_KEY, JSON.stringify(staff));
    // é‡æ–°æ¸²æŸ“ä»‹é¢
    renderStaffOptions(staff);
  }).getSystemStaff();
}

/**
 * åˆå§‹åŒ–æ‹–æ›³ä¸Šå‚³å€åŸŸ (v2.0 Optimized)
 * è«‹åœ¨ window.onload æˆ–é–‹å•Ÿ Modal æ™‚å‘¼å«æ­¤å‡½å¼
 */
function initDropZone() {
  const dropZone = document.getElementById('uploadDropZone');
  const fileInput = document.getElementById('uploadInput');

  if (!dropZone || !fileInput) return;

  // 1. é˜»æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º (é¿å…ç€è¦½å™¨ç›´æ¥æ‰“é–‹åœ–ç‰‡)
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // 2. è¦–è¦ºå›é¥‹ï¼šæ‹–æ›³é€²ä¾†æ™‚æ”¹è®Šæ¨£å¼
  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.add('border-emerald-500', 'bg-emerald-50', 'scale-[1.02]');
    }, false);
  });

  // 3. è¦–è¦ºå›é¥‹ï¼šæ‹–æ›³é›¢é–‹æ™‚é‚„åŸæ¨£å¼
  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.remove('border-emerald-500', 'bg-emerald-50', 'scale-[1.02]');
    }, false);
  });

  // 4. æ ¸å¿ƒé‚è¼¯ï¼šè™•ç†ã€Œæ”¾ä¸‹ (Drop)ã€äº‹ä»¶
  dropZone.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files && files.length > 0) {
      // é—œéµé­”æ³•ï¼šå°‡æ‹–æ›³çš„æª”æ¡ˆã€Œå¡ã€é€² input æ¨™ç±¤ä¸­
      // é€™æ¨£åŸæœ¬çš„ã€Œé–‹å§‹ä¸Šå‚³ã€æŒ‰éˆ•é‚è¼¯å®Œå…¨ä¸ç”¨æ”¹ï¼Œå› ç‚ºå®ƒåªèª input çš„å…§å®¹
      fileInput.files = files;
      
      // æ‰‹å‹•è§¸ç™¼ onchange äº‹ä»¶ä»¥æ›´æ–° UI
      handleFileSelect(fileInput);
    }
  }, false);
}

/**
 * è™•ç†æª”æ¡ˆé¸æ“‡å¾Œçš„ UI æ›´æ–° (v2.2 Logic Fix)
 * Fix: åŒæ­¥æ›´æ–° filesToUpload å…¨åŸŸè®Šæ•¸ï¼Œä¿®å¾© startUpload è®€ä¸åˆ°æª”æ¡ˆçš„å•é¡Œ
 */
function handleFileSelect(input) {
  const textZone = document.getElementById('dropZoneText');
  const previewZone = document.getElementById('filePreviewText');
  
  if (input.files && input.files.length > 0) {
    
    // ğŸ”¥ é—œéµä¿®æ­£ï¼šå°‡ DOM çš„æª”æ¡ˆåˆ—è¡¨è½‰å­˜åˆ°å…¨åŸŸè®Šæ•¸ filesToUpload
    // é€™æ¨£ startUpload() æ‰èƒ½è®€å–åˆ°æª”æ¡ˆ
    filesToUpload = Array.from(input.files); 

    // 1. éš±è—åŸæœ¬çš„ã€Œé»æ“Šæˆ–æ‹–æ›³ã€æç¤ºæ–‡å­—
    if(textZone) textZone.classList.add('hidden');

    if(previewZone) {
      // 2. é¡¯ç¤ºé è¦½å€åŸŸ
      previewZone.classList.remove('hidden');

      // 3. æ¨£å¼é‡æ§‹ (ç§»é™¤å–®ä¸€è† å›Šæ¨£å¼ï¼Œæ”¹ç‚ºåˆ—è¡¨)
      previewZone.classList.remove('bg-emerald-100', 'rounded-full', 'px-3', 'py-1', 'text-emerald-600');
      
      // ç§»é™¤èˆŠçš„é™åˆ¶é«˜åº¦è¨­å®š (è§£æ±ºé¡¯ç¤ºä¸å…¨çš„å•é¡Œ)
      previewZone.classList.add('w-full', 'flex', 'flex-col', 'gap-2', 'px-8', 'custom-scrollbar');

      // 4. ç”Ÿæˆ HTML
      const html = filesToUpload.map(file => `
        <div class="flex items-center justify-center gap-2 bg-emerald-100 text-emerald-600 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm animate-fade-in transition-all hover:bg-emerald-200">
           <span class="material-icons-outlined text-sm">description</span>
           <span class="truncate max-w-[200px]">${file.name}</span>
        </div>
      `).join('');

      previewZone.innerHTML = html;
    }
  }
}

// è‡ªå‹•å•Ÿå‹•ç›£è½ (ç¢ºä¿å…ƒç´ å­˜åœ¨å¾ŒåŸ·è¡Œ)
// æ‚¨åŸæœ¬çš„ window.onload ä¸­å¯ä»¥åŠ å…¥é€™ä¸€è¡Œï¼Œæˆ–è€…ç›´æ¥æ”¾åœ¨ script å°¾ç«¯åŸ·è¡Œï¼š
setTimeout(initDropZone, 1000); // å»¶é² 1 ç§’ç¢ºä¿ DOM è¼‰å…¥å®Œæˆ

/**
 * æ¸²æŸ“æ‰€æœ‰ä¸‹æ‹‰é¸å–®
 */
function renderStaffOptions(staff) {
    if (!staff) return;

    // é€šç”¨å¡«å…¥å‡½å¼
    const setOptions = (ids, list, placeholder) => {
      // æ”¯æ´å‚³å…¥å–®ä¸€ ID æˆ– ID é™£åˆ—
      const targets = Array.isArray(ids) ? ids : [ids];
      
      targets.forEach(id => {
        const el = document.getElementById(id);
        if(el) { 
           const currentVal = el.value; // æš«å­˜ä½¿ç”¨è€…ç•¶å‰é¸çš„å€¼ (è‹¥æœ‰)
           
           // å»ºç«‹é¸é … HTML
           let html = `<option value="" disabled ${!currentVal ? 'selected' : ''}>${placeholder}</option>`;
           if (list && list.length > 0) {
               html += list.map(n => `<option value="${n}">${n}</option>`).join('');
           }
           
           el.innerHTML = html; 
           
           // å˜—è©¦æ¢å¾©é¸å€¼ (å¦‚æœåŸæœ¬é¸çš„å€¼é‚„åœ¨æ–°æ¸…å–®å…§)
           if(currentVal && list.includes(currentVal)) {
               el.value = currentVal;
           } else if (id === 'selectDoctor' && list.includes('è¬ç‚³è³¢')) {
               el.value = "è¬ç‚³è³¢"; // ç‰¹æ®Šé è¨­å€¼é‚è¼¯
           }
        }
      });
    };
    
    // --- ç¶å®šè³‡æ–™åˆ°å°æ‡‰çš„ HTML ID ---
    
    // 1. é†«å¸«èˆ‡è­·ç†å¸«
    setOptions('selectDoctor', staff.doctors, 'è«‹é¸æ“‡é†«å¸«');
    setOptions('selectNurse', staff.nurses, 'è«‹é¸æ“‡è­·ç†å¸«');
    
    // 2. æ²»ç™‚å¸« (åŒæ™‚æ›´æ–°ã€Œæ²»ç™‚ç´€éŒ„ã€èˆ‡ã€Œæ–°å¢å€‹æ¡ˆã€é é¢çš„é¸å–®)
    setOptions(['inputTherapist', 'addTherapist'], staff.therapists, 'è«‹é¸æ“‡æ²»ç™‚å¸«'); 
    
    // 3. ä¿é¤Šé é¢
    setOptions('selectMaintStaff', staff.allStaff, 'è«‹é¸æ“‡åŸ·è¡Œäººå“¡'); // ä½¿ç”¨ All Staff
    setOptions('selectMaintItem', staff.maintItems, 'è«‹é¸æ“‡ä¿é¤Šé …ç›®');
    
    // 4. è¿½è¹¤é é¢
    setOptions('trackStaff', staff.allStaff, 'è«‹é¸æ“‡è¿½è¹¤äººå“¡'); // ä½¿ç”¨ All Staff
    setOptions('trackType', staff.trackingTypes || staff.trackingItems, 'è«‹é¸æ“‡è¿½è¹¤é …ç›®');
    
    // 5. æ²»ç™‚é …ç›®
    setOptions('inputTreatmentItem', staff.treatmentItems, 'è«‹é¸æ“‡æ²»ç™‚é …ç›®');
    
    console.log('ä¸‹æ‹‰é¸å–®å·²æ›´æ–°');
}

function navTo(viewName) {
  if (window.innerWidth < 768) {
      const sidebar = document.getElementById('sidebar');
      if (sidebar && !sidebar.classList.contains('hidden')) {
          sidebar.classList.add('hidden');
      }
  }

  if (!currentClient && viewName !== 'search') {
      showNotification('æç¤º', 'è«‹å…ˆé¸å–å€‹æ¡ˆä»¥é€²è¡Œæ“ä½œã€‚', 'info');
      return;
  }

  const views = ['search', 'basic', 'images', 'treatment', 'maintenance', 'doctor', 'tracking', 'overview'];
  views.forEach(v => {
    document.getElementById('view-' + v)?.classList.add('hidden');
    document.getElementById('btn-' + v)?.classList.remove('active');
  });
  const target = document.getElementById('view-' + viewName);
  if(target) {
    target.classList.remove('hidden');
    target.classList.add('view-animate');
  }
  document.getElementById('btn-' + viewName)?.classList.add('active');

  const titles = { 'search':'é¦–é ','basic':'åŸºæœ¬è³‡æ–™','images':'å½±åƒç¸½è¦½','treatment':'ç‰©ç†æ²»ç™‚','maintenance':'ä¿é¤Šé …ç›®','doctor':'é†«å¸«çœ‹è¨º','tracking':'å€‹ç®¡è¿½è¹¤','overview':'å€‹æ¡ˆç¸½è¦½' };
  document.getElementById('pageTitle').textContent = titles[viewName] || 'åº·é£›é‹é†«';

  if (currentClient) {
    if (['treatment', 'maintenance', 'doctor', 'tracking', 'overview'].includes(viewName)) {
        if (allCalendarEvents.length === 0) {
            fetchCalendarData();
        }
    }
    if(viewName === 'basic') renderBasicInfo();
    if(viewName === 'doctor') loadDoctorHistory();
    if(viewName === 'treatment') loadTreatmentHistory();
    if(viewName === 'maintenance') loadMaintenanceHistory();
    if(viewName === 'tracking') loadTrackingHistory();
    if(viewName === 'overview') loadOverviewData();
    if(viewName === 'images') loadClientImages();
  }
}

function fetchCalendarData() {
    google.script.run.withSuccessHandler(data => {
        allCalendarEvents = data || [];
    }).getCaseOverviewData(currentClient['å€‹æ¡ˆç·¨è™Ÿ']);
}// ==========================================
// æ–°å¢å€‹æ¡ˆç›¸é—œå‡½å¼
// ==========================================
function autoDetectGender(input) {
  const val = input.value.toUpperCase();
  input.value = val;
}

function editClientInfo() {
  if (!currentClient) return;
  isEditingClient = true;

  document.getElementById('addName').value = currentClient['å§“å'] || '';
  document.getElementById('addDob').value = currentClient['ç”Ÿæ—¥'] || '';
  document.getElementById('addIdNo').value = currentClient['èº«åˆ†è­‰å­—è™Ÿ'] || '';
  document.getElementById('addPhone').value = currentClient['é›»è©±'] || '';
  document.getElementById('addEmerName').value = currentClient['ç·Šæ€¥è¯çµ¡äºº'] || '';
  document.getElementById('addEmerPhone').value = currentClient['ç·Šæ€¥è¯çµ¡äººé›»è©±'] || '';
  document.getElementById('addTherapist').value = currentClient['è² è²¬æ²»ç™‚å¸«'] || '';
  document.getElementById('addChronic').value = currentClient['æ…¢æ€§ç—…æˆ–ç‰¹æ®Šç–¾ç—…'] || '';

  document.querySelector('#addClientModal h3').textContent = 'ç·¨è¼¯å€‹æ¡ˆè³‡æ–™';
  const btn = document.getElementById('btnSubmitClient');
  btn.innerHTML = 'å„²å­˜ä¿®æ”¹';
  btn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
  btn.classList.add('bg-amber-500', 'hover:bg-amber-600'); 

  openModal('addClientModal');
}

function resetAddClientModalUI() {
  isEditingClient = false;
  document.getElementById('addClientForm').reset();
  
  document.querySelector('#addClientModal h3').textContent = 'æ–°å¢å€‹æ¡ˆè³‡æ–™';
  const btn = document.getElementById('btnSubmitClient');
  btn.innerHTML = 'å»ºç«‹å€‹æ¡ˆè³‡æ–™';
  btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
  btn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
}

function handlePrint() {
  const today = new Date();
  const dateStr = today.getFullYear() + "-" +
                  String(today.getMonth() + 1).padStart(2, '0') + "-" +
                  String(today.getDate()).padStart(2, '0');
  const dateEl = document.getElementById('print-date-display');
  if(dateEl) dateEl.innerText = dateStr;

  const infoEl = document.getElementById('print-patient-info');
  if (infoEl) {
      if (currentClient) {
          infoEl.innerText = currentClient['å§“å'];
      } else {
          infoEl.innerText = "";
      }
  }
  window.print();
}

// ==========================================
// åŸºæœ¬è³‡æ–™æ¸²æŸ“
// ==========================================
function renderBasicInfo() {
  if(!currentClient) return;
  const fieldMap = {
    'display-client-id': 'å€‹æ¡ˆç·¨è™Ÿ',
    'display-name': 'å§“å',
    'display-gender': 'æ€§åˆ¥',
    'display-birthday': 'ç”Ÿæ—¥',
    'display-id-number': 'èº«åˆ†è­‰å­—è™Ÿ',
    'display-phone': 'é›»è©±',
    'display-emergency-name': 'ç·Šæ€¥è¯çµ¡äºº',
    'display-emergency-phone': 'ç·Šæ€¥è¯çµ¡äººé›»è©±',
    'display-therapist': 'è² è²¬æ²»ç™‚å¸«',
    'display-notes': 'æ…¢æ€§ç—…æˆ–ç‰¹æ®Šç–¾ç—…'
  };
  for (const [domId, dbKey] of Object.entries(fieldMap)) {
    const el = document.getElementById(domId);
    if(el) {
       if(domId === 'display-notes' && (!currentClient[dbKey] || currentClient[dbKey] === '')) continue;
       
       let displayValue = currentClient[dbKey] || '--';

       if (domId === 'display-birthday') {
           displayValue = formatYmd(displayValue);
       }
       else if (domId === 'display-phone' || domId === 'display-emergency-phone') {
           displayValue = formatPhone(displayValue);
       }

       el.textContent = displayValue;
    }
  }
  const statusEl = document.getElementById('display-status');
  if(statusEl && currentClient['ç‹€æ…‹']) statusEl.textContent = currentClient['ç‹€æ…‹'];
}

// ==========================================
// 1. å…¨åŸŸè®Šæ•¸æ–°å¢ (æœå°‹ç›¸é—œ)
// ==========================================
let allClientCache = []; // å­˜æ”¾æ‰€æœ‰å€‹æ¡ˆçš„å¿«å–è³‡æ–™
let isClientCacheLoaded = false;

// ==========================================
// 3. é è¼‰å€‹æ¡ˆè³‡æ–™åº« (æ ¸å¿ƒå„ªåŒ–)
// ==========================================
function initClientDatabase() {
  console.log("æ­£åœ¨ä¸‹è¼‰å€‹æ¡ˆè³‡æ–™åº«...");
  // å¯ä»¥åœ¨æœå°‹æ¬„é¡¯ç¤º Loading æç¤º
  const searchInput = document.getElementById('searchInput');
  if(searchInput) searchInput.setAttribute('placeholder', 'æ­£åœ¨åŒæ­¥å€‹æ¡ˆè³‡æ–™åº«...');

  google.script.run
    .withSuccessHandler(data => {
      allClientCache = data; // data æ˜¯ Code.gs å›å‚³çš„ [{id, name, fullJson...}, ...]
      isClientCacheLoaded = true;
      console.log(`å€‹æ¡ˆè³‡æ–™åº«åŒæ­¥å®Œæˆï¼Œå…± ${data.length} ç­†`);
      
      if(searchInput) {
        searchInput.setAttribute('placeholder', 'è¼¸å…¥å§“åã€é›»è©±æˆ–ç·¨è™Ÿæœå°‹');
        searchInput.removeAttribute('disabled');
      }
    })
    .withFailureHandler(err => {
      console.error("å€‹æ¡ˆè³‡æ–™ä¸‹è¼‰å¤±æ•—", err);
      if(searchInput) searchInput.setAttribute('placeholder', 'è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†');
    })
    .getAllClientDataForCache(); 
}

// ==========================================
// 4. æ¥µé€Ÿæœå°‹ (å®Œå…¨ä¸å‘¼å« Google Script Run)
// ==========================================
function handleSearchDebounced(val) {
  handleSearch(val);
}

function handleSearch(keyword) {
  const kw = (keyword || document.getElementById('searchInput').value).trim().toLowerCase();
  const container = document.getElementById('searchResults');
  
  if (!kw) { 
    container.innerHTML = ''; 
    return; 
  }

  if (!isClientCacheLoaded) {
    container.innerHTML = '<div class="text-center py-4 text-slate-400">è³‡æ–™åº«æ­£åœ¨åˆå§‹åŒ–ï¼Œè«‹ç¨å€™...</div>';
    return;
  }

  // â˜… æœ¬åœ°ç¯©é¸ (é€Ÿåº¦æ¥µå¿«) â˜…
  const results = allClientCache.filter(c => {
    return (
      c.name.toLowerCase().includes(kw) ||
      c.phone.includes(kw) ||
      c.id.toLowerCase().includes(kw)
    );
  });

  renderSearchResults(results, container);
}

function renderSearchResults(data, container) {
  container.innerHTML = '';
  if (data.length === 0) {
    container.innerHTML = '<div class="text-center py-6 text-slate-400 bg-white rounded-2xl border border-slate-100 shadow-sm">æŸ¥ç„¡æ­¤å€‹æ¡ˆè³‡æ–™</div>';
    return;
  }

  const fragment = document.createDocumentFragment();
  const template = document.getElementById('tmpl-search-result');

  // é™åˆ¶é¡¯ç¤ºæ•¸é‡ï¼Œé¿å… DOM å¤ªå¤šå¡é “ (ä¾‹å¦‚åªé¡¯ç¤ºå‰ 30 ç­†)
  const displayData = data.slice(0, 30); 

  displayData.forEach(c => {
    const clone = template.content.cloneNode(true);
    
    clone.querySelector('.data-name').textContent = c.name;
    clone.querySelector('.data-dob').textContent = formatYmd(c.dob);
    clone.querySelector('.data-phone').textContent = formatPhone(c.phone);

    const card = clone.querySelector('.client-card');
    card.onclick = () => {
      // â˜… ç›´æ¥ Parse é å­˜çš„ JSON
      const fullData = JSON.parse(c.fullJson);
      selectClient(fullData);
    };

    fragment.appendChild(clone);
  });

  if (data.length > 30) {
    const moreDiv = document.createElement('div');
    moreDiv.className = "text-center text-xs text-slate-400 py-2";
    moreDiv.textContent = `é‚„æœ‰ ${data.length - 30} ç­†ç›¸ç¬¦è³‡æ–™ï¼Œè«‹è¼¸å…¥æ›´ç²¾ç¢ºçš„é—œéµå­—`;
    fragment.appendChild(moreDiv);
  }

  container.appendChild(fragment);
}

// ==========================================
// 5. å„ªåŒ– Loading é¡¯ç¤º
// ==========================================
function showGlobalLoading(show, text = "è™•ç†ä¸­...") {
  const loader = document.getElementById('global-loader');
  const txt = document.getElementById('global-loader-text');
  if (show) {
    txt.textContent = text;
    loader.classList.remove('hidden');
  } else {
    loader.classList.add('hidden');
  }
}

function submitNewClient() {
  const data = {
    name: document.getElementById('addName').value,
    dob: document.getElementById('addDob').value,
    idNo: document.getElementById('addIdNo').value,
    phone: document.getElementById('addPhone').value,
    gender: "", // è‡ªå‹•åˆ¤æ–·
    emerName: document.getElementById('addEmerName').value,
    emerPhone: document.getElementById('addEmerPhone').value,
    therapist: document.getElementById('addTherapist').value,
    chronic: document.getElementById('addChronic').value
  };

  // ç°¡æ˜“é©—è­‰
  if(!data.name || !data.dob || !data.idNo || !data.phone) {
    showNotification('æ¬„ä½æœªå¡«', 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ (*)', 'warning');
    return;
  }
  
  if(data.idNo.length === 10) {
      const char2 = data.idNo.charAt(1);
      if(char2 === '1') data.gender = 'ç”·';
      else if(char2 === '2') data.gender = 'å¥³';
      else data.gender = 'å…¶ä»–';
  }

  // ä½¿ç”¨å…¨åŸŸé®ç½©
  showGlobalLoading(true, isEditingClient ? "æ­£åœ¨æ›´æ–°è³‡æ–™..." : "æ­£åœ¨å»ºç«‹å€‹æ¡ˆè³‡æ–™åº«...");
  
  if (isEditingClient) {
     const updateData = { ...data, clientId: currentClient['å€‹æ¡ˆç·¨è™Ÿ'] };
     google.script.run
       .withSuccessHandler(res => {
          showGlobalLoading(false);
          if (res.success) {
              showNotification('æˆåŠŸ', 'è³‡æ–™æ›´æ–°æˆåŠŸ', 'success');
              closeModal('addClientModal');
              // æ›´æ–°ç•¶å‰é¡¯ç¤º
              selectClient(res.updatedData); 
              // å¯ä»¥åœ¨æ­¤è™•é‡æ–°åŒæ­¥å¿«å–ï¼Œç•¥
          } else {
              showNotification('å¤±æ•—', res.message, 'error');
          }
       })
       .withFailureHandler(e => {
           showGlobalLoading(false);
           showNotification('ç³»çµ±éŒ¯èª¤', e.message, 'error');
       })
       .updateClientBasicInfo(updateData);
       
  } else {
     google.script.run
       .withSuccessHandler(function(res) {
          showGlobalLoading(false);
          if (res.success) {
              showNotification('æˆåŠŸ', 'å€‹æ¡ˆå»ºç«‹æˆåŠŸï¼', 'success');
              document.getElementById('addClientForm').reset();
              closeModal('addClientModal');
              
              // â˜… ç«‹å³å°‡æ–°å€‹æ¡ˆåŠ å…¥æœ¬åœ°å¿«å–
              allClientCache.unshift({
                id: res.clientId,
                name: data.name,
                dob: data.dob,
                phone: data.phone,
                fullJson: JSON.stringify(res.fullData)
              });
              
              selectClient(res.fullData);
          } else {
              showNotification('å»ºç«‹å¤±æ•—', res.message, 'error');
          }
       })
       .withFailureHandler(function(e) {
           showGlobalLoading(false);
           showNotification('ç³»çµ±éŒ¯èª¤', e.message, 'error');
       })
       .createNewClient(data);
  }
}

function selectClient(c) {
  currentClient = c;
  allCalendarEvents = [];

  document.getElementById('topBarClientInfo').classList.remove('hidden');
  document.getElementById('headerClientName').textContent = c['å§“å'];
  document.getElementById('headerClientDob').textContent = formatYmd(c['ç”Ÿæ—¥']);
  
  document.querySelectorAll('.auto-fill-id').forEach(el => el.value = c['å€‹æ¡ˆç·¨è™Ÿ']);

  const therapistSelect = document.getElementById('inputTherapist');
  if (therapistSelect) {
      therapistSelect.value = c['è² è²¬æ²»ç™‚å¸«'] || "";
  }
  
  const itemSelect = document.getElementById('inputTreatmentItem');
  if (itemSelect) {
      itemSelect.value = "1600"; // é è¨­å€¼
  }
  navTo('treatment');
}

// ==========================================
// ç·¨è¼¯åŠŸèƒ½ç›¸é—œå‡½å¼
// ==========================================

function findIdFromData(data) {
    if (!data) return "";
    const candidates = ['ç´€éŒ„id', 'ç´€éŒ„ID', 'è¿½è¹¤ID', 'è¿½è¹¤id', 'å½±åƒID', 'å½±åƒid', 'id', 'ID', 'Id', 'RecordId', 'record_id'];
    for (const key of candidates) {
        if (data[key] !== undefined && data[key] !== "") return data[key];
    }
    const keys = Object.keys(data);
    for (const key of keys) {
        const cleanKey = key.replace(/\s+/g, '').toLowerCase();
        if (cleanKey === 'ç´€éŒ„id' || cleanKey === 'è¿½è¹¤id' || cleanKey === 'å½±åƒid' || cleanKey === 'id') {
            return data[key];
        }
    }
    if (Array.isArray(data) && data.length > 0) return data[0];
    return "";
}

function startEdit(type, data) {
  let id = findIdFromData(data);
  if (!id) {
     showNotification('è³‡æ–™éŒ¯èª¤', 'ç„¡æ³•è®€å–æ­¤ç­†ç´€éŒ„çš„ IDã€‚', 'error');
     return;
  }

  const idField = document.getElementById('edit_id_' + type);
  if (idField) idField.value = id;

  const cancelDiv = document.getElementById('edit-cancel-' + type);
  if (cancelDiv) cancelDiv.classList.remove('hidden');

  const submitBtn = getSubmitBtn(type);
  if (submitBtn) {
    if (!submitBtn.hasAttribute('data-original-text')) {
       submitBtn.setAttribute('data-original-text', submitBtn.innerHTML);
    }
    submitBtn.innerHTML = '<span class="material-icons-outlined text-lg mr-1">update</span> ç¢ºèªæ›´æ–°ä¿®æ”¹';
    submitBtn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600', 'bg-violet-600', 'hover:bg-violet-700', 'bg-gradient-to-r', 'from-orange-400', 'to-orange-600', 'hover:from-orange-500', 'hover:to-orange-700');
    submitBtn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'text-white');
  }

  try {
    if (type === 'treatment') {
        if(document.getElementById('treatmentDate')._flatpickr)
        document.getElementById('treatmentDate')._flatpickr.setDate(formatYmd(data['æ²»ç™‚æ—¥æœŸ'] || data['date']));

        document.getElementById('inputTherapist').value = data['åŸ·è¡Œæ²»ç™‚å¸«'] || data['therapist'] || "";
        document.getElementById('inputTreatmentItem').value = data['æ²»ç™‚é …ç›®'] || data['item'] || "";
        document.getElementById('inputComplaint').value = data['ç•¶æ—¥ä¸»è¨´'] || data['complaint'] || "";
        document.getElementById('inputContent').value = data['æ²»ç™‚å…§å®¹'] || data['content'] || "";
        document.getElementById('inputNextPlan').value = data['å‚™è¨»/ä¸‹æ¬¡æ²»ç™‚'] || data['nextPlan'] || "";
        document.getElementById('view-treatment').scrollIntoView({ behavior: 'smooth' });
    }
    else if (type === 'doctor') {
        if(document.getElementById('doctorConsultDate')._flatpickr)
        document.getElementById('doctorConsultDate')._flatpickr.setDate(formatYmd(data['çœ‹è¨ºæ—¥æœŸ']));

        document.getElementById('selectDoctor').value = data['çœ‹è¨ºé†«å¸«'] || "";
        document.getElementById('selectNurse').value = data['è­·ç†å¸«'] || "";
        document.querySelector('#view-doctor textarea[name="ä¸»è¨´"]').value = data['S_ä¸»è¨´'] || "";
        document.querySelector('#view-doctor textarea[name="å®¢è§€æª¢æŸ¥"]').value = data['O_å®¢è§€æª¢æŸ¥'] || "";
        document.querySelector('#view-doctor textarea[name="è¨ºæ–·"]').value = data['A_è¨ºæ–·'] || "";
        document.querySelector('#view-doctor textarea[name="æ²»ç™‚è¨ˆç•«"]').value = data['P_æ²»ç™‚è¨ˆåŠƒ'] || "";
        document.getElementById('nursingRecord').value = data['è­·ç†ç´€éŒ„'] || "";
        document.getElementById('doctorRemark').value = data['å‚™è¨»'] || "";
        document.getElementById('view-doctor').scrollIntoView({ behavior: 'smooth' });
    }
    else if (type === 'maintenance') {
        if(document.getElementById('maintenanceDate')._flatpickr)
        document.getElementById('maintenanceDate')._flatpickr.setDate(formatYmd(data['ä¿é¤Šæ—¥æœŸ']));

        document.getElementById('selectMaintStaff').value = data['åŸ·è¡Œäººå“¡'] || "";
        document.getElementById('selectMaintItem').value = data['ä¿é¤Šé …ç›®'] || "";
        const f = document.getElementById('maintenanceForm');
        f.querySelector('input[name="è¡€å£“"]').value = data['è¡€å£“'] || "";
        f.querySelector('input[name="è¡€æ°§"]').value = data['è¡€æ°§'] || "";
        f.querySelector('input[name="å¿ƒå¾‹"]').value = data['å¿ƒå¾‹'] || "";
        f.querySelector('input[name="é«”æº«"]').value = data['é«”æº«'] || "";
        f.querySelector('input[name="å‘¼å¸é€Ÿç‡"]').value = data['å‘¼å¸é€Ÿç‡'] || data['rr'] || "";
        f.querySelector('textarea[name="å‚™è¨»"]').value = data['å‚™è¨»'] || data['remark'] || "";
        document.getElementById('view-maintenance').scrollIntoView({ behavior: 'smooth' });
    }
    else if (type === 'tracking') {
        if(document.getElementById('trackDate')._flatpickr)
        document.getElementById('trackDate')._flatpickr.setDate(formatYmd(data.date || data['è¿½è¹¤æ—¥æœŸ']));

        document.getElementById('trackStaff').value = data.staff || data['è¿½è¹¤äººå“¡'] || "";
        document.getElementById('trackType').value = data.type || data['è¿½è¹¤é …ç›®'] || "";
        document.getElementById('trackContent').value = data.content || data['è¿½è¹¤å…§å®¹'] || "";
        document.getElementById('view-tracking').scrollIntoView({ behavior: 'smooth' });
    }
  } catch(e) {
      console.error("Error populating form:", e);
  }
}

function cancelEdit(type) {
  document.getElementById('edit_id_' + type).value = "";
  document.getElementById('edit-cancel-' + type).classList.add('hidden');

  if(type === 'tracking') {
      document.getElementById('trackingForm').reset();
  } else {
      document.getElementById(type + 'Form').reset();
      
      if (type === 'treatment' && currentClient) {
          document.getElementById('inputTherapist').value = currentClient['è² è²¬æ²»ç™‚å¸«'] || "";
      }
  }

  const today = new Date();
  if(type === 'treatment' && document.getElementById('treatmentDate')._flatpickr) document.getElementById('treatmentDate')._flatpickr.setDate(today);
  if(type === 'doctor' && document.getElementById('doctorConsultDate')._flatpickr) document.getElementById('doctorConsultDate')._flatpickr.setDate(today);
  if(type === 'maintenance' && document.getElementById('maintenanceDate')._flatpickr) document.getElementById('maintenanceDate')._flatpickr.setDate(today);
  if(type === 'tracking' && document.getElementById('trackDate')._flatpickr) document.getElementById('trackDate')._flatpickr.setDate(today);

  document.querySelectorAll('.auto-fill-id').forEach(el => el.value = currentClient ? currentClient['å€‹æ¡ˆç·¨è™Ÿ'] : "");

  const submitBtn = getSubmitBtn(type);
  if (submitBtn) {
    if (submitBtn.hasAttribute('data-original-text')) {
       submitBtn.innerHTML = submitBtn.getAttribute('data-original-text');
    } else {
       submitBtn.innerHTML = "å„²å­˜ç´€éŒ„";
    }
    submitBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600', 'text-white');

    if(type === 'tracking') {
        submitBtn.classList.add('bg-violet-600', 'hover:bg-violet-700', 'text-white');
    } else if(type === 'maintenance') {
        submitBtn.classList.add('bg-gradient-to-r', 'from-orange-400', 'to-orange-600', 'hover:from-orange-500', 'hover:to-orange-700', 'text-white');
    } else {
        submitBtn.classList.add('bg-emerald-500', 'hover:bg-emerald-600', 'text-white');
    }
  }
}

function getSubmitBtn(type) {
  if (type === 'tracking') return document.querySelector('#trackingForm button[type="submit"]');
  if (type === 'maintenance') return document.querySelector('#maintenanceForm button[onclick*="submitForm"]');
  if (type === 'doctor') return document.querySelector('#doctorForm button[onclick*="submitForm"]');
  if (type === 'treatment') return document.querySelector('#treatmentForm button[onclick*="submitForm"]');
  return null;
}

// ==========================================
// è¡¨å–®æäº¤
// ==========================================
function submitForm(type) {
  if (!currentClient) {
      showNotification('æµç¨‹éŒ¯èª¤', 'æœªé¸å–å€‹æ¡ˆï¼Œè«‹é‡æ–°æœå°‹ã€‚', 'error');
      return;
  }

  const clientId = currentClient['å€‹æ¡ˆç·¨è™Ÿ'];
  const editIdField = document.getElementById('edit_id_' + type);
  const editId = editIdField ? editIdField.value : "";
  const isEdit = (editId && editId !== "");

  let btn = null;
  if(type === 'tracking') btn = document.querySelector('#trackingForm button[type="submit"]');
  else if(event && event.target) btn = event.target;
  const safeBtn = getSubmitBtn(type);
  if(safeBtn) btn = safeBtn;

  const ot = btn ? btn.innerHTML : "å„²å­˜";
  
  if(btn) { btn.disabled = true; btn.innerHTML = '<span class="material-icons-outlined animate-spin-reverse">sync</span> è™•ç†ä¸­...'; }

  const onSuccess = (res, formId, reloadFunc) => {
      btn.disabled = false;
      btn.innerHTML = ot;
      if (res.success) {
          showNotification('æˆåŠŸ', res.message, 'success');
          if (isEdit) {
             cancelEdit(type);
          } else {
             if(formId) document.getElementById(formId).reset();
             document.querySelectorAll('.auto-fill-id').forEach(el => el.value = clientId);
             
             if (formId === 'treatmentForm' && currentClient) {
                 document.getElementById('inputTherapist').value = currentClient['è² è²¬æ²»ç™‚å¸«'] || "";
             }
          }
          if(reloadFunc) reloadFunc();
          fetchCalendarData();
      } else {
          showNotification('éŒ¯èª¤', res.message, 'error');
      }
  };

  let d = {};

  if (type === 'doctor') {
    d = {
      record_id: editId,
      clientId: clientId,
      date: document.getElementById('doctorConsultDate').value,
      doctor: document.getElementById('selectDoctor').value,
      nurse: document.getElementById('selectNurse').value,
      complaint: document.querySelector('#view-doctor textarea[name="ä¸»è¨´"]').value,
      objective: document.querySelector('#view-doctor textarea[name="å®¢è§€æª¢æŸ¥"]').value,
      diagnosis: document.querySelector('#view-doctor textarea[name="è¨ºæ–·"]').value,
      plan: document.querySelector('#view-doctor textarea[name="æ²»ç™‚è¨ˆç•«"]').value,
      nursingRecord: document.getElementById('nursingRecord').value,
      remark: document.getElementById('doctorRemark').value
    };
    if (!d.date || !d.doctor) {
        showNotification('æ¬„ä½æœªå¡«', 'è«‹å¡«å¯«æ—¥æœŸèˆ‡é†«å¸«', 'warning');
        if(btn){btn.disabled=false; btn.innerHTML=ot;} return;
    }
  }
  else if (type === 'treatment') {
    d = {
      record_id: editId,
      'å€‹æ¡ˆç·¨è™Ÿ': clientId,
      'æ²»ç™‚æ—¥æœŸ': document.getElementById('treatmentDate').value,
      'åŸ·è¡Œæ²»ç™‚å¸«': document.getElementById('inputTherapist').value,
      'æ²»ç™‚é …ç›®': document.getElementById('inputTreatmentItem').value,
      'ç•¶æ—¥ä¸»è¨´': document.getElementById('inputComplaint').value,
      'æ²»ç™‚å…§å®¹': document.getElementById('inputContent').value,
      'å‚™è¨»/ä¸‹æ¬¡æ²»ç™‚': document.getElementById('inputNextPlan').value,
      date: document.getElementById('treatmentDate').value,
      therapist: document.getElementById('inputTherapist').value,
      item: document.getElementById('inputTreatmentItem').value,
      complaint: document.getElementById('inputComplaint').value,
      content: document.getElementById('inputContent').value,
      nextPlan: document.getElementById('inputNextPlan').value
    };
    if (!d['æ²»ç™‚æ—¥æœŸ'] || !d['åŸ·è¡Œæ²»ç™‚å¸«']) {
        showNotification('æ¬„ä½æœªå¡«', 'è«‹å¡«å¯«æ—¥æœŸèˆ‡æ²»ç™‚å¸«', 'warning');
        if(btn){btn.disabled=false; btn.innerHTML=ot;} return;
    }
  }
  else if (type === 'maintenance') {
    const f = document.getElementById('maintenanceForm');
    d = {
      record_id: editId,
      clientId: clientId,
      date: document.getElementById('maintenanceDate').value,
      staff: document.getElementById('selectMaintStaff').value,
      item: document.getElementById('selectMaintItem').value,
      bp: f.querySelector('input[name="è¡€å£“"]').value,
      spo2: f.querySelector('input[name="è¡€æ°§"]').value,
      hr: f.querySelector('input[name="å¿ƒå¾‹"]').value,
      temp: f.querySelector('input[name="é«”æº«"]').value,
      rr: f.querySelector('input[name="å‘¼å¸é€Ÿç‡"]').value,
      remark: f.querySelector('textarea[name="å‚™è¨»"]').value
    };
    if (!d.date || !d.staff || !d.item) {
        showNotification('æ¬„ä½æœªå¡«', 'è«‹å®Œæ•´å¡«å¯«å¿…å¡«æ¬„ä½', 'warning');
        if(btn){btn.disabled=false; btn.innerHTML=ot;} return;
    }
  }
  else if (type === 'tracking') {
    d = {
      record_id: editId,
      clientId: clientId,
      trackDate: document.getElementById('trackDate').value,
      trackStaff: document.getElementById('trackStaff').value,
      trackType: document.getElementById('trackType').value,
      content: document.getElementById('trackContent').value
    };
    if (!d.trackDate || !d.trackStaff || !d.trackType || !d.content) {
        showNotification('æ¬„ä½æœªå¡«', 'è«‹å®Œæ•´å¡«å¯«è¿½è¹¤è³‡æ–™', 'warning');
        if(btn){btn.disabled=false; btn.innerHTML=ot;} return;
    }
  }

  // å¾Œç«¯å·²å„ªåŒ–ç‚ºæ‰¹é‡å¯«å…¥ï¼Œå‘¼å«æ–¹å¼ä¸è®Š
  if (isEdit) {
     google.script.run
       .withSuccessHandler(res => onSuccess(res, null, getReloadFunc(type)))
       .updateRecord(type, d);
  } else {
     if (type === 'doctor') google.script.run.withSuccessHandler(res => onSuccess(res, 'doctorForm', loadDoctorHistory)).saveDoctorConsultation(d);
     else if (type === 'treatment') google.script.run.withSuccessHandler(res => onSuccess(res, 'treatmentForm', loadTreatmentHistory)).saveData('Treatment_Logs', d);
     else if (type === 'maintenance') google.script.run.withSuccessHandler(res => onSuccess(res, 'maintenanceForm', loadMaintenanceHistory)).saveMaintenanceRecord(d);
     else if (type === 'tracking') google.script.run.withSuccessHandler(res => { document.getElementById('trackContent').value = ""; onSuccess(res, null, loadTrackingHistory); }).saveTrackingRecord(d);
  }
}

function getReloadFunc(type) {
    if(type === 'treatment') return loadTreatmentHistory;
    if(type === 'doctor') return loadDoctorHistory;
    if(type === 'maintenance') return loadMaintenanceHistory;
    if(type === 'tracking') return loadTrackingHistory;
    return null;
}// ==========================================
// æ­·å²åˆ—è¡¨è¼‰å…¥èˆ‡æ¸²æŸ“
// ==========================================

function loadTrackingHistory() {
  const c = document.getElementById('trackingHistoryList'); c.innerHTML = '<div class="text-center py-6 text-slate-400">è®€å–ä¸­...</div>';
  google.script.run.withSuccessHandler(recs => {
    if (!recs || !recs.length) { c.innerHTML = `<div class="text-center text-slate-400 py-12 bg-white rounded-[2rem] border border-slate-100"><span class="material-icons-outlined text-4xl mb-2 text-slate-300">history_edu</span><p>å°šç„¡ä»»ä½•è¿½è¹¤ç´€éŒ„</p></div>`; return; }
    
    c.innerHTML = recs.map(r => {
      const dataStr = encodeURIComponent(JSON.stringify(r));
      return `
      <div class="bg-white p-3 rounded-[1.5rem] border border-slate-100 shadow-sm card-hover mb-2 relative overflow-hidden group print:break-inside-avoid print:mb-4 print:border print:border-slate-300">
        <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-violet-500 opacity-80 print:hidden"></div>
        <div class="pl-2">
          <div class="flex justify-between items-start mb-1">
            <div class="flex items-center gap-2">
              <span class="bg-violet-50 text-violet-700 text-xs font-bold px-3 py-1 rounded-full border border-violet-100 print:border-slate-300 print:text-black">${r.type}</span>
              <div class="text-slate-500 text-xs font-bold flex items-center bg-slate-50 px-2 py-1 rounded-lg print:bg-white">
                <span class="material-icons-outlined text-[14px] mr-1 text-slate-400 print:hidden">person</span>${r.staff||'--'}
              </div>
              <button onclick="startEdit('tracking', JSON.parse(decodeURIComponent('${dataStr}')))" class="text-slate-300 hover:text-violet-500 transition print:hidden" title="ç·¨è¼¯">
                  <span class="material-icons-outlined text-sm">edit</span>
              </button>
            </div>
            <span class="text-slate-400 text-xs font-mono print:text-black">${formatYmd(r.date)}</span>
          </div>
          <div class="text-slate-700 text-sm leading-relaxed whitespace-pre-line bg-slate-50/50 p-2 rounded-xl print:bg-white print:p-0">${r.content}</div>
        </div>
      </div>`;
    }).join('');
  }).getTrackingHistory(currentClient['å€‹æ¡ˆç·¨è™Ÿ']);
}

function loadTreatmentHistory() {
  const c = document.getElementById('historyListContainer'); 
  c.innerHTML = '<div class="text-center py-6 text-slate-400">è®€å–ä¸­...</div>';
  google.script.run.withSuccessHandler(logs => {
      allTreatmentLogs = logs || [];
      renderTreatmentList(allTreatmentLogs);
  }).getClientHistory(currentClient['å€‹æ¡ˆç·¨è™Ÿ'], 'Treatment_Logs');
}

/**
 * æ¸²æŸ“æ²»ç™‚æ­·å²åˆ—è¡¨ (v2.0 Optimized)
 * Fix: å¼·åˆ¶ç·¨ç¢¼å–®å¼•è™Ÿï¼Œè§£æ±º onclick èªæ³•éŒ¯èª¤
 */
function renderTreatmentList(logs) {
  const c = document.getElementById('historyListContainer');
  const countBadge = document.getElementById('treatmentHistoryCount');
  
  if(countBadge) countBadge.textContent = `å…± ${logs ? logs.length : 0} æ¬¡`;

  if(!logs || !logs.length) {
    c.innerHTML = '<div class="text-center py-10 text-slate-300 bg-slate-50 rounded-2xl">ç„¡ç›¸é—œç´€éŒ„</div>';
    return;
  }

  c.innerHTML = logs.map(l => {
    // ğŸ”¥ é—œéµä¿®æ­£ï¼šencodeURIComponent ä¸æœƒè™•ç†å–®å¼•è™Ÿï¼Œå¿…é ˆæ‰‹å‹• replace ç‚º %27
    // é€™æ¨£æ‰èƒ½å®‰å…¨åœ°æ”¾å…¥ onclick çš„å–®å¼•è™Ÿå­—ä¸²åƒæ•¸ä¸­
    const dataStr = encodeURIComponent(JSON.stringify(l)).replace(/'/g, "%27");

    return `
    <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 card-hover relative overflow-hidden group print:break-inside-avoid print:border print:border-slate-200 print:shadow-none print:rounded-none">
        <div class="absolute top-0 left-0 w-1.5 h-full bg-emerald-500 print:hidden"></div>
        <div class="pl-2">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-500 font-mono bg-slate-100 px-2 py-1 rounded-lg print:bg-white print:border print:border-slate-200">${formatYmd(l['æ²»ç™‚æ—¥æœŸ'])}</span>
                    
                    <!-- é€™è£¡ç¶­æŒä½¿ç”¨ startEditï¼Œä¸¦é€é JSON.parse(decodeURIComponent(...)) é‚„åŸç‰©ä»¶ -->
                    <button onclick="startEdit('treatment', JSON.parse(decodeURIComponent('${dataStr}')))" class="text-slate-400 hover:text-emerald-500 transition px-2 print:hidden" title="ç·¨è¼¯ç´€éŒ„">
                        <span class="material-icons-outlined text-sm">edit</span>
                    </button>
                </div>
                
                <div class="flex items-center gap-2">
                    ${l['æ²»ç™‚é …ç›®'] ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100">${l['æ²»ç™‚é …ç›®']}</span>` : ''}
                    
                    <div class="flex items-center gap-1 text-sm font-bold text-slate-500">
                        <span class="material-icons-outlined text-sm">person</span>
                        ${l['åŸ·è¡Œæ²»ç™‚å¸«']}
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                ${l['ç•¶æ—¥ä¸»è¨´'] ? `
                <div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">ç•¶æ—¥ä¸»è¨´</div>
                    <div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed px-1">${l['ç•¶æ—¥ä¸»è¨´']}</div>
                </div>` : ''}
                
                ${l['æ²»ç™‚å…§å®¹'] ? `
                <div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">æ²»ç™‚å…§å®¹</div>
                    <div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed px-1">${l['æ²»ç™‚å…§å®¹']}</div>
                </div>` : ''}
                
                ${l['å‚™è¨»/ä¸‹æ¬¡æ²»ç™‚'] ? `
                <div class="bg-amber-50 p-3 rounded-xl border border-amber-100 mt-2 print:bg-white print:border-slate-200">
                    <div class="text-[10px] font-bold text-amber-500 uppercase tracking-wider mb-1 flex items-center gap-1">
                        <span class="material-icons-outlined text-[10px]">flag</span> å‚™è¨» / ä¸‹æ¬¡æ²»ç™‚
                    </div>
                    <div class="text-sm text-slate-600 whitespace-pre-wrap leading-relaxed">${l['å‚™è¨»/ä¸‹æ¬¡æ²»ç™‚']}</div>
                </div>` : ''}
            </div>
        </div>
    </div>`;
  }).join('');
}

/**
 * è™•ç†æ²»ç™‚ç´€éŒ„ç·¨è¼¯é»æ“Š
 * v2.0 Fix: ä½¿ç”¨ decodeURIComponent è§£æè³‡æ–™ï¼Œè§£æ±ºå–®å¼•è™Ÿèˆ‡æ›è¡Œå´©æ½°å•é¡Œ
 */
function onEditTreatmentClick(encodedData) {
  try {
    // 1. è§£ç¢¼ä¸¦é‚„åŸ JSON è³‡æ–™
    const record = JSON.parse(decodeURIComponent(encodedData));
    
    console.log("æ­£åœ¨ç·¨è¼¯è³‡æ–™:", record);

    // 2. å°‡è³‡æ–™å¡«å…¥ç·¨è¼¯è¦–çª— (Modal)
    // è«‹æ ¹æ“šæ‚¨ç¾æœ‰çš„ Modal ID é€²è¡Œå°æ‡‰ (ä»¥ä¸‹ç‚ºç¯„ä¾‹)
    document.getElementById('editDate').value = record.date || ''; 
    document.getElementById('editStaff').value = record.staff || '';
    
    // æ³¨æ„ï¼šå¦‚æœæ˜¯ textareaï¼Œè¦ç¢ºä¿èƒ½å¤ æ­£ç¢ºé¡¯ç¤ºæ›è¡Œ
    document.getElementById('editChiefComplaint').value = record.chiefComplaint || ''; 
    document.getElementById('editTreatmentContent').value = record.treatment || '';

    // ç´€éŒ„åŸå§‹ç´¢å¼•æˆ– ID (è‹¥å¯«å›å¾Œç«¯éœ€è¦)
    // å‡è¨­ record è£¡é¢æœ‰ rowIndex æˆ–æ˜¯æ‚¨æœ‰å…¨åŸŸè®Šæ•¸ç´€éŒ„ç•¶å‰ç·¨è¼¯ ID
    // currentEditingRowIndex = record.rowIndex; 

    // 3. é¡¯ç¤º Modal (ç¶­æŒæ—¢æœ‰é‚è¼¯)
    document.getElementById('editModal').classList.remove('hidden');

  } catch (e) {
    console.error("è§£æè³‡æ–™å¤±æ•—:", e);
    alert("è®€å–è³‡æ–™ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
  }
}

function loadMaintenanceHistory() {
  const c = document.getElementById('maintenanceHistoryList'); c.innerHTML = '<div class="text-center py-10 text-slate-400">ç´€éŒ„è¼‰å…¥ä¸­...</div>';
  google.script.run.withSuccessHandler(logs => {
    if(!logs || !logs.length) { c.innerHTML = '<div class="bg-white/50 border-2 border-dashed border-slate-200 rounded-[2.5rem] p-12 text-center text-slate-300">å°šç„¡æ­·å²ç´€éŒ„</div>'; return; }

    c.innerHTML = logs.map(l => {
      const dataStr = encodeURIComponent(JSON.stringify(l));
      
      const remarkText = l.remark || l['å‚™è¨»']; 

      return `
      <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 card-hover mb-4 flex flex-col md:flex-row gap-4 items-center print:break-inside-avoid print:mb-4 print:border print:border-slate-300 relative group">
        <button onclick="startEdit('maintenance', JSON.parse(decodeURIComponent('${dataStr}')))" class="absolute top-4 right-4 text-slate-300 hover:text-orange-500 transition print:hidden" title="ç·¨è¼¯">
            <span class="material-icons-outlined text-sm">edit</span>
        </button>

        <div class="w-full md:w-auto flex flex-col gap-1 border-b md:border-b-0 md:border-r border-slate-100 pb-4 md:pb-0 md:pr-6 min-w-[140px] print:border-r print:border-slate-300">
          <div class="text-sm font-mono text-slate-500 tracking-tight print:text-black">${formatYmd(l['ä¿é¤Šæ—¥æœŸ'])}</div>
          <span class="px-2.5 py-1 bg-orange-50 text-orange-600 text-[11px] font-bold rounded-lg w-fit mt-1 print:bg-white print:text-black print:border print:border-slate-300">${l['ä¿é¤Šé …ç›®']||'ä¸€èˆ¬'}</span>
          <div class="text-xs font-bold text-slate-400 flex items-center gap-1 mt-2 print:text-black">
             <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span>${l['åŸ·è¡Œäººå“¡']||'--'}
          </div>
        </div>
        
        <div class="w-full">
            <div class="grid grid-cols-5 gap-2 text-center">
              <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">Temp</div><div class="text-sm font-black text-slate-700 print:text-black">${l['é«”æº«']||l.temp||'-'}</div></div>
              <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">HR</div><div class="text-sm font-black text-slate-700 print:text-black">${l['å¿ƒå¾‹']||l.hr||'-'}</div></div>
              <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">RR</div><div class="text-sm font-black text-slate-700 print:text-black">${l['å‘¼å¸é€Ÿç‡']||l.rr||'-'}</div></div>
              <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">BP</div><div class="text-sm font-black text-slate-700 print:text-black">${l['è¡€å£“']||l.bp||'-'}</div></div>
              <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">SpO2</div><div class="text-sm font-black text-slate-700 print:text-black">${l['è¡€æ°§']||l.spo2||'-'}</div></div>
            </div>

            ${remarkText && remarkText !== '' ? `
             <div class="mt-4 pt-3 border-t border-gray-100 text-sm text-gray-600 text-left flex items-start">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 mr-2 mt-0.5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                 </svg>
                 <span class="break-words w-full">${remarkText}</span>
             </div>
             ` : ''}
        </div>
      </div>`;
    }).join('');
  }).getMaintenanceHistory(currentClient['å€‹æ¡ˆç·¨è™Ÿ']);
}

function loadDoctorHistory() {
  const c = document.getElementById('doctorHistoryList'); c.innerHTML = '<div class="text-center py-10 text-slate-400">è®€å–ä¸­...</div>';
  google.script.run.withSuccessHandler(logs => {
    if(!logs || !logs.length) { c.innerHTML = '<div class="py-12 text-center text-slate-300 bg-white rounded-[2rem] border border-slate-100">å°šç„¡çœ‹è¨ºç´€éŒ„</div>'; return; }

    c.innerHTML = logs.map(l => {
      const dataStr = encodeURIComponent(JSON.stringify(l));
      return `
      <div class="bg-white border border-slate-100 rounded-[2.5rem] p-4 shadow-sm mb-3 card-hover relative overflow-hidden print:break-inside-avoid print:mb-4 print:border print:border-slate-300 print:p-4 group">
        <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-50 print:mb-2 print:pb-2 print:border-slate-300">
          <div class="flex items-center gap-3">
              <span class="text-xs font-bold bg-emerald-50 text-emerald-600 px-4 py-2 rounded-full font-mono print:bg-white print:text-black print:border print:border-slate-300">${formatYmd(l['çœ‹è¨ºæ—¥æœŸ'])}</span>
              <button onclick="startEdit('doctor', JSON.parse(decodeURIComponent('${dataStr}')))" class="text-slate-300 hover:text-emerald-500 transition print:hidden" title="ç·¨è¼¯">
                  <span class="material-icons-outlined text-sm">edit</span>
              </button>
          </div>
          <div class="text-sm font-bold text-slate-500 flex items-center gap-4 print:text-black">
            <div class="flex items-center gap-1">
              <span class="material-icons-outlined text-base text-slate-400 print:hidden">person</span> ${l['çœ‹è¨ºé†«å¸«']||'--'}
            </div>
            <div class="flex items-center gap-1">
              <span class="material-icons-outlined text-base text-slate-400 print:hidden">person</span> ${l['è­·ç†å¸«']||'--'}
            </div>
          </div>
        </div>

        <div class="soap-grid-container grid grid-cols-1 md:grid-cols-2 gap-2 text-sm print:gap-2">
          <div class="bg-blue-50/40 p-2.5 rounded-xl border border-blue-50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-1 text-blue-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">S</span> ä¸»è¨´</div>
             <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['S_ä¸»è¨´']||'--'}</div>
          </div>
          <div class="bg-indigo-50/40 p-2.5 rounded-xl border border-indigo-50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-1 text-indigo-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">O</span> æª¢æŸ¥</div>
             <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['O_å®¢è§€æª¢æŸ¥']||'--'}</div>
          </div>
          <div class="bg-amber-50/40 p-2.5 rounded-xl border border-amber-50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-1 text-amber-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-amber-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">A</span> è¨ºæ–·</div>
             <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['A_è¨ºæ–·']||'--'}</div>
          </div>
          <div class="bg-emerald-50/40 p-2.5 rounded-xl border border-emerald-50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-1 text-emerald-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">P</span> è¨ˆç•«</div>
             <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['P_æ²»ç™‚è¨ˆåŠƒ']||'--'}</div>
          </div>

          ${l['è­·ç†ç´€éŒ„'] && l['è­·ç†ç´€éŒ„']!=='--' ? `
          <div class="md:col-span-2 bg-rose-50/40 p-2.5 rounded-xl border border-rose-50 print:bg-white print:border-slate-300 print:p-2">
              <div class="flex items-center gap-2 mb-1 text-rose-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-rose-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">N</span> è­·ç†ç´€éŒ„</div>
              <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['è­·ç†ç´€éŒ„']}</div>
          </div>` : ''}

          ${l['å‚™è¨»'] && l['å‚™è¨»']!=='--' ? `
          <div class="md:col-span-2 bg-slate-50 p-2.5 rounded-2xl text-xs text-slate-500 border border-slate-100 flex gap-2 print:bg-white print:border-slate-300 print:p-2">
              <span class="font-bold shrink-0 print:text-black">Note:</span><span class="print:text-black">${l['å‚™è¨»']}</span>
          </div>` : ''}
        </div>
      </div>`;
    }).join('');
  }).getClientHistory(currentClient['å€‹æ¡ˆç·¨è™Ÿ'], 'Doctor_Consultation');
}

// ==========================================
// å€‹æ¡ˆç¸½è¦½ (å·²ä¿®å¾©æ—¥æœŸç¯©é¸)
// ==========================================

/**
 * è¼‰å…¥å€‹æ¡ˆç¸½è¦½è³‡æ–™ (å¾Œç«¯ -> å‰ç«¯)
 */
function loadOverviewData() {
  const container = document.getElementById('overviewListContainer'); 
  container.innerHTML = '<div class="text-center py-12 text-slate-400 flex flex-col items-center gap-2"><span class="material-icons-outlined animate-spin-reverse">sync</span><span>è®€å–å€‹æ¡ˆæ­·ç¨‹ä¸­...</span></div>';
  
  google.script.run.withSuccessHandler(data => {
      // 1. å„²å­˜åŸå§‹è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸
      allOverviewRecords = data || [];
      // 2. åŒæ­¥æ›´æ–°æ—¥æ›†äº‹ä»¶é»
      allCalendarEvents = data || [];
      // 3. æ¸²æŸ“åˆ—è¡¨ (åˆå§‹é¡¯ç¤ºå…¨éƒ¨)
      renderOverviewList();
  }).withFailureHandler(err => { 
      container.innerHTML = `<div class="text-red-500 text-center py-10">è¼‰å…¥å¤±æ•—: ${err.message}</div>`; 
  }).getCaseOverviewData(currentClient['å€‹æ¡ˆç·¨è™Ÿ']);
}

/**
 * åˆ‡æ›é¡åˆ¥æŒ‰éˆ•æ™‚å‘¼å«
 */
function setOverviewCategory(cat) {
  currentOverviewCategory = cat;

  // æ›´æ–°æŒ‰éˆ•æ¨£å¼
  document.querySelectorAll('[id^="filter-btn-"]').forEach(btn => {
     if(btn.id === 'filter-btn-' + cat) {
         btn.classList.remove('bg-white', 'text-slate-800', 'text-slate-500', 'hover:bg-white', 'hover:text-slate-700', 'shadow-sm', 'ring-1', 'ring-slate-200');
         btn.classList.add('bg-slate-800', 'text-white', 'shadow-md');
     } else {
         btn.classList.remove('bg-slate-800', 'text-white', 'shadow-md');
         btn.classList.add('bg-white', 'text-slate-500', 'hover:bg-white', 'hover:text-slate-700');
     }
  });

  // é‡æ–°æ¸²æŸ“ (æœƒè‡ªå‹•å¥—ç”¨ getFilteredOverviewData çš„ç¯©é¸)
  renderOverviewList();
}

/**
 * æ ¸å¿ƒç¯©é¸é‚è¼¯ï¼šçµåˆã€Œé¡åˆ¥ã€èˆ‡ã€Œæ—¥æœŸç¯„åœã€
 * å°æ‡‰å•é¡ŒäºŒï¼šä¿®å¾©æ—¥æœŸç¯©é¸
 */
function getFilteredOverviewData() {
  let data = allOverviewRecords; 

  // 1. é¡åˆ¥ç¯©é¸
  if (currentOverviewCategory !== 'all') {
      data = data.filter(i => i.category === currentOverviewCategory);
  }

  // 2. æ—¥æœŸç¯©é¸ (input value æ ¼å¼ç‚º YYYY-MM-DD)
  const sStr = document.getElementById('overviewStartDate').value;
  const eStr = document.getElementById('overviewEndDate').value;

  if(sStr || eStr) {
      data = data.filter(i => {
          // i.date æ ¼å¼ä¹Ÿæ˜¯ YYYY-MM-DD å­—ä¸²
          if (sStr && i.date < sStr) return false;
          if (eStr && i.date > eStr) return false;
          return true;
      });
  }
  return data;
}

/**
 * ä»‹é¢è§¸ç™¼é»ï¼šç•¶æ—¥æœŸæ”¹è®Šæ™‚å‘¼å«æ­¤å‡½å¼ (å·²ç¶å®šåœ¨ setupEnhancedFlatpickr)
 */
function filterOverviewTable() {
    renderOverviewList();
}

function renderOverviewList() {
  const c = document.getElementById('overviewListContainer');
  const printTable = document.getElementById('overviewPrintTable');
  const f = getFilteredOverviewData(); // â˜… å‘¼å«æ–°çš„ç¯©é¸é‚è¼¯

  document.getElementById('overviewStats').textContent = `å…± ${f.length} ç­†ç´€éŒ„`;

  if (!f.length) {
    c.innerHTML = `<div class="flex flex-col items-center justify-center py-24 bg-white rounded-[2.5rem] border border-slate-100"><div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-300"><span class="material-icons-outlined text-3xl">search_off</span></div><p class="text-slate-400 font-bold">ç„¡ç¬¦åˆè³‡æ–™</p></div>`;
    printTable.innerHTML = `<p style="text-align:center; padding: 20px;">ç„¡ç¬¦åˆè³‡æ–™</p>`;
    return;
  }

  c.innerHTML = f.map((i, index) => {
    const cardClass = `print:break-before-page ${index === 0 ? '' : 'print:break-before-page'} bg-white border border-slate-100 rounded-[2rem] p-5 shadow-sm mb-4 card-hover relative overflow-hidden group print:hidden`;
    const headerClass = "flex justify-between items-center mb-3 pb-2 border-b border-slate-50 pl-3";
    const badgeClass = "text-xs font-bold px-3 py-1 rounded-full font-mono";

    if (i.category === 'doctor') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-500 opacity-80"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-blue-50 text-blue-600">${formatYmd(i.date)}</span>
                  <span class="text-sm font-black text-slate-700">é†«å¸«çœ‹è¨º</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-3">
                  <div class="flex items-center gap-1"><span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.doctor||'--'}</div>
                  <div class="flex items-center gap-1"><span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.nurse||'--'}</div>
              </div>
          </div>
          <div class="pl-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm mb-2">
              <div class="bg-blue-50/40 p-2.5 rounded-xl border border-blue-50"><span class="text-blue-600 font-black text-xs mr-1">S</span> <span class="text-slate-700 leading-snug">${i.s||'--'}</span></div>
              <div class="bg-indigo-50/40 p-2.5 rounded-xl border border-indigo-50"><span class="text-indigo-600 font-black text-xs mr-1">O</span> <span class="text-slate-700 leading-snug">${i.o||'--'}</span></div>
              <div class="bg-amber-50/40 p-2.5 rounded-xl border border-amber-50"><span class="text-amber-600 font-black text-xs mr-1">A</span> <span class="text-slate-700 leading-snug">${i.a||'--'}</span></div>
              <div class="bg-emerald-50/40 p-2.5 rounded-xl border border-emerald-50"><span class="text-emerald-600 font-black text-xs mr-1">P</span> <span class="text-slate-700 leading-snug">${i.p||'--'}</span></div>
          </div>
          <div class="pl-3 space-y-2">
              ${i.nursingRecord && i.nursingRecord !== '--' ? `<div class="bg-rose-50/50 p-3 rounded-xl text-sm border border-rose-100"><div class="flex items-center gap-1.5 mb-1 text-rose-600 font-black text-xs"><span class="material-icons-outlined text-[14px]">favorite</span> è­·ç†ç´€éŒ„</div><div class="text-slate-600 leading-snug whitespace-pre-wrap pl-1">${i.nursingRecord}</div></div>` : ''}
              ${i.remark && i.remark !== '--' ? `<div class="bg-slate-50 p-2.5 rounded-xl text-xs text-slate-500 border border-slate-100 flex gap-2 items-start"><span class="font-bold shrink-0 bg-slate-200 px-1.5 rounded text-[10px] text-slate-600">Note</span><span class="leading-snug">${i.remark}</span></div>` : ''}
          </div>
      </div>`;
    }
    else if (i.category === 'treatment') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-500 opacity-80"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-emerald-50 text-emerald-600">${formatYmd(i.date)}</span>
                  <span class="text-sm font-black text-slate-700">ç‰©ç†æ²»ç™‚</span>
                  ${i.item ? `<span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded border border-slate-200">${i.item}</span>` : ''}
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1">
                  <span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 space-y-3">
              ${i.complaint ? `<div><div class="text-[10px] font-bold text-slate-400 mb-1">ç•¶æ—¥ä¸»è¨´</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${i.complaint}</div></div>` : ''}
              <div><div class="text-[10px] font-bold text-slate-400 mb-1">æ²»ç™‚å…§å®¹</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${i.content}</div></div>
              ${i.nextPlan ? `<div class="bg-amber-50 p-2.5 rounded-xl border border-amber-100"><div class="text-[10px] font-bold text-amber-500 uppercase tracking-wider mb-1 flex items-center gap-1"><span class="material-icons-outlined text-[10px]">flag</span> å‚™è¨» / ä¸‹æ¬¡æ²»ç™‚</div><div class="text-xs text-slate-600 whitespace-pre-wrap leading-snug">${i.nextPlan}</div></div>` : ''}
          </div>
      </div>`;
    }
    else if (i.category === 'maintenance') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-orange-400 opacity-80"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-orange-50 text-orange-600">${formatYmd(i.date)}</span>
                  <span class="text-sm font-black text-slate-700">${i.item||'ä¿é¤Š'}</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1">
                  <span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 grid grid-cols-5 gap-2 mb-2">
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center"><span class="text-[9px] font-bold text-slate-400">Temp</span><span class="text-xs font-black text-slate-700">${i.temp||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center"><span class="text-[9px] font-bold text-slate-400">HR</span><span class="text-xs font-black text-slate-700">${i.hr||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center"><span class="text-[9px] font-bold text-slate-400">RR</span><span class="text-xs font-black text-slate-700">${i.rr||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center"><span class="text-[9px] font-bold text-slate-400">BP</span><span class="text-xs font-black text-slate-700">${i.bp||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center"><span class="text-[9px] font-bold text-slate-400">SpO2</span><span class="text-xs font-black text-slate-700">${i.spo2||'-'}</span></div>
          </div>
          ${i.remark && i.remark !== '--' ? `<div class="pl-3 mt-2"><div class="text-xs text-slate-600 bg-orange-50/50 p-2.5 rounded-xl border border-orange-100 flex gap-2 items-start"><span class="font-bold text-orange-400 shrink-0 text-[10px] pt-0.5">NOTE</span><span class="leading-snug">${i.remark}</span></div></div>` : ''}
      </div>`;
    }
    else if (i.category === 'tracking') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-violet-500 opacity-80"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-violet-50 text-violet-600">${formatYmd(i.date)}</span>
                  <span class="text-xs font-bold text-white bg-violet-400 px-2 py-0.5 rounded-md">${i.type||'è¿½è¹¤'}</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1">
                  <span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 text-sm text-slate-700 leading-relaxed whitespace-pre-line">${i.content}</div>
      </div>`;
    }
    return '';
  }).join('');

  // --- åˆ—å°è¡¨æ ¼ç”Ÿæˆ (ä¿æŒä¸è®Š) ---
  const catName = { 'all': 'å…¨éƒ¨', 'doctor': 'é†«å¸«çœ‹è¨º', 'treatment': 'ç‰©ç†æ²»ç™‚', 'maintenance': 'ä¿é¤Šé …ç›®', 'tracking': 'å€‹ç®¡è¿½è¹¤' };
  const clientName = currentClient ? currentClient['å§“å'] : ''; 

  let tableHtml = `
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; border-bottom: 2px solid #000; padding-bottom: 5px;">
        <div style="flex: 1;"></div> 
        <div style="flex: 0 0 auto; text-align: center; font-size: 24px; font-weight: bold; letter-spacing: 2px;">åº·é£›é‹é†« ç‰©ç†æ²»ç™‚æ‰€</div>
        <div style="flex: 1; text-align: right; font-size: 16px; font-weight: bold;">${clientName}</div>
    </div>
    <div style="margin-bottom: 10px; font-weight: bold; font-size: 12px; border-bottom: 1px solid #000; padding-bottom: 5px;">
        åˆ—å°æ—¥æœŸï¼š${new Date().toISOString().split('T')[0]} ï½œ ç¯©é¸æ¢ä»¶ï¼š${catName[currentOverviewCategory] || 'å…¨éƒ¨'} ï½œ è³‡æ–™ç­†æ•¸ï¼š${f.length}
    </div>
    <table class="print-table" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 1px solid #000;">
                <th width="12%" style="padding: 8px 0; text-align: left;">æ—¥æœŸ</th>
                <th width="10%" style="padding: 8px 0; text-align: left;">é¡åˆ¥</th>
                <th width="65%" style="padding: 8px 0; text-align: left;">å…§å®¹æ‘˜è¦</th>
                <th width="13%" style="padding: 8px 0; text-align: left;">åŸ·è¡Œäººå“¡</th>
            </tr>
        </thead>
        <tbody>`;

  f.forEach((i, index) => {
    const isPageBreakNeeded = (currentOverviewCategory === 'all' || currentOverviewCategory === 'treatment') && index > 0;
    const rowStyle = isPageBreakNeeded ? 'style="page-break-before: always; border-top: 1px solid #000; padding-top: 10px;"' : 'style="border-top: 1px solid #000; padding-top: 10px;"';

    let typeName = '';
    let content = '';

    if (i.category === 'doctor') {
       typeName = 'é†«å¸«çœ‹è¨º';
       content = `
       <b>[S]</b> ${i.s||'-'}<br>
       <b>[O]</b> ${i.o||'-'}<br>
       <b>[A]</b> ${i.a||'-'}<br>
       <b>[P]</b> ${i.p||'-'}`;
       if(i.nursingRecord && i.nursingRecord!=='--') content += `<br><b>[è­·ç†]</b> ${i.nursingRecord}`;
       if(i.remark && i.remark!=='--') content += `<br><b>[å‚™è¨»]</b> ${i.remark}`;
    }
    else if (i.category === 'treatment') {
       typeName = 'ç‰©ç†æ²»ç™‚';
       if(i.item) typeName += `<br><small>(${i.item})</small>`;
       if(i.complaint) content += `<b>[ä¸»è¨´]</b> ${i.complaint}<br>`;
       content += `${i.content}`;
       if(i.nextPlan) content += `<br><b>[å‚™è¨»]</b> ${i.nextPlan}`;
    }
    else if (i.category === 'maintenance') {
       typeName = 'ä¿é¤Šé …ç›®';
       if(i.item) typeName += `<br><small>(${i.item})</small>`;
       content = `T: ${i.temp||'-'} / HR: ${i.hr||'-'} / RR: ${i.rr||'-'} / BP: ${i.bp||'-'} / SpO2: ${i.spo2||'-'}`;
       if(i.remark && i.remark!=='--') content += `<br><b>[å‚™è¨»]</b> ${i.remark}`;
    }
    else if (i.category === 'tracking') {
       typeName = 'å€‹ç®¡è¿½è¹¤';
       if(i.type) typeName += `<br><small>(${i.type})</small>`;
       content = i.content;
    }

    tableHtml += `
      <tr ${rowStyle}>
          <td style="padding: 8px 0;">${formatYmd(i.date)}</td>
          <td style="padding: 8px 0;">${typeName}</td>
          <td style="padding: 8px 0;">${content}</td>
          <td style="padding: 8px 0;">${i.staff||i.doctor||'--'}</td>
      </tr>`;
  });

  tableHtml += `</tbody></table>`;
  printTable.innerHTML = tableHtml;
}

function printOverviewReport() { handlePrint(); }

// ==========================================
// å½±åƒè¼‰å…¥èˆ‡ä¸Šå‚³é‚è¼¯
// ==========================================

function loadClientImages() {
  const container = document.getElementById('imageGalleryContainer');
  const countText = document.getElementById('img-stats-text');

  container.innerHTML = '<div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-300"><span class="material-icons-outlined text-4xl animate-spin-reverse mb-3">sync</span><p>è®€å–å½±åƒä¸­...</p></div>';
  if(countText) countText.textContent = 'è®€å–ä¸­...';

  const clientId = currentClient['å€‹æ¡ˆç·¨è™Ÿ'];

  google.script.run.withSuccessHandler(function(res) {
     if (!res.success) {
        container.innerHTML = '<div class="col-span-full text-center py-10 text-red-400">è®€å–å¤±æ•—: ' + res.message + '</div>';
        return;
     }

     const images = res.images;
     if (countText) countText.textContent = 'å…± ' + images.length + ' å¼µå½±åƒç´€éŒ„';

     if (images.length === 0) {
        container.innerHTML = `
          <div class="col-span-full flex flex-col items-center justify-center py-24 bg-white rounded-[2.5rem] border border-slate-100">
              <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-300">
                  <span class="material-icons-outlined text-3xl">broken_image</span>
              </div>
              <p class="text-slate-400 font-bold">ç„¡å½±åƒè³‡æ–™</p>
              <p class="text-xs text-slate-300 mt-1">è«‹ç¢ºèªé›²ç«¯è³‡æ–™å¤¾æ˜¯å¦å·²æœ‰æª”æ¡ˆ</p>
          </div>`;
        return;
     }

     container.innerHTML = images.map(img => `
        <div class="group relative bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden aspect-square cursor-pointer hover:shadow-md transition-all" onclick="openLightbox('${img.id}', '${img.name}')">
            <img src="${img.thumbnail}" alt="${img.name}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                <p class="text-white font-bold text-sm truncate">${img.name}</p>
                <p class="text-white/80 text-xs font-mono">${img.date}</p>
            </div>
        </div>
     `).join('');

  }).getClientImages(clientId);
}

function previewFiles(input) {
  const container = document.getElementById('previewList');
  const previewArea = document.getElementById('uploadPreviewArea');

  filesToUpload = Array.from(input.files);
  container.innerHTML = '';

  if (filesToUpload.length > 0) {
    previewArea.classList.remove('hidden');
    filesToUpload.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const div = document.createElement('div');
        div.className = "flex items-center gap-3 p-2 bg-slate-50 rounded-xl border border-slate-100";
        div.innerHTML = `
          <div class="w-10 h-10 rounded-lg overflow-hidden bg-white shrink-0">
             <img src="${e.target.result}" class="w-full h-full object-cover">
          </div>
          <div class="flex-1 min-w-0">
             <p class="text-xs font-bold text-slate-700 truncate">${file.name}</p>
             <p class="text-[10px] text-slate-400">${(file.size/1024).toFixed(1)} KB</p>
          </div>`;
        container.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  } else {
    previewArea.classList.add('hidden');
  }
}

function startUpload() {
  if (filesToUpload.length === 0) {
      showNotification('æç¤º', 'è«‹å…ˆé¸æ“‡æª”æ¡ˆ', 'info');
      return;
  }
  const btn = document.getElementById('btnStartUpload');
  const originalText = btn.innerHTML;
  const remark = document.getElementById('fileRemark').value;

  btn.disabled = true;
  btn.innerHTML = '<span class="material-icons-outlined animate-spin-reverse mr-2">sync</span>ä¸Šå‚³ä¸­...';

  let successCount = 0;

  const processNext = (idx) => {
      if (idx >= filesToUpload.length) {
         showNotification('ä¸Šå‚³å®Œæˆ', 'æˆåŠŸ ' + successCount + ' / ' + filesToUpload.length, 'success');
         btn.disabled = false;
         btn.innerHTML = originalText;
         closeModal('uploadImageModal');
         document.getElementById('uploadInput').value = '';
         document.getElementById('fileRemark').value = '';
         document.getElementById('previewList').innerHTML = '';
         document.getElementById('uploadPreviewArea').classList.add('hidden');
         filesToUpload = [];
         loadClientImages();
         return;
      }

      const file = filesToUpload[idx];
      const reader = new FileReader();
      reader.onload = function(e) {
          const content = e.target.result.split(',')[1];
          google.script.run.withSuccessHandler(res => {
             if(res.success) successCount++;
             processNext(idx + 1);
          }).withSuccessHandler(err => {
             // ä¸Šå‚³å¤±æ•—æ™‚ï¼Œä¹Ÿç®—è™•ç†å®Œï¼Œç¹¼çºŒä¸‹ä¸€å€‹ï¼Œä½†è¦è¨˜éŒ„å¤±æ•— (é€™è£¡ç°¡å–®è™•ç†)
             console.error(err);
             processNext(idx + 1);
          }).uploadClientImage(currentClient['å€‹æ¡ˆç·¨è™Ÿ'], content, file.name, file.type, remark);
      };
      reader.readAsDataURL(file);
  };

  processNext(0);
}

function openUploadModal() {
  if (!currentClient) {
      showNotification('æç¤º', 'è«‹å…ˆé¸å–å€‹æ¡ˆ', 'info');
      return;
  }
  document.getElementById('uploadInput').value = '';
  document.getElementById('fileRemark').value = '';
  document.getElementById('previewList').innerHTML = '';
  document.getElementById('uploadPreviewArea').classList.add('hidden');
  filesToUpload = [];
  openModal('uploadImageModal');
}

// ==========================================
// å·¥å…·å‡½å¼
// ==========================================
function resetSearch() { currentClient = null; document.getElementById('topBarClientInfo').classList.add('hidden'); navTo('search'); }

function closeModal(id) { 
  document.getElementById(id).classList.add('hidden'); 
  if (id === 'addClientModal') {
    resetAddClientModalUI();
  }
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  if (sidebar) {
    sidebar.classList.toggle('hidden');
  }
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }

function closeNotification() {
  const modal = document.getElementById('custom-modal');
  if (modal) modal.classList.add('hidden');
}

// ==========================================
// Lightbox
// ==========================================
function openLightbox(id, name) {
    const modal = document.getElementById('imageLightbox');
    const img = document.getElementById('lightboxImage');
    const loading = document.getElementById('lightboxLoading');
    const titleDiv = document.getElementById('lightboxTitle');
    if (!modal || !img) return;
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    img.style.opacity = '0';
    img.style.transform = 'scale(0.95)';
    img.src = "";
    if (titleDiv) titleDiv.textContent = name || '';
    const highResUrl = `https://lh3.googleusercontent.com/d/${id}=s0`;
    img.onload = function() {
        loading.classList.add('hidden');
        img.style.opacity = '1';
        img.style.transform = 'scale(1)';
    };
    img.src = highResUrl;
    document.body.style.overflow = 'hidden';
}
function closeLightbox() {
    const modal = document.getElementById('imageLightbox');
    if (modal) modal.classList.add('hidden');
    const img = document.getElementById('lightboxImage');
    if (img) img.src = '';
    document.body.style.overflow = '';
}
document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") closeLightbox();
});

// ==========================================
// å›åˆ°é ‚éƒ¨æŒ‰éˆ•é‚è¼¯ (é‡å° contentArea æ»¾å‹•ç›£è½)
// ==========================================
document.addEventListener("DOMContentLoaded", function() {
  const contentArea = document.getElementById('contentArea');
  const btn = document.getElementById('btnBackToTop');
  
  if (contentArea && btn) {
    // ç›£è½å…§å®¹å€å¡Šçš„æ»¾å‹•äº‹ä»¶
    contentArea.addEventListener('scroll', function() {
      // ç•¶å¾€ä¸‹æ»¾å‹•è¶…é 300px æ™‚é¡¯ç¤ºæŒ‰éˆ•
      if (contentArea.scrollTop > 300) {
        btn.classList.remove('hidden');
        // åŠ å…¥ä¸€å€‹ç°¡å–®çš„æ·¡å…¥æ•ˆæœ (Optional, åˆ©ç”¨ Tailwind class)
        btn.classList.add('opacity-100');
        btn.classList.remove('opacity-0');
      } else {
        btn.classList.add('hidden');
        btn.classList.add('opacity-0');
        btn.classList.remove('opacity-100');
      }
    });
  }
});

function scrollToTop() {
  const contentArea = document.getElementById('contentArea');
  if (contentArea) {
    contentArea.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }
}

// ==========================================
// è‡ªè¨‚é€šçŸ¥ UI
// ==========================================
function showNotification(title, message, type = 'info') {
  const modal = document.getElementById('custom-modal');
  const titleEl = document.getElementById('modal-title');
  const msgEl = document.getElementById('modal-message');
  const iconEl = document.getElementById('modal-icon');
  const iconContainer = document.getElementById('modal-icon-container');
  const btn = document.getElementById('modal-confirm-btn');

  if (!modal) return;

  titleEl.innerText = title;
  msgEl.innerText = message;

  iconContainer.className = 'mx-auto flex items-center justify-center w-16 h-16 rounded-full mb-2';
  btn.className = 'w-full py-3.5 px-4 font-bold rounded-2xl shadow-lg transition-all active:scale-95 text-white';

  if (type === 'success') {
      iconEl.innerText = 'check_circle';
      iconEl.className = 'material-icons-outlined text-3xl text-emerald-600';
      iconContainer.classList.add('bg-emerald-100');
      btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600', 'shadow-emerald-500/20');
  } else if (type === 'error') {
      iconEl.innerText = 'error';
      iconEl.className = 'material-icons-outlined text-3xl text-rose-600';
      iconContainer.classList.add('bg-rose-100');
      btn.classList.add('bg-rose-500', 'hover:bg-rose-600', 'shadow-rose-500/20');
  } else if (type === 'warning') {
      iconEl.innerText = 'warning';
      iconEl.className = 'material-icons-outlined text-3xl text-amber-600';
      iconContainer.classList.add('bg-amber-100');
      btn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'shadow-amber-500/20');
  } else {
      iconEl.innerText = 'info';
      iconEl.className = 'material-icons-outlined text-3xl text-slate-500';
      iconContainer.classList.add('bg-slate-100');
      btn.classList.add('bg-slate-700', 'hover:bg-slate-800', 'shadow-slate-500/20');
  }

  modal.classList.remove('hidden');
}
</script>