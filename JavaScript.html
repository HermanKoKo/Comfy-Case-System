<script>
// ==========================================
// 全域變數宣告
// ==========================================
let currentClient = null;
let allTreatmentLogs = [];
let allOverviewRecords = []; 
let currentOverviewCategory = 'all'; 
let filesToUpload = []; 
let searchTimer = null;
let allCalendarEvents = []; // 仍保留此變數以支援 Flatpickr 的彩色點點功能

// ==========================================
// 初始化與 UI 設定
// ==========================================

function setupEnhancedFlatpickr(selector, options = {}) {
  const defaults = {
    locale: "zh_tw", dateFormat: "Y-m-d", disableMobile: true, allowInput: true, static: true,
    // 移除原本複雜的自製 header 邏輯，改回 Flatpickr 原生或簡單設定
    
    // ★★★ 根據 allCalendarEvents 動態加入彩色圓點 ★★★
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      if (!dayElem || !dayElem.dateObj) return;
      const dateKey = dayElem.dateObj.toISOString().split('T')[0];
      
      // 找出這一天所有的事件
      const dayEvents = allCalendarEvents.filter(e => e.date === dateKey);
      
      if (dayEvents.length > 0) {
        // 建立點點容器
        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'dots-container';
        
        // 檢查有哪些類別，避免重複顯示同一種顏色的點
        const categories = [...new Set(dayEvents.map(e => e.category))];
        
        categories.forEach(cat => {
          const dot = document.createElement('div');
          dot.className = 'cal-dot';
          // 根據類別加上對應的顏色 class
          if (cat === 'treatment') dot.classList.add('dot-treatment');
          else if (cat === 'maintenance') dot.classList.add('dot-maintenance');
          else if (cat === 'doctor') dot.classList.add('dot-doctor');
          else if (cat === 'tracking') dot.classList.add('dot-tracking');
          
          dotsContainer.appendChild(dot);
        });
        
        dayElem.appendChild(dotsContainer);
      }
    }
  };
  return flatpickr(selector, { ...defaults, ...options });
}

// 頁面載入完成後執行
window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('#treatmentDate, #maintenanceDate, #doctorConsultDate, #trackDate').forEach(el => el.value = today);
  
  // 初始化所有日期選擇器
  setupEnhancedFlatpickr('input[type="date"], #trackDate');
  
  const overviewConfig = { onChange: function() { renderOverviewList(); } };
  setupEnhancedFlatpickr('#overviewStartDate', overviewConfig);
  setupEnhancedFlatpickr('#overviewEndDate', overviewConfig);
  
  loadSystemStaff();
};

function loadSystemStaff() {
  if (typeof google === 'undefined' || !google.script) return;
  google.script.run.withSuccessHandler(staff => {
    const setOptions = (id, list, placeholder) => {
      const el = document.getElementById(id);
      if(el) { el.innerHTML = `<option value="" disabled selected>${placeholder}</option>` + list.map(n => `<option value="${n}">${n}</option>`).join(''); }
    };
    setOptions('selectDoctor', staff.doctors, '請選擇醫師');
    setOptions('selectNurse', staff.nurses, '請選擇護理師');
    setOptions('inputTherapist', staff.therapists, '請選擇治療師');
    setOptions('selectMaintStaff', staff.allStaff, '請選擇執行人員');
    setOptions('selectMaintItem', staff.maintItems, '請選擇項目');
    setOptions('trackStaff', staff.allStaff, '請選擇人員');
    setOptions('trackType', staff.trackingTypes || [], '請選擇項目');
    
    // 已移除 filterTherapist，無需設定選項
  }).getSystemStaff();
}

// ==========================================
// 導覽與頁面切換
// ==========================================
function navTo(viewName) {
  if (!currentClient && viewName !== 'search') { alert("請先選取個案。"); return; }
  
  const views = ['search', 'basic', 'images', 'treatment', 'maintenance', 'doctor', 'tracking', 'overview'];
  views.forEach(v => {
    document.getElementById('view-' + v)?.classList.add('hidden');
    document.getElementById('btn-' + v)?.classList.remove('active');
  });
  const target = document.getElementById('view-' + viewName);
  if(target) {
    target.classList.remove('hidden');
    target.classList.add('view-animate'); 
  }
  document.getElementById('btn-' + viewName)?.classList.add('active');
  
  const titles = { 'search':'首頁','basic':'基本資料','images':'影像總覽','treatment':'治療紀錄','maintenance':'保養項目','doctor':'醫師看診','tracking':'個管追蹤','overview':'個案總覽' };
  document.getElementById('pageTitle').textContent = titles[viewName] || '康飛運醫';
  
  if (currentClient) {
    // 進入有紀錄的頁面時，若尚未載入總覽資料，則背景載入一次，確保日期選擇器有彩色點點
    if (['treatment', 'maintenance', 'doctor', 'tracking', 'overview'].includes(viewName)) {
        if (allCalendarEvents.length === 0) {
            fetchCalendarData(); // 背景載入所有資料
        }
    }

    if(viewName === 'basic') renderBasicInfo();
    if(viewName === 'doctor') loadDoctorHistory();
    if(viewName === 'treatment') loadTreatmentHistory();
    if(viewName === 'maintenance') loadMaintenanceHistory();
    if(viewName === 'tracking') loadTrackingHistory();
    if(viewName === 'overview') loadOverviewData(); 
    if(viewName === 'images') loadClientImages();
  }
}

// 背景載入所有日曆資料 (用於在 Flatpickr 上顯示點點)
function fetchCalendarData() {
    google.script.run.withSuccessHandler(data => {
        allCalendarEvents = data || [];
        // 資料載入後，若要即時更新已開啟的 Flatpickr 點點，可能需要 redraw，但這裡從簡，下次開啟即生效
    }).getCaseOverviewData(currentClient['個案編號']);
}

// ==========================================
// 新增個案相關函式
// ==========================================
function autoDetectGender(input) {
  const val = input.value.toUpperCase();
  input.value = val; 
  if (val.length >= 2) {
    const secondChar = val.charAt(1);
    if (secondChar === '1') { } else if (secondChar === '2') { }
  }
}

function submitNewClient() {
  const btn = document.getElementById('btnSubmitClient');
  const originalText = btn.innerHTML;
  
  const data = {
    name: document.getElementById('addName').value.trim(),
    dob: document.getElementById('addDob').value.trim(),
    idNo: document.getElementById('addIdNo').value.trim(),
    phone: document.getElementById('addPhone').value.trim(),
    gender: '', 
    emerName: document.getElementById('addEmerName').value.trim(),
    emerPhone: document.getElementById('addEmerPhone').value.trim(),
    chronic: document.getElementById('addChronic').value.trim()
  };

  if (!data.name || !data.dob || !data.idNo || !data.phone) { alert("請填寫所有必填欄位 (*)！"); return; }
  if (data.idNo.length < 2) { alert("身分證字號格式錯誤"); return; }
  
  const secondChar = data.idNo.charAt(1);
  if (secondChar === '1') data.gender = '男';
  else if (secondChar === '2') data.gender = '女';
  else data.gender = '其他';

  btn.disabled = true;
  btn.innerHTML = '<span class="material-icons-outlined animate-spin">sync</span> 建立中...';

  google.script.run
    .withSuccessHandler(function(res) {
      btn.disabled = false;
      btn.innerHTML = originalText;
      if (res.success) { alert("個案建立成功！"); document.getElementById('addClientForm').reset(); closeModal('addClientModal'); selectClient(res.fullData); } 
      else { alert("建立失敗：" + res.message); }
    })
    .withFailureHandler(function(e) { btn.disabled = false; btn.innerHTML = originalText; alert("系統錯誤：" + e.message); })
    .createNewClient(data);
}

// ==========================================
// 列印功能
// ==========================================
function handlePrint() {
  const today = new Date();
  const dateStr = today.getFullYear() + "-" + 
                  String(today.getMonth() + 1).padStart(2, '0') + "-" + 
                  String(today.getDate()).padStart(2, '0');
  const dateEl = document.getElementById('print-date-display');
  if(dateEl) dateEl.innerText = dateStr;
  const infoEl = document.getElementById('print-patient-info');
  if (infoEl) {
      if (currentClient) { infoEl.innerText = `${currentClient['姓名']} - ${currentClient['生日']}`; } 
      else { infoEl.innerText = "個案列表"; }
  }
  window.print();
}

// ==========================================
// 基本資料渲染
// ==========================================
function renderBasicInfo() {
  if(!currentClient) return;
  const fieldMap = {
    'display-client-id': '個案編號',
    'display-name': '姓名',
    'display-gender': '性別',
    'display-birthday': '生日',
    'display-id-number': '身分證字號',
    'display-phone': '電話',
    'display-emergency-name': '緊急聯絡人',
    'display-emergency-phone': '緊急聯絡人電話',
    'display-notes': '慢性病或特殊疾病'
  };
  for (const [domId, dbKey] of Object.entries(fieldMap)) {
    const el = document.getElementById(domId);
    if(el) {
       if(domId === 'display-notes' && (!currentClient[dbKey] || currentClient[dbKey] === '')) continue;
       el.textContent = currentClient[dbKey] || '--';
    }
  }
  const statusEl = document.getElementById('display-status');
  if(statusEl && currentClient['狀態']) statusEl.textContent = currentClient['狀態'];
}

// ==========================================
// 搜尋功能
// ==========================================
function handleSearchDebounced(val) {
  const kw = val.trim();
  const container = document.getElementById('searchResults');
  if (searchTimer) clearTimeout(searchTimer);
  if (!kw) { container.innerHTML = ''; return; }
  searchTimer = setTimeout(() => { handleSearch(kw); }, 400); 
}

function handleSearch(keyword) {
  const kw = keyword || document.getElementById('searchInput').value.trim();
  if (!kw) return; 
  const container = document.getElementById('searchResults');
  container.innerHTML = '<div class="text-center py-8 text-slate-400 flex flex-col items-center gap-2"><span class="material-icons-outlined animate-spin">sync</span><span>搜尋中...</span></div>';
  
  google.script.run.withSuccessHandler(data => {
      container.innerHTML = '';
      if(data.length === 0) { container.innerHTML = '<div class="text-center py-6 text-slate-400 bg-white rounded-2xl border border-slate-100 shadow-sm">查無此個案資料</div>'; return; }
      
      data.forEach(c => {
        const div = document.createElement('div');
        div.className = "bg-white p-5 rounded-3xl shadow-sm border border-slate-100 hover:border-emerald-400 hover:shadow-md cursor-pointer transition-all flex justify-between items-center group mb-3 relative overflow-hidden";
        div.onclick = () => selectClient(c);
        div.innerHTML = `
          <div class="absolute left-0 top-0 bottom-0 w-1 bg-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity"></div>
          <div class="pl-2"> 
            <div class="font-black text-slate-800 text-lg flex items-center gap-2">
              ${c['姓名']} 
              <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100 flex items-center gap-1">
                <span class="material-icons-outlined text-[10px]">cake</span> ${c['生日']}
              </span>
            </div>
            <div class="text-sm text-slate-400 mt-1 flex items-center gap-1 font-mono">
              <span class="material-icons-outlined text-[14px]">phone</span> ${c['電話']}
            </div>
          </div>
          <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:bg-emerald-500 group-hover:text-white transition-all">
            <span class="material-icons-outlined">arrow_forward</span>
          </div>`;
        container.appendChild(div);
      });
  }).searchClient(kw);
}

function selectClient(c) {
  currentClient = c;
  // ★ 切換個案時，清空舊的日曆事件，並觸發重新載入
  allCalendarEvents = [];
  
  document.getElementById('topBarClientInfo').classList.remove('hidden');
  document.getElementById('headerClientName').textContent = c['姓名'];
  document.getElementById('headerClientDob').textContent = c['生日'];
  document.querySelectorAll('.auto-fill-id').forEach(el => el.value = c['個案編號']);
  navTo('basic');
}

// ==========================================
// 表單提交
// ==========================================
function submitForm(type) {
  if (!currentClient) { alert("系統錯誤：未選取個案，請重新搜尋。"); return; }
  
  const clientId = currentClient['個案編號'];
  const btn = type === 'tracking' ? document.querySelector('#trackingForm button[type="submit"]') : event.target;
  const ot = btn ? btn.innerHTML : "儲存"; 
  if(btn) { btn.disabled = true; btn.innerHTML = '<span class="material-icons-outlined animate-spin">sync</span> 儲存中...'; }
  
  // 儲存成功後的回調處理：重新載入日曆資料
  const onSuccess = (res, formId, reloadFunc) => {
      btn.disabled = false; 
      btn.innerHTML = ot;
      if (res.success) { 
          alert(res.message); 
          if(formId) document.getElementById(formId).reset(); 
          if(reloadFunc) reloadFunc(); 
          fetchCalendarData(); // ★ 重新抓取資料以更新月曆點點
      } else { 
          alert(res.message); 
      }
  };

  if (type === 'doctor') {
    const d = { 
      clientId: clientId,
      date: document.getElementById('doctorConsultDate').value, 
      doctor: document.getElementById('selectDoctor').value, 
      nurse: document.getElementById('selectNurse').value, 
      complaint: document.querySelector('#view-doctor textarea[name="主訴"]').value, 
      objective: document.querySelector('#view-doctor textarea[name="客觀檢查"]').value, 
      diagnosis: document.querySelector('#view-doctor textarea[name="診斷"]').value, 
      plan: document.querySelector('#view-doctor textarea[name="治療計畫"]').value, 
      nursingRecord: document.getElementById('nursingRecord').value, 
      remark: document.getElementById('doctorRemark').value 
    };
    if (!d.date || !d.doctor) { alert("請填寫日期與醫師"); if(btn){btn.disabled=false; btn.innerHTML=ot;} return; }
    google.script.run.withSuccessHandler(res => onSuccess(res, 'doctorForm', loadDoctorHistory)).saveDoctorConsultation(d);
  } else if (type === 'treatment') {
    const d = { 
      '個案編號': clientId,
      '治療日期': document.getElementById('treatmentDate').value, 
      '執行治療師': document.getElementById('inputTherapist').value, 
      '當日主訴': document.getElementById('inputComplaint').value, 
      '治療內容': document.getElementById('inputContent').value, 
      '備註/下次治療': document.getElementById('inputNextPlan').value 
    };
    if (!d['治療日期'] || !d['執行治療師']) { alert("請填寫日期與治療師"); if(btn){btn.disabled=false; btn.innerHTML=ot;} return; }
    google.script.run.withSuccessHandler(res => onSuccess(res, 'treatmentForm', loadTreatmentHistory)).saveData('Treatment_Logs', d);
  } else if (type === 'maintenance') {
    const f = document.getElementById('maintenanceForm');
    const d = { 
      clientId: clientId,
      date: document.getElementById('maintenanceDate').value, 
      staff: document.getElementById('selectMaintStaff').value, 
      item: document.getElementById('selectMaintItem').value, 
      bp: f.querySelector('input[name="血壓"]').value, 
      spo2: f.querySelector('input[name="血氧"]').value, 
      hr: f.querySelector('input[name="心律"]').value, 
      temp: f.querySelector('input[name="體溫"]').value, 
      remark: f.querySelector('textarea[name="備註"]').value 
    };
    if (!d.date || !d.staff || !d.item) { alert("請完整填寫必填欄位"); if(btn){btn.disabled=false; btn.innerHTML=ot;} return; }
    google.script.run.withSuccessHandler(res => onSuccess(res, 'maintenanceForm', loadMaintenanceHistory)).saveMaintenanceRecord(d);
  } else if (type === 'tracking') {
    const d = { 
      clientId: clientId,
      trackDate: document.getElementById('trackDate').value, 
      trackStaff: document.getElementById('trackStaff').value, 
      trackType: document.getElementById('trackType').value, 
      content: document.getElementById('trackContent').value 
    };
    if (!d.trackDate || !d.trackStaff || !d.trackType || !d.content) { alert("請完整填寫追蹤資料"); if(btn){btn.disabled=false; btn.innerHTML=ot;} return; }
    google.script.run.withSuccessHandler(res => { 
        document.getElementById('trackContent').value = ""; 
        onSuccess(res, null, loadTrackingHistory);
    }).saveTrackingRecord(d);
  }
}

// ==========================================
// 歷史列表載入與渲染
// ==========================================
function loadTrackingHistory() {
  const c = document.getElementById('trackingHistoryList'); c.innerHTML = '<div class="text-center py-6 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(recs => {
    if (!recs || !recs.length) { c.innerHTML = `<div class="text-center text-slate-400 py-12 bg-white rounded-[2rem] border border-slate-100"><span class="material-icons-outlined text-4xl mb-2 text-slate-300">history_edu</span><p>尚無任何追蹤紀錄</p></div>`; return; }
    c.innerHTML = recs.map(r => `
      <div class="bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-sm card-hover mb-4 relative overflow-hidden group print:break-inside-avoid print:mb-4 print:border print:border-slate-300">
        <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-violet-500 opacity-80 print:hidden"></div>
        <div class="pl-2">
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center gap-2">
              <span class="bg-violet-50 text-violet-700 text-xs font-bold px-3 py-1 rounded-full border border-violet-100 print:border-slate-300 print:text-black">${r.type}</span>
              <div class="text-slate-500 text-xs font-bold flex items-center bg-slate-50 px-2 py-1 rounded-lg print:bg-white">
                <span class="material-icons-outlined text-[14px] mr-1 text-slate-400 print:hidden">person</span>${r.staff||'--'}
              </div>
            </div>
            <span class="text-slate-400 text-xs font-mono print:text-black">${r.date}</span>
          </div>
          <div class="text-slate-700 text-sm leading-relaxed whitespace-pre-line bg-slate-50/50 p-3 rounded-xl print:bg-white print:p-0">${r.content}</div>
        </div>
      </div>`).join('');
  }).getTrackingHistory(currentClient['個案編號']);
}

function loadTreatmentHistory() {
  const c = document.getElementById('historyListContainer'); c.innerHTML = '<div class="text-center py-6 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(logs => { 
      allTreatmentLogs = logs || []; 
      renderTreatmentList(allTreatmentLogs); // ★ 修改：直接渲染列表，不再經過 filter
  }).getClientHistory(currentClient['個案編號'], 'Treatment_Logs');
}

function renderTreatmentList(logs) {
  const c = document.getElementById('historyListContainer');
  const countBadge = document.getElementById('treatmentHistoryCount');
  
  if(countBadge) {
     countBadge.textContent = `共 ${logs ? logs.length : 0} 次`;
  }

  if(!logs || !logs.length) { 
    c.innerHTML = '<div class="text-center py-10 text-slate-300 bg-slate-50 rounded-2xl">無相關紀錄</div>'; 
    return; 
  }
  
  c.innerHTML = logs.map(l => `
    <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 card-hover mb-4 relative overflow-hidden group print:break-inside-avoid print:mb-4 print:border print:border-slate-300">
      <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500 print:hidden"></div>
      <div class="flex justify-between items-center mb-3">
        <span class="text-xs font-bold text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded-lg print:bg-white print:text-black print:border print:border-slate-300">${l['治療日期']}</span>
        <div class="flex items-center gap-1 text-xs font-bold text-slate-500 print:text-black">
          <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span>${l['執行治療師']}
        </div>
      </div>
      <div class="space-y-3">
        <div class="text-xs text-slate-500 bg-slate-50 p-3 rounded-xl border border-slate-100 print:bg-white print:border-0 print:p-0">
          <span class="font-bold text-slate-400 block mb-1 uppercase tracking-widest text-[10px] print:text-black">Complaint</span>${l['當日主訴']||'--'}
        </div>
        <div class="text-sm text-slate-700 whitespace-pre-wrap px-1 print:text-black">${l['治療內容']}</div>
        ${l['備註/下次治療']?`<div class="mt-2 text-xs text-slate-600 bg-amber-50 p-3 rounded-xl border border-amber-100 print:bg-white print:border-slate-300"><span class="font-bold text-amber-500 block mb-1 flex items-center gap-1 print:text-black"><span class="material-icons-outlined text-[12px] print:hidden">flag</span> Next Plan</span>${l['備註/下次治療']}</div>`:''}
      </div>
    </div>`).join('');
}

function loadMaintenanceHistory() {
  const c = document.getElementById('maintenanceHistoryList'); c.innerHTML = '<div class="text-center py-10 text-slate-400">紀錄載入中...</div>';
  google.script.run.withSuccessHandler(logs => {
    if(!logs || !logs.length) { c.innerHTML = '<div class="bg-white/50 border-2 border-dashed border-slate-200 rounded-[2.5rem] p-12 text-center text-slate-300">尚無歷史紀錄</div>'; return; }
    c.innerHTML = logs.map(l => `
      <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 card-hover mb-4 flex flex-col md:flex-row gap-4 items-center print:break-inside-avoid print:mb-4 print:border print:border-slate-300">
        <div class="w-full md:w-auto flex flex-col gap-1 border-b md:border-b-0 md:border-r border-slate-100 pb-4 md:pb-0 md:pr-6 min-w-[140px] print:border-r print:border-slate-300">
          <div class="text-sm font-mono text-slate-500 tracking-tight print:text-black">${l['保養日期']||'--'}</div>
          <span class="px-2.5 py-1 bg-orange-50 text-orange-600 text-[11px] font-bold rounded-lg w-fit mt-1 print:bg-white print:text-black print:border print:border-slate-300">${l['保養項目']||'一般'}</span>
          <div class="text-xs font-bold text-slate-400 flex items-center gap-1 mt-2 print:text-black">
             <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span>${l['執行人員']||'--'}
          </div>
        </div>
        <div class="w-full grid grid-cols-4 gap-2 text-center">
          <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">BP</div><div class="text-sm font-black text-slate-700 print:text-black">${l['血壓']||'-'}</div></div>
          <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">SpO2</div><div class="text-sm font-black text-slate-700 print:text-black">${l['血氧']||'-'}</div></div>
          <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">HR</div><div class="text-sm font-black text-slate-700 print:text-black">${l['心律']||'-'}</div></div>
          <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">Temp</div><div class="text-sm font-black text-slate-700 print:text-black">${l['體溫']||'-'}</div></div>
        </div>
      </div>`).join('');
  }).getMaintenanceHistory(currentClient['個案編號']);
}

function loadDoctorHistory() {
  const c = document.getElementById('doctorHistoryList'); c.innerHTML = '<div class="text-center py-10 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(logs => {
    if(!logs || !logs.length) { c.innerHTML = '<div class="py-12 text-center text-slate-300 bg-white rounded-[2rem] border border-slate-100">尚無看診紀錄</div>'; return; }
    
    c.innerHTML = logs.map(l => `
      <div class="bg-white border border-slate-100 rounded-[2.5rem] p-8 shadow-sm mb-6 card-hover relative overflow-hidden print:break-inside-avoid print:mb-4 print:border print:border-slate-300 print:p-4">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-50 print:mb-2 print:pb-2 print:border-slate-300">
          <span class="text-xs font-bold bg-emerald-50 text-emerald-600 px-4 py-2 rounded-full font-mono print:bg-white print:text-black print:border print:border-slate-300">${l['看診日期']||'--'}</span>
          <div class="text-sm font-bold text-slate-500 flex items-center gap-4 print:text-black">
            <div class="flex items-center gap-1">
              <span class="material-icons-outlined text-base text-slate-400 print:hidden">person</span> ${l['看診醫師']||'--'}
            </div>
            <div class="flex items-center gap-1">
              <span class="material-icons-outlined text-base text-slate-400 print:hidden">person</span> ${l['護理師']||'--'}
            </div>
          </div>
        </div>
        
        <div class="soap-grid-container grid grid-cols-1 md:grid-cols-2 gap-6 text-sm print:gap-2">
          <div class="bg-blue-50/40 p-5 rounded-[1.5rem] border border-blue-50/50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-2 text-blue-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">S</span> 主訴</div>
             <div class="text-slate-600 leading-relaxed print:text-black">${l['S_主訴']||'--'}</div>
          </div>
          <div class="bg-indigo-50/40 p-5 rounded-[1.5rem] border border-indigo-50/50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-2 text-indigo-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">O</span> 檢查</div>
             <div class="text-slate-600 leading-relaxed print:text-black">${l['O_客觀檢查']||'--'}</div>
          </div>
          <div class="bg-amber-50/40 p-5 rounded-[1.5rem] border border-amber-50/50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-2 text-amber-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-amber-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">A</span> 診斷</div>
             <div class="text-slate-600 leading-relaxed print:text-black">${l['A_診斷']||'--'}</div>
          </div>
          <div class="bg-emerald-50/40 p-5 rounded-[1.5rem] border border-emerald-50/50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-2 text-emerald-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">P</span> 計畫</div>
             <div class="text-slate-600 leading-relaxed print:text-black">${l['P_治療計劃']||'--'}</div>
          </div>
          
          ${l['護理紀錄'] && l['護理紀錄']!=='--' ? `
          <div class="md:col-span-2 bg-rose-50/40 p-5 rounded-[1.5rem] border border-rose-50/50 print:bg-white print:border-slate-300 print:p-2">
              <div class="flex items-center gap-2 mb-2 text-rose-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-rose-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">N</span> 護理紀錄</div>
              <div class="text-slate-600 leading-relaxed print:text-black">${l['護理紀錄']}</div>
          </div>` : ''}

          ${l['備註'] && l['備註']!=='--' ? `
          <div class="md:col-span-2 bg-slate-50 p-4 rounded-2xl text-xs text-slate-500 border border-slate-100 flex gap-2 print:bg-white print:border-slate-300 print:p-2">
              <span class="font-bold shrink-0 print:text-black">Note:</span><span class="print:text-black">${l['備註']}</span>
          </div>` : ''}
        </div>
      </div>`).join('');
  }).getClientHistory(currentClient['個案編號'], 'Doctor_Consultation');
}

// ==========================================
// 個案總覽
// ==========================================
function loadOverviewData() {
  const container = document.getElementById('overviewListContainer'); container.innerHTML = '<div class="text-center py-12 text-slate-400 flex flex-col items-center gap-2"><span class="material-icons-outlined animate-spin">sync</span><span>讀取個案歷程中...</span></div>';
  google.script.run.withSuccessHandler(data => { 
      allOverviewRecords = data || []; 
      // ★ 同時更新日曆事件資料 (因為總覽資料結構已經正規化，可以直接轉換)
      allCalendarEvents = data || []; 
      renderOverviewList(); 
  }).withFailureHandler(err => { container.innerHTML = `<div class="text-red-500 text-center py-10">載入失敗: ${err.message}</div>`; }).getCaseOverviewData(currentClient['個案編號']);
}

function renderOverviewList() {
  const c = document.getElementById('overviewListContainer'); 
  const f = getFilteredOverviewData();
  
  document.getElementById('overviewStats').textContent = `共 ${f.length} 筆紀錄`;
  
  if (!f.length) { 
    c.innerHTML = `<div class="flex flex-col items-center justify-center py-24 bg-white rounded-[2.5rem] border border-slate-100"><div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-300"><span class="material-icons-outlined text-3xl">search_off</span></div><p class="text-slate-400 font-bold">無符合資料</p></div>`; 
    return; 
  }
  
  c.innerHTML = f.map(i => {
    // 共同的 class 字串，方便重複使用
    const cardClass = "bg-white border border-slate-100 rounded-[2rem] p-5 shadow-sm mb-4 card-hover relative overflow-hidden group print:break-inside-avoid print:mb-4 print:border-slate-300 print:p-3";
    const headerClass = "flex justify-between items-center mb-3 pb-2 border-b border-slate-50 pl-3 print:mb-1 print:pb-1 print:border-slate-300";
    const badgeClass = "text-xs font-bold px-3 py-1 rounded-full font-mono print:bg-white print:text-black print:border print:border-slate-300";
    
    if (i.category === 'doctor') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-500 opacity-80 print:hidden"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-blue-50 text-blue-600">${i.date}</span>
                  <span class="text-sm font-black text-slate-700 print:text-black">醫師看診</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-3 print:text-black">
                  <div class="flex items-center gap-1"><span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.doctor||'--'}</div>
                  <div class="flex items-center gap-1"><span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.nurse||'--'}</div>
              </div>
          </div>
          <div class="pl-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm mb-2 print:gap-1">
              <div class="bg-blue-50/40 p-2.5 rounded-xl border border-blue-50 print:bg-white print:border-slate-300"><span class="text-blue-600 font-black text-xs mr-1 print:text-black">S</span> <span class="text-slate-700 leading-snug print:text-black">${i.s||'--'}</span></div>
              <div class="bg-indigo-50/40 p-2.5 rounded-xl border border-indigo-50 print:bg-white print:border-slate-300"><span class="text-indigo-600 font-black text-xs mr-1 print:text-black">O</span> <span class="text-slate-700 leading-snug print:text-black">${i.o||'--'}</span></div>
              <div class="bg-amber-50/40 p-2.5 rounded-xl border border-amber-50 print:bg-white print:border-slate-300"><span class="text-amber-600 font-black text-xs mr-1 print:text-black">A</span> <span class="text-slate-700 leading-snug print:text-black">${i.a||'--'}</span></div>
              <div class="bg-emerald-50/40 p-2.5 rounded-xl border border-emerald-50 print:bg-white print:border-slate-300"><span class="text-emerald-600 font-black text-xs mr-1 print:text-black">P</span> <span class="text-slate-700 leading-snug print:text-black">${i.p||'--'}</span></div>
          </div>
          <div class="pl-3 space-y-2">
              ${i.nursingRecord && i.nursingRecord !== '--' ? `<div class="bg-rose-50/50 p-3 rounded-xl text-sm border border-rose-100 print:bg-white print:border-slate-300"><div class="flex items-center gap-1.5 mb-1 text-rose-600 font-black text-xs print:text-black"><span class="material-icons-outlined text-[14px] print:hidden">favorite</span> 護理紀錄</div><div class="text-slate-600 leading-snug whitespace-pre-wrap pl-1 print:text-black">${i.nursingRecord}</div></div>` : ''}
              ${i.remark && i.remark !== '--' ? `<div class="bg-slate-50 p-2.5 rounded-xl text-xs text-slate-500 border border-slate-100 flex gap-2 items-start print:bg-white print:border-slate-300"><span class="font-bold shrink-0 bg-slate-200 px-1.5 rounded text-[10px] text-slate-600 print:bg-white print:text-black print:border">Note</span><span class="leading-snug print:text-black">${i.remark}</span></div>` : ''}
          </div>
      </div>`;
    } 
    else if (i.category === 'treatment') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-500 opacity-80 print:hidden"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-emerald-50 text-emerald-600">${i.date}</span>
                  <span class="text-sm font-black text-slate-700 print:text-black">治療紀錄</span>
                  ${i.item ? `<span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded border border-slate-200 print:bg-white print:text-black">${i.item}</span>` : ''}
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1 print:text-black">
                  <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 space-y-3 print:space-y-1">
              ${i.complaint ? `<div><div class="text-[10px] font-bold text-slate-400 mb-1 print:text-black">當日主訴</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed print:text-black">${i.complaint}</div></div>` : ''}
              <div><div class="text-[10px] font-bold text-slate-400 mb-1 print:text-black">治療內容</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed print:text-black">${i.content}</div></div>
              ${i.nextPlan ? `<div class="bg-amber-50 p-2.5 rounded-xl border border-amber-100 print:bg-white print:border-slate-300"><div class="text-[10px] font-bold text-amber-500 uppercase tracking-wider mb-1 flex items-center gap-1 print:text-black"><span class="material-icons-outlined text-[10px] print:hidden">flag</span> 備註 / 下次治療</div><div class="text-xs text-slate-600 whitespace-pre-wrap leading-snug print:text-black">${i.nextPlan}</div></div>` : ''}
          </div>
      </div>`;
    }
    else if (i.category === 'maintenance') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-orange-400 opacity-80 print:hidden"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-orange-50 text-orange-600">${i.date}</span>
                  <span class="text-sm font-black text-slate-700 print:text-black">${i.item||'保養'}</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1 print:text-black">
                  <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 grid grid-cols-4 gap-2 mb-2">
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center print:bg-white print:border-slate-300"><span class="text-[9px] font-bold text-slate-400 print:text-black">BP</span><span class="text-xs font-black text-slate-700 print:text-black">${i.bp||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center print:bg-white print:border-slate-300"><span class="text-[9px] font-bold text-slate-400 print:text-black">SpO2</span><span class="text-xs font-black text-slate-700 print:text-black">${i.spo2||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center print:bg-white print:border-slate-300"><span class="text-[9px] font-bold text-slate-400 print:text-black">HR</span><span class="text-xs font-black text-slate-700 print:text-black">${i.hr||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center print:bg-white print:border-slate-300"><span class="text-[9px] font-bold text-slate-400 print:text-black">Temp</span><span class="text-xs font-black text-slate-700 print:text-black">${i.temp||'-'}</span></div>
          </div>
          ${i.remark && i.remark !== '--' ? `<div class="pl-3 mt-2"><div class="text-xs text-slate-600 bg-orange-50/50 p-2.5 rounded-xl border border-orange-100 flex gap-2 items-start print:bg-white print:border-slate-300"><span class="font-bold text-orange-400 shrink-0 text-[10px] pt-0.5 print:text-black">NOTE</span><span class="leading-snug whitespace-pre-wrap print:text-black">${i.remark}</span></div></div>` : ''}
      </div>`;
    }
    else if (i.category === 'tracking') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-violet-500 opacity-80 print:hidden"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-violet-50 text-violet-600">${i.date}</span>
                  <span class="text-xs font-bold text-white bg-violet-400 px-2 py-0.5 rounded-md print:bg-white print:text-black print:border print:border-slate-300">${i.type||'追蹤'}</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1 print:text-black">
                  <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 text-sm text-slate-700 leading-relaxed whitespace-pre-line print:text-black">${i.content}</div>
      </div>`;
    }
    return '';
  }).join('');
}

function setOverviewCategory(cat) {
  currentOverviewCategory = cat;
  ['all', 'doctor', 'maintenance', 'tracking', 'treatment'].forEach(b => {
    const el = document.getElementById('filter-btn-' + b);
    if(b === cat) { el.className = "px-4 py-2 rounded-xl text-sm font-bold bg-slate-800 text-white shadow-md transform scale-105 transition-all"; }
    else { el.className = "px-4 py-2 rounded-xl text-sm font-bold text-slate-500 hover:bg-white hover:text-slate-700 transition-all"; }
  });
  renderOverviewList();
}
function getFilteredOverviewData() {
  const s = document.getElementById('overviewStartDate').value; const e = document.getElementById('overviewEndDate').value;
  return allOverviewRecords.filter(i => { if (currentOverviewCategory !== 'all' && i.category !== currentOverviewCategory) return false; if (s && i.date < s) return false; if (e && i.date > e) return false; return true; });
}

function printOverviewReport() { handlePrint(); } 

// ==========================================
// 工具函式
// ==========================================
function resetSearch() { currentClient = null; document.getElementById('topBarClientInfo').classList.add('hidden'); navTo('search'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }

// ==========================================
// Lightbox
// ==========================================
function openLightbox(id, name) {
    const modal = document.getElementById('imageLightbox');
    const img = document.getElementById('lightboxImage');
    const loading = document.getElementById('lightboxLoading');
    const titleDiv = document.getElementById('lightboxTitle');
    if (!modal || !img) return;
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    img.style.opacity = '0';
    img.style.transform = 'scale(0.95)';
    img.src = ""; 
    if (titleDiv) titleDiv.textContent = name || '';
    const highResUrl = `https://lh3.googleusercontent.com/d/${id}=s0`;
    img.onload = function() {
        loading.classList.add('hidden');
        img.style.opacity = '1';
        img.style.transform = 'scale(1)';
    };
    img.src = highResUrl;
    document.body.style.overflow = 'hidden'; 
}
function closeLightbox() {
    const modal = document.getElementById('imageLightbox');
    if (modal) modal.classList.add('hidden');
    const img = document.getElementById('lightboxImage');
    if (img) img.src = '';
    document.body.style.overflow = ''; 
}
document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") closeLightbox();
});
</script>