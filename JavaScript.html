<script>
// ==========================================
// 全域變數宣告
// ==========================================
let currentClient = null;
let allTreatmentLogs = [];
let allOverviewRecords = []; 
let currentOverviewCategory = 'all'; 
let currentCalDate = new Date();
let isMonthPickerMode = false; 
let filesToUpload = []; // 確保此變數被宣告

// ==========================================
// 初始化與 UI 設定
// ==========================================

// Flatpickr 日期選擇器初始化設定 (保持原 UI 設計)
function setupEnhancedFlatpickr(selector, options = {}) {
  const defaults = {
    locale: "zh_tw", dateFormat: "Y-m-d", disableMobile: true, allowInput: true, static: true,
    onReady: function(selectedDates, dateStr, instance) {
      const customHeader = document.createElement("div");
      customHeader.className = "custom-fp-header";
      customHeader.innerHTML = `<div class="custom-fp-nav-btn prev-btn"><span class="material-icons-outlined text-sm">chevron_left</span></div><div class="custom-fp-title"><span class="curr-year-month">--</span><span class="material-icons-outlined text-xs text-slate-300">expand_more</span></div><div class="custom-fp-nav-btn next-btn"><span class="material-icons-outlined text-sm">chevron_right</span></div>`;
      instance.calendarContainer.insertBefore(customHeader, instance.calendarContainer.firstChild);
      const monthGrid = document.createElement("div");
      monthGrid.className = "custom-fp-month-grid";
      monthGrid.style.display = "none"; 
      const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
      monthNames.forEach((mName, idx) => {
        const item = document.createElement("div");
        item.className = "custom-fp-month-item";
        item.textContent = mName;
        item.onclick = (e) => { e.stopPropagation(); instance.changeMonth(idx, false); monthGrid.style.display = "none"; instance.innerContainer.style.display = "block"; updateHeader(instance, customHeader, monthGrid); };
        monthGrid.appendChild(item);
      });
      instance.calendarContainer.appendChild(monthGrid);
      const titleBtn = customHeader.querySelector('.custom-fp-title');
      const prevBtn = customHeader.querySelector('.prev-btn');
      const nextBtn = customHeader.querySelector('.next-btn');
      titleBtn.onclick = (e) => { e.stopPropagation(); const isGridVisible = monthGrid.style.display !== "none"; if(isGridVisible) { monthGrid.style.display = "none"; instance.innerContainer.style.display = "block"; } else { monthGrid.style.display = "grid"; instance.innerContainer.style.display = "none"; renderMonthGridDots(instance, monthGrid); } updateHeader(instance, customHeader, monthGrid); };
      prevBtn.onclick = (e) => { e.stopPropagation(); if(monthGrid.style.display !== "none") { instance.changeYear(instance.currentYear - 1); renderMonthGridDots(instance, monthGrid); } else { instance.changeMonth(-1); } updateHeader(instance, customHeader, monthGrid); };
      nextBtn.onclick = (e) => { e.stopPropagation(); if(monthGrid.style.display !== "none") { instance.changeYear(instance.currentYear + 1); renderMonthGridDots(instance, monthGrid); } else { instance.changeMonth(1); } updateHeader(instance, customHeader, monthGrid); };
      updateHeader(instance, customHeader, monthGrid);
    },
    onMonthChange: function(sd, ds, instance) { updateHeader(instance, instance.calendarContainer.querySelector(".custom-fp-header"), instance.calendarContainer.querySelector(".custom-fp-month-grid")); },
    onYearChange: function(sd, ds, instance) { const grid = instance.calendarContainer.querySelector(".custom-fp-month-grid"); updateHeader(instance, instance.calendarContainer.querySelector(".custom-fp-header"), grid); if(grid && grid.style.display !== "none") renderMonthGridDots(instance, grid); },
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      const dateKey = dayElem.dateObj.toISOString().split('T')[0];
      if(allTreatmentLogs.some(log => log['治療日期'] && log['治療日期'].trim() === dateKey)) dayElem.classList.add('has-record');
    }
  };
  return flatpickr(selector, { ...defaults, ...options });
}

function updateHeader(instance, headerEl, gridEl) {
  if(!headerEl) return;
  const titleSpan = headerEl.querySelector(".curr-year-month");
  if (gridEl && gridEl.style.display !== "none") {
    titleSpan.textContent = `${instance.currentYear}年`;
    gridEl.querySelectorAll(".custom-fp-month-item").forEach((item, idx) => { idx === instance.currentMonth ? item.classList.add("is-current") : item.classList.remove("is-current"); });
  } else { titleSpan.textContent = `${instance.currentYear}年 ${instance.l10n.months.longhand[instance.currentMonth]}`; }
}

function renderMonthGridDots(instance, gridEl) {
  const currentYear = instance.currentYear;
  const monthsWithData = new Set();
  allTreatmentLogs.forEach(log => {
    if (!log['治療日期']) return;
    const parts = log['治療日期'].trim().split('-');
    if (parts.length >= 2 && parseInt(parts[0], 10) === currentYear) monthsWithData.add(parseInt(parts[1], 10) - 1);
  });
  gridEl.querySelectorAll(".custom-fp-month-item").forEach((item, idx) => { monthsWithData.has(idx) ? item.classList.add("has-record") : item.classList.remove("has-record"); });
}

// 頁面載入完成後執行
window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('#treatmentDate, #maintenanceDate, #doctorConsultDate, #trackDate').forEach(el => el.value = today);
  
  setupEnhancedFlatpickr('input[type="date"], #trackDate', {
    onChange: function(selectedDates, dateStr, instance) {
      if (instance.element.id === 'filterDate') { applyLogFilters(); if (selectedDates.length > 0) { currentCalDate = new Date(selectedDates[0]); isMonthPickerMode = false; renderTreatmentCalendar(); } }
    }
  });
  
  const overviewConfig = { onChange: function() { renderOverviewList(); } };
  setupEnhancedFlatpickr('#overviewStartDate', overviewConfig);
  setupEnhancedFlatpickr('#overviewEndDate', overviewConfig);
  
  loadSystemStaff();
};

function loadSystemStaff() {
  if (typeof google === 'undefined' || !google.script) return;
  google.script.run.withSuccessHandler(staff => {
    const setOptions = (id, list, placeholder) => {
      const el = document.getElementById(id);
      if(el) { el.innerHTML = `<option value="" disabled selected>${placeholder}</option>` + list.map(n => `<option value="${n}">${n}</option>`).join(''); }
    };
    setOptions('selectDoctor', staff.doctors, '請選擇醫師');
    setOptions('selectNurse', staff.nurses, '請選擇護理師');
    setOptions('inputTherapist', staff.therapists, '請選擇治療師');
    setOptions('selectMaintStaff', staff.allStaff, '請選擇執行人員');
    setOptions('selectMaintItem', staff.maintItems, '請選擇項目');
    setOptions('trackStaff', staff.allStaff, '請選擇人員');
    setOptions('trackType', staff.trackingTypes || [], '請選擇項目');
    
    const fts = document.getElementById('filterTherapist');
    if(fts) fts.innerHTML = '<option value="">所有執行人員</option>' + staff.therapists.map(n => `<option value="${n}">${n}</option>`).join('');
  }).getSystemStaff();
}

// ==========================================
// 導覽與頁面切換
// ==========================================
function navTo(viewName) {
  if (!currentClient && viewName !== 'search') { alert("請先選取個案。"); return; }
  
  const views = ['search', 'basic', 'images', 'treatment', 'maintenance', 'doctor', 'tracking', 'overview'];
  views.forEach(v => {
    document.getElementById('view-' + v)?.classList.add('hidden');
    document.getElementById('btn-' + v)?.classList.remove('active');
  });
  const target = document.getElementById('view-' + viewName);
  if(target) {
    target.classList.remove('hidden');
    target.classList.add('view-animate'); 
  }
  document.getElementById('btn-' + viewName)?.classList.add('active');
  
  const titles = { 'search':'首頁','basic':'基本資料','images':'影像總覽','treatment':'治療紀錄','maintenance':'保養項目','doctor':'醫師看診','tracking':'個管追蹤','overview':'個案總覽' };
  document.getElementById('pageTitle').textContent = titles[viewName] || '康飛運醫';
  
  if (currentClient) {
    if(viewName === 'basic') renderBasicInfo();
    if(viewName === 'doctor') loadDoctorHistory();
    if(viewName === 'treatment') loadTreatmentHistory();
    if(viewName === 'maintenance') loadMaintenanceHistory();
    if(viewName === 'tracking') loadTrackingHistory();
    if(viewName === 'overview') loadOverviewData(); 
    if(viewName === 'images') loadClientImages();
  }
}

// ==========================================
// ★★★ [NEW] 新增個案相關函式 (補上缺失的部分) ★★★
// ==========================================

// 自動判斷性別 (根據身分證字號)
function autoDetectGender(input) {
  const val = input.value.toUpperCase();
  input.value = val; // 強制轉大寫
  if (val.length >= 2) {
    const secondChar = val.charAt(1);
    // 身分證第二碼 1 為男，2 為女
    if (secondChar === '1') {
      // 這裡假設未來可能會在 UI 上顯示性別，目前僅做判斷邏輯
      // console.log("Detected Male");
    } else if (secondChar === '2') {
      // console.log("Detected Female");
    }
  }
}

// 提交新個案資料
function submitNewClient() {
  const btn = document.getElementById('btnSubmitClient');
  const originalText = btn.innerHTML;
  
  // 取得表單欄位值
  const data = {
    name: document.getElementById('addName').value.trim(),
    dob: document.getElementById('addDob').value.trim(),
    idNo: document.getElementById('addIdNo').value.trim(),
    phone: document.getElementById('addPhone').value.trim(),
    gender: '', // 稍後判斷
    emerName: document.getElementById('addEmerName').value.trim(),
    emerPhone: document.getElementById('addEmerPhone').value.trim(),
    chronic: document.getElementById('addChronic').value.trim()
  };

  // 簡易驗證
  if (!data.name || !data.dob || !data.idNo || !data.phone) {
    alert("請填寫所有必填欄位 (*)！");
    return;
  }
  
  if (data.idNo.length < 2) {
      alert("身分證字號格式錯誤");
      return;
  }
  
  // 自動判斷性別
  const secondChar = data.idNo.charAt(1);
  if (secondChar === '1') data.gender = '男';
  else if (secondChar === '2') data.gender = '女';
  else data.gender = '其他';

  // UILoading 狀態
  btn.disabled = true;
  btn.innerHTML = '<span class="material-icons-outlined animate-spin">sync</span> 建立中...';

  google.script.run
    .withSuccessHandler(function(res) {
      btn.disabled = false;
      btn.innerHTML = originalText;
      
      if (res.success) {
        alert("個案建立成功！");
        document.getElementById('addClientForm').reset();
        closeModal('addClientModal');
        // 自動選取新個案並跳轉
        selectClient(res.fullData);
      } else {
        alert("建立失敗：" + res.message);
      }
    })
    .withFailureHandler(function(e) {
      btn.disabled = false;
      btn.innerHTML = originalText;
      alert("系統錯誤：" + e.message);
    })
    .createNewClient(data);
}

// ==========================================
// 列印功能
// ==========================================
function handlePrint() {
  const today = new Date();
  const dateStr = today.getFullYear() + "-" + 
                  String(today.getMonth() + 1).padStart(2, '0') + "-" + 
                  String(today.getDate()).padStart(2, '0');
  
  const dateEl = document.getElementById('print-date-display');
  if(dateEl) dateEl.innerText = dateStr;

  const infoEl = document.getElementById('print-patient-info');
  if (infoEl) {
      if (currentClient) {
         infoEl.innerText = `${currentClient['姓名']} - ${currentClient['生日']}`;
      } else {
         infoEl.innerText = "個案列表";
      }
  }
  window.print();
}

// === 基本資料渲染 ===
function renderBasicInfo() {
  if(!currentClient) return;
  const fieldMap = {
    'display-client-id': '個案編號',
    'display-name': '姓名',
    'display-gender': '性別',
    'display-birthday': '生日',
    'display-id-number': '身分證字號',
    'display-phone': '電話',
    'display-emergency-name': '緊急聯絡人',
    'display-emergency-phone': '緊急聯絡人電話', // ★ 已修正：補上"人"字，與資料庫欄位一致
    'display-notes': '慢性病或特殊疾病'       // ★ 已修正：改為正確的資料庫欄位名稱
  };
  
  for (const [domId, dbKey] of Object.entries(fieldMap)) {
    const el = document.getElementById(domId);
    if(el) {
       // 如果是備註欄位且內容為空，則維持預設文字 (例如：尚無備註紀錄)
       if(domId === 'display-notes' && (!currentClient[dbKey] || currentClient[dbKey] === '')) continue;
       el.textContent = currentClient[dbKey] || '--';
    }
  }
  
  const statusEl = document.getElementById('display-status');
  if(statusEl && currentClient['狀態']) statusEl.textContent = currentClient['狀態'];
}

function handleSearch() {
  const inputEl = document.getElementById('searchInput');
  const kw = inputEl.value.trim();
  if (!kw) { alert("請輸入姓名或電話"); inputEl.focus(); return; }
  const container = document.getElementById('searchResults');
  container.innerHTML = '<div class="text-center py-8 text-slate-400 flex flex-col items-center gap-2"><span class="material-icons-outlined animate-spin">sync</span><span>資料庫搜尋中...</span></div>';
  google.script.run.withSuccessHandler(data => {
      container.innerHTML = '';
      if(data.length === 0) { container.innerHTML = '<div class="text-center py-6 text-slate-400 bg-white rounded-2xl border border-slate-100 shadow-sm">查無此個案資料</div>'; return; }
      data.forEach(c => {
        const div = document.createElement('div');
        div.className = "bg-white p-5 rounded-3xl shadow-sm border border-slate-100 hover:border-emerald-400 hover:shadow-md cursor-pointer transition-all flex justify-between items-center group mb-3 relative overflow-hidden";
        div.onclick = () => selectClient(c);
        div.innerHTML = `<div class="absolute left-0 top-0 bottom-0 w-1 bg-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity"></div><div class="pl-2"> <div class="font-black text-slate-800 text-lg flex items-center gap-2">${c['姓名']} <span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg border border-slate-200">${c['個案編號']}</span></div><div class="text-sm text-slate-400 mt-1 flex items-center gap-1 font-mono"><span class="material-icons-outlined text-[14px]">phone</span> ${c['電話']}</div></div><div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:bg-emerald-500 group-hover:text-white transition-all"><span class="material-icons-outlined">arrow_forward</span></div>`;
        container.appendChild(div);
      });
  }).searchClient(kw);
}

function selectClient(c) {
  currentClient = c;
  document.getElementById('topBarClientInfo').classList.remove('hidden');
  document.getElementById('headerClientName').textContent = c['姓名'];
  document.getElementById('headerClientDob').textContent = c['生日'];
  document.querySelectorAll('.auto-fill-id').forEach(el => el.value = c['個案編號']);
  navTo('basic');
}

// ==========================================
// 表單提交 (治療、醫師、保養、追蹤)
// ==========================================
function submitForm(type) {
  if (!currentClient) { alert("系統錯誤：未選取個案，請重新搜尋。"); return; }
  
  const clientId = currentClient['個案編號'];
  const btn = type === 'tracking' ? document.querySelector('#trackingForm button[type="submit"]') : event.target;
  const ot = btn ? btn.innerHTML : "儲存"; 
  if(btn) { btn.disabled = true; btn.innerHTML = '<span class="material-icons-outlined animate-spin">sync</span> 儲存中...'; }
  
  if (type === 'doctor') {
    const d = { 
      clientId: clientId,
      date: document.getElementById('doctorConsultDate').value, 
      doctor: document.getElementById('selectDoctor').value, 
      nurse: document.getElementById('selectNurse').value, 
      complaint: document.querySelector('#view-doctor textarea[name="主訴"]').value, 
      objective: document.querySelector('#view-doctor textarea[name="客觀檢查"]').value, 
      diagnosis: document.querySelector('#view-doctor textarea[name="診斷"]').value, 
      plan: document.querySelector('#view-doctor textarea[name="治療計畫"]').value, 
      nursingRecord: document.getElementById('nursingRecord').value, 
      remark: document.getElementById('doctorRemark').value 
    };
    if (!d.date || !d.doctor) { alert("請填寫日期與醫師"); if(btn){btn.disabled=false; btn.innerHTML=ot;} return; }
    google.script.run.withSuccessHandler(res => { if(btn){btn.disabled=false; btn.innerHTML=ot;} if (res.success) { alert(res.message); document.getElementById('doctorForm').reset(); loadDoctorHistory(); } else { alert(res.message); } }).saveDoctorConsultation(d);
  } else if (type === 'treatment') {
    const d = { 
      '個案編號': clientId,
      '治療日期': document.getElementById('treatmentDate').value, 
      '執行治療師': document.getElementById('inputTherapist').value, 
      '當日主訴': document.getElementById('inputComplaint').value, 
      '治療內容': document.getElementById('inputContent').value, 
      '備註/下次治療': document.getElementById('inputNextPlan').value 
    };
    if (!d['治療日期'] || !d['執行治療師']) { alert("請填寫日期與治療師"); if(btn){btn.disabled=false; btn.innerHTML=ot;} return; }
    google.script.run.withSuccessHandler(res => { if(btn){btn.disabled=false; btn.innerHTML=ot;} if (res.success) { alert(res.message); document.getElementById('treatmentForm').reset(); loadTreatmentHistory(); } else { alert(res.message); } }).saveData('Treatment_Logs', d);
  } else if (type === 'maintenance') {
    const f = document.getElementById('maintenanceForm');
    const d = { 
      clientId: clientId,
      date: document.getElementById('maintenanceDate').value, 
      staff: document.getElementById('selectMaintStaff').value, 
      item: document.getElementById('selectMaintItem').value, 
      bp: f.querySelector('input[name="血壓"]').value, 
      spo2: f.querySelector('input[name="血氧"]').value, 
      hr: f.querySelector('input[name="心律"]').value, 
      temp: f.querySelector('input[name="體溫"]').value, 
      remark: f.querySelector('textarea[name="備註"]').value 
    };
    if (!d.date || !d.staff || !d.item) { alert("請完整填寫必填欄位"); if(btn){btn.disabled=false; btn.innerHTML=ot;} return; }
    google.script.run.withSuccessHandler(res => { if(btn){btn.disabled=false; btn.innerHTML=ot;} if (res.success) { alert(res.message); f.reset(); document.getElementById('maintenanceDate').value = new Date().toISOString().split('T')[0]; loadMaintenanceHistory(); } else { alert(res.message); } }).saveMaintenanceRecord(d);
  } else if (type === 'tracking') {
    const d = { 
      clientId: clientId,
      trackDate: document.getElementById('trackDate').value, 
      trackStaff: document.getElementById('trackStaff').value, 
      trackType: document.getElementById('trackType').value, 
      content: document.getElementById('trackContent').value 
    };
    if (!d.trackDate || !d.trackStaff || !d.trackType || !d.content) { alert("請完整填寫追蹤資料"); if(btn){btn.disabled=false; btn.innerHTML=ot;} return; }
    google.script.run.withSuccessHandler(res => { if(btn){btn.disabled=false; btn.innerHTML=ot;} if (res.success) { alert(res.message); document.getElementById('trackContent').value = ""; loadTrackingHistory(); } else { alert(res.message); } }).saveTrackingRecord(d);
  }
}

// ==========================================
// 歷史列表載入函式
// ==========================================
function loadTrackingHistory() {
  const c = document.getElementById('trackingHistoryList'); c.innerHTML = '<div class="text-center py-6 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(recs => {
    if (!recs || !recs.length) { c.innerHTML = `<div class="text-center text-slate-400 py-12 bg-white rounded-[2rem] border border-slate-100"><span class="material-icons-outlined text-4xl mb-2 text-slate-300">history_edu</span><p>尚無任何追蹤紀錄</p></div>`; return; }
    c.innerHTML = recs.map(r => `
      <div class="bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-sm card-hover mb-4 relative overflow-hidden group">
        <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-violet-500 opacity-80"></div>
        <div class="pl-2">
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center gap-2">
              <span class="bg-violet-50 text-violet-700 text-xs font-bold px-3 py-1 rounded-full border border-violet-100">${r.type}</span>
              <div class="text-slate-500 text-xs font-bold flex items-center bg-slate-50 px-2 py-1 rounded-lg">
                <span class="material-icons-outlined text-[14px] mr-1 text-slate-400">person</span>${r.staff||'--'}
              </div>
            </div>
            <span class="text-slate-400 text-xs font-mono">${r.date}</span>
          </div>
          <div class="text-slate-700 text-sm leading-relaxed whitespace-pre-line bg-slate-50/50 p-3 rounded-xl">${r.content}</div>
        </div>
      </div>`).join('');
  }).getTrackingHistory(currentClient['個案編號']);
}

function loadTreatmentHistory() {
  const c = document.getElementById('historyListContainer'); c.innerHTML = '<div class="text-center py-6 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(logs => { allTreatmentLogs = logs || []; applyLogFilters(); renderTreatmentCalendar(); }).getClientHistory(currentClient['個案編號'], 'Treatment_Logs');
}

function renderTreatmentList(logs) {
  const c = document.getElementById('historyListContainer');
  if(!logs.length) { c.innerHTML = '<div class="text-center py-10 text-slate-300 bg-slate-50 rounded-2xl">無相關紀錄</div>'; return; }
  c.innerHTML = logs.map(l => `
    <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 card-hover mb-4 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
      <div class="flex justify-between items-center mb-3">
        <span class="text-xs font-bold text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded-lg">${l['治療日期']}</span>
        <div class="flex items-center gap-1 text-xs font-bold text-slate-500">
          <span class="material-icons-outlined text-sm text-slate-400">person</span>${l['執行治療師']}
        </div>
      </div>
      <div class="space-y-3">
        <div class="text-xs text-slate-500 bg-slate-50 p-3 rounded-xl border border-slate-100">
          <span class="font-bold text-slate-400 block mb-1 uppercase tracking-widest text-[10px]">Complaint</span>${l['當日主訴']||'--'}
        </div>
        <div class="text-sm text-slate-700 whitespace-pre-wrap px-1">${l['治療內容']}</div>
        ${l['備註/下次治療']?`<div class="mt-2 text-xs text-slate-600 bg-amber-50 p-3 rounded-xl border border-amber-100"><span class="font-bold text-amber-500 block mb-1 flex items-center gap-1"><span class="material-icons-outlined text-[12px]">flag</span> Next Plan</span>${l['備註/下次治療']}</div>`:''}
      </div>
    </div>`).join('');
}

function loadMaintenanceHistory() {
  const c = document.getElementById('maintenanceHistoryList'); c.innerHTML = '<div class="text-center py-10 text-slate-400">紀錄載入中...</div>';
  google.script.run.withSuccessHandler(logs => {
    if(!logs || !logs.length) { c.innerHTML = '<div class="bg-white/50 border-2 border-dashed border-slate-200 rounded-[2.5rem] p-12 text-center text-slate-300">尚無歷史紀錄</div>'; return; }
    c.innerHTML = logs.map(l => `
      <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 card-hover mb-4 flex flex-col md:flex-row gap-4 items-center">
        <div class="w-full md:w-auto flex flex-col gap-1 border-b md:border-b-0 md:border-r border-slate-100 pb-4 md:pb-0 md:pr-6 min-w-[140px]">
          <div class="text-sm font-mono text-slate-500 tracking-tight">${l['保養日期']||'--'}</div>
          <span class="px-2.5 py-1 bg-orange-50 text-orange-600 text-[11px] font-bold rounded-lg w-fit mt-1">${l['保養項目']||'一般'}</span>
          <div class="text-xs font-bold text-slate-400 flex items-center gap-1 mt-2">
             <span class="material-icons-outlined text-sm text-slate-400">person</span>${l['執行人員']||'--'}
          </div>
        </div>
        <div class="w-full grid grid-cols-4 gap-2 text-center">
          <div class="p-2 rounded-xl bg-slate-50"><div class="text-[9px] font-bold text-slate-400 mb-1">BP</div><div class="text-sm font-black text-slate-700">${l['血壓']||'-'}</div></div>
          <div class="p-2 rounded-xl bg-slate-50"><div class="text-[9px] font-bold text-slate-400 mb-1">SpO2</div><div class="text-sm font-black text-slate-700">${l['血氧']||'-'}</div></div>
          <div class="p-2 rounded-xl bg-slate-50"><div class="text-[9px] font-bold text-slate-400 mb-1">HR</div><div class="text-sm font-black text-slate-700">${l['心律']||'-'}</div></div>
          <div class="p-2 rounded-xl bg-slate-50"><div class="text-[9px] font-bold text-slate-400 mb-1">Temp</div><div class="text-sm font-black text-slate-700">${l['體溫']||'-'}</div></div>
        </div>
      </div>`).join('');
  }).getMaintenanceHistory(currentClient['個案編號']);
}

function loadDoctorHistory() {
  const c = document.getElementById('doctorHistoryList'); c.innerHTML = '<div class="text-center py-10 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(logs => {
    if(!logs || !logs.length) { c.innerHTML = '<div class="py-12 text-center text-slate-300 bg-white rounded-[2rem] border border-slate-100">尚無看診紀錄</div>'; return; }
    
    c.innerHTML = logs.map(l => `
      <div class="bg-white border border-slate-100 rounded-[2.5rem] p-8 shadow-sm mb-6 card-hover relative overflow-hidden">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-50">
          <span class="text-xs font-bold bg-emerald-50 text-emerald-600 px-4 py-2 rounded-full font-mono">${l['看診日期']||'--'}</span>
          <div class="text-sm font-bold text-slate-500 flex items-center gap-4">
            <div class="flex items-center gap-1">
              <span class="material-icons-outlined text-base text-slate-400">person</span> ${l['看診醫師']||'--'}
            </div>
            <div class="flex items-center gap-1">
              <span class="material-icons-outlined text-base text-slate-400">person</span> ${l['護理師']||'--'}
            </div>
          </div>
        </div>
        
        <div class="soap-grid-container grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
          <div class="bg-blue-50/40 p-5 rounded-[1.5rem] border border-blue-50/50">
             <div class="flex items-center gap-2 mb-2 text-blue-600 font-black"><span class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-xs">S</span> 主訴</div>
             <div class="text-slate-600 leading-relaxed">${l['S_主訴']||'--'}</div>
          </div>
          <div class="bg-indigo-50/40 p-5 rounded-[1.5rem] border border-indigo-50/50">
             <div class="flex items-center gap-2 mb-2 text-indigo-600 font-black"><span class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs">O</span> 檢查</div>
             <div class="text-slate-600 leading-relaxed">${l['O_客觀檢查']||'--'}</div>
          </div>
          <div class="bg-amber-50/40 p-5 rounded-[1.5rem] border border-amber-50/50">
             <div class="flex items-center gap-2 mb-2 text-amber-600 font-black"><span class="w-6 h-6 rounded-full bg-amber-100 flex items-center justify-center text-xs">A</span> 診斷</div>
             <div class="text-slate-600 leading-relaxed">${l['A_診斷']||'--'}</div>
          </div>
          <div class="bg-emerald-50/40 p-5 rounded-[1.5rem] border border-emerald-50/50">
             <div class="flex items-center gap-2 mb-2 text-emerald-600 font-black"><span class="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center text-xs">P</span> 計畫</div>
             <div class="text-slate-600 leading-relaxed">${l['P_治療計劃']||'--'}</div>
          </div>
          
          ${l['護理紀錄'] && l['護理紀錄']!=='--' ? `
          <div class="md:col-span-2 bg-rose-50/40 p-5 rounded-[1.5rem] border border-rose-50/50">
              <div class="flex items-center gap-2 mb-2 text-rose-600 font-black"><span class="w-6 h-6 rounded-full bg-rose-100 flex items-center justify-center text-xs">N</span> 護理紀錄</div>
              <div class="text-slate-600 leading-relaxed">${l['護理紀錄']}</div>
          </div>` : ''}

          ${l['備註'] && l['備註']!=='--' ? `
          <div class="md:col-span-2 bg-slate-50 p-4 rounded-2xl text-xs text-slate-500 border border-slate-100 flex gap-2">
              <span class="font-bold shrink-0">Note:</span>${l['備註']}
          </div>` : ''}
        </div>
      </div>`).join('');
  }).getClientHistory(currentClient['個案編號'], 'Doctor_Consultation');
}

// ==========================================
// 個案總覽函式
// ==========================================
function loadOverviewData() {
  const container = document.getElementById('overviewListContainer'); container.innerHTML = '<div class="text-center py-12 text-slate-400 flex flex-col items-center gap-2"><span class="material-icons-outlined animate-spin">sync</span><span>讀取個案歷程中...</span></div>';
  google.script.run.withSuccessHandler(data => { allOverviewRecords = data || []; renderOverviewList(); }).withFailureHandler(err => { container.innerHTML = `<div class="text-red-500 text-center py-10">載入失敗: ${err.message}</div>`; }).getCaseOverviewData(currentClient['個案編號']);
}

function renderOverviewList() {
  const c = document.getElementById('overviewListContainer'); 
  const f = getFilteredOverviewData();
  
  document.getElementById('overviewStats').textContent = `共 ${f.length} 筆紀錄`;
  
  if (!f.length) { 
    c.innerHTML = `<div class="flex flex-col items-center justify-center py-24 bg-white rounded-[2.5rem] border border-slate-100"><div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-300"><span class="material-icons-outlined text-3xl">search_off</span></div><p class="text-slate-400 font-bold">無符合資料</p></div>`; 
    return; 
  }
  
  c.innerHTML = f.map(i => {
    if (i.category === 'doctor') {
      return `
      <div class="bg-white border border-slate-100 rounded-[2rem] p-5 shadow-sm mb-4 card-hover relative overflow-hidden group">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-500 opacity-80"></div>
          <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-50 pl-3">
              <div class="flex items-center gap-3">
                  <span class="text-xs font-bold bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-mono">${i.date}</span>
                  <span class="text-sm font-black text-slate-700">醫師看診</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-3">
                  <div class="flex items-center gap-1"><span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.doctor||'--'}</div>
                  <div class="flex items-center gap-1"><span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.nurse||'--'}</div>
              </div>
          </div>
          <div class="pl-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm mb-2">
              <div class="bg-blue-50/40 p-2.5 rounded-xl border border-blue-50"><span class="text-blue-600 font-black text-xs mr-1">S</span> <span class="text-slate-700 leading-snug">${i.s||'--'}</span></div>
              <div class="bg-indigo-50/40 p-2.5 rounded-xl border border-indigo-50"><span class="text-indigo-600 font-black text-xs mr-1">O</span> <span class="text-slate-700 leading-snug">${i.o||'--'}</span></div>
              <div class="bg-amber-50/40 p-2.5 rounded-xl border border-amber-50"><span class="text-amber-600 font-black text-xs mr-1">A</span> <span class="text-slate-700 leading-snug">${i.a||'--'}</span></div>
              <div class="bg-emerald-50/40 p-2.5 rounded-xl border border-emerald-50"><span class="text-emerald-600 font-black text-xs mr-1">P</span> <span class="text-slate-700 leading-snug">${i.p||'--'}</span></div>
          </div>
          <div class="pl-3 space-y-2">
              ${i.nursingRecord && i.nursingRecord !== '--' ? `<div class="bg-rose-50/50 p-3 rounded-xl text-sm border border-rose-100"><div class="flex items-center gap-1.5 mb-1 text-rose-600 font-black text-xs"><span class="material-icons-outlined text-[14px]">favorite</span> 護理紀錄</div><div class="text-slate-600 leading-snug whitespace-pre-wrap pl-1">${i.nursingRecord}</div></div>` : ''}
              ${i.remark && i.remark !== '--' ? `<div class="bg-slate-50 p-2.5 rounded-xl text-xs text-slate-500 border border-slate-100 flex gap-2 items-start"><span class="font-bold shrink-0 bg-slate-200 px-1.5 rounded text-[10px] text-slate-600">Note</span><span class="leading-snug">${i.remark}</span></div>` : ''}
          </div>
      </div>`;
    } 
    else if (i.category === 'treatment') {
      return `
      <div class="bg-white border border-slate-100 rounded-[2rem] p-5 shadow-sm mb-4 card-hover relative overflow-hidden group">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-500 opacity-80"></div>
          <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-50 pl-3">
              <div class="flex items-center gap-3">
                  <span class="text-xs font-bold bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full font-mono">${i.date}</span>
                  <span class="text-sm font-black text-slate-700">治療紀錄</span>
                  ${i.item ? `<span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded border border-slate-200">${i.item}</span>` : ''}
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1">
                  <span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 space-y-3">
              ${i.complaint ? `<div><div class="text-[10px] font-bold text-slate-400 mb-1">當日主訴</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${i.complaint}</div></div>` : ''}
              <div><div class="text-[10px] font-bold text-slate-400 mb-1">治療內容</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${i.content}</div></div>
              ${i.nextPlan ? `<div class="bg-amber-50 p-2.5 rounded-xl border border-amber-100"><div class="text-[10px] font-bold text-amber-500 uppercase tracking-wider mb-1 flex items-center gap-1"><span class="material-icons-outlined text-[10px]">flag</span> 備註 / 下次治療</div><div class="text-xs text-slate-600 whitespace-pre-wrap leading-snug">${i.nextPlan}</div></div>` : ''}
          </div>
      </div>`;
    }
    else if (i.category === 'maintenance') {
      return `
      <div class="bg-white border border-slate-100 rounded-[2rem] p-5 shadow-sm mb-4 card-hover relative overflow-hidden group">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-orange-400 opacity-80"></div>
          <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-50 pl-3">
              <div class="flex items-center gap-3">
                  <span class="text-xs font-bold bg-orange-50 text-orange-600 px-3 py-1 rounded-full font-mono">${i.date}</span>
                  <span class="text-sm font-black text-slate-700">${i.item||'保養'}</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1">
                  <span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 grid grid-cols-4 gap-2 mb-2">
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center"><span class="text-[9px] font-bold text-slate-400">BP</span><span class="text-xs font-black text-slate-700">${i.bp||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center"><span class="text-[9px] font-bold text-slate-400">SpO2</span><span class="text-xs font-black text-slate-700">${i.spo2||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center"><span class="text-[9px] font-bold text-slate-400">HR</span><span class="text-xs font-black text-slate-700">${i.hr||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center"><span class="text-[9px] font-bold text-slate-400">Temp</span><span class="text-xs font-black text-slate-700">${i.temp||'-'}</span></div>
          </div>
          ${i.remark && i.remark !== '--' ? `<div class="pl-3 mt-2"><div class="text-xs text-slate-600 bg-orange-50/50 p-2.5 rounded-xl border border-orange-100 flex gap-2 items-start"><span class="font-bold text-orange-400 shrink-0 text-[10px] pt-0.5">NOTE</span><span class="leading-snug whitespace-pre-wrap">${i.remark}</span></div></div>` : ''}
      </div>`;
    }
    else if (i.category === 'tracking') {
      return `
      <div class="bg-white border border-slate-100 rounded-[2rem] p-5 shadow-sm mb-4 card-hover relative overflow-hidden group">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-violet-500 opacity-80"></div>
          <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-50 pl-3">
              <div class="flex items-center gap-3">
                  <span class="text-xs font-bold bg-violet-50 text-violet-600 px-3 py-1 rounded-full font-mono">${i.date}</span>
                  <span class="text-xs font-bold text-white bg-violet-400 px-2 py-0.5 rounded-md">${i.type||'追蹤'}</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1">
                  <span class="material-icons-outlined text-sm text-slate-400">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 text-sm text-slate-700 leading-relaxed whitespace-pre-line">${i.content}</div>
      </div>`;
    }
    return '';
  }).join('');
}

function setOverviewCategory(cat) {
  currentOverviewCategory = cat;
  ['all', 'doctor', 'maintenance', 'tracking', 'treatment'].forEach(b => {
    const el = document.getElementById('filter-btn-' + b);
    if(b === cat) { el.className = "px-4 py-2 rounded-xl text-sm font-bold bg-slate-800 text-white shadow-md transform scale-105 transition-all"; }
    else { el.className = "px-4 py-2 rounded-xl text-sm font-bold text-slate-500 hover:bg-white hover:text-slate-700 transition-all"; }
  });
  renderOverviewList();
}
function getFilteredOverviewData() {
  const s = document.getElementById('overviewStartDate').value; const e = document.getElementById('overviewEndDate').value;
  return allOverviewRecords.filter(i => { if (currentOverviewCategory !== 'all' && i.category !== currentOverviewCategory) return false; if (s && i.date < s) return false; if (e && i.date > e) return false; return true; });
}
function exportOverviewToCSV() {
  const d = getFilteredOverviewData(); if (!d.length) { alert("無資料"); return; }
  const r = d.map(i => [`"${i.date}"`, `"${i.categoryName}"`, `"${(i.title+' '+i.subtitle).replace(/"/g,'""')}"`, `"${(i.detail||'').replace(/"/g,'""')}"`, `"${i.staff||''}"`].join(','));
  const b = new Blob(["\uFEFF日期,類別,標題,內容,人員\n" + r.join("\n")], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `${currentClient['姓名']}_歷程.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function printOverviewReport() { handlePrint(); } // 修改為呼叫新的 handlePrint

// ==========================================
// 工具函式與月曆
// ==========================================
function resetSearch() { currentClient = null; document.getElementById('topBarClientInfo').classList.add('hidden'); navTo('search'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }

function renderTreatmentCalendar() {
  const c = document.getElementById('treatmentCalendar'); if(!c) return;
  const y = currentCalDate.getFullYear(); const m = currentCalDate.getMonth();
  let h = '';
  if (isMonthPickerMode) {
    const activeMs = new Set(); allTreatmentLogs.forEach(l => { const p = l['治療日期'].split('-'); if(parseInt(p[0])===y) activeMs.add(parseInt(p[1])-1); });
    h = `<div class="cal-header"><button onclick="changePickerYear(-1)" class="p-1 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-emerald-500 transition"><span class="material-icons-outlined text-sm">chevron_left</span></button><div class="cal-title-btn bg-slate-100 text-emerald-600" onclick="toggleMonthPicker()"><span>${y}年</span><span class="material-icons-outlined text-xs">unfold_less</span></div><button onclick="changePickerYear(1)" class="p-1 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-emerald-500 transition"><span class="material-icons-outlined text-sm">chevron_right</span></button></div><div class="cal-month-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;">`;
    for(let i=0; i<12; i++) h+=`<div onclick="selectMonthFromPicker(${i})" class="cal-month-item ${i===m?'is-current':''} ${activeMs.has(i)?'has-record':''}">${i+1}月</div>`;
    h += `</div>`;
  } else {
    const sel = document.getElementById('filterDate').value; const recs = new Set(allTreatmentLogs.map(l => l['治療日期']));
    h = `<div class="cal-header"><button onclick="changeCalMonth(-1)" class="p-1 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-emerald-500 transition"><span class="material-icons-outlined text-sm">chevron_left</span></button><div class="cal-title-btn" onclick="toggleMonthPicker()"><span>${y}年 ${m+1}月</span><span class="material-icons-outlined text-xs text-slate-300">expand_more</span></div><button onclick="changeCalMonth(1)" class="p-1 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-emerald-500 transition"><span class="material-icons-outlined text-sm">chevron_right</span></button></div><div class="cal-grid"><div class="cal-weekday text-red-400">日</div><div class="cal-weekday">一</div><div class="cal-weekday">二</div><div class="cal-weekday">三</div><div class="cal-weekday">四</div><div class="cal-weekday">五</div><div class="cal-weekday">六</div>`;
    const fd = new Date(y, m, 1).getDay(); const dim = new Date(y, m+1, 0).getDate();
    for(let i=0; i<fd; i++) h+=`<div class="cal-day other-month"></div>`;
    for(let d=1; d<=dim; d++) { const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; h+=`<div onclick="selectDateFromCal('${ds}')" class="cal-day ${ds===sel?'is-selected':''} ${recs.has(ds)?'has-record':''}">${d}</div>`; }
    h += `</div>`;
  }
  c.innerHTML = h;
}
function toggleMonthPicker() { isMonthPickerMode = !isMonthPickerMode; renderTreatmentCalendar(); }
function changePickerYear(o) { currentCalDate.setFullYear(currentCalDate.getFullYear() + o); renderTreatmentCalendar(); }
function selectMonthFromPicker(m) { currentCalDate.setMonth(m); isMonthPickerMode = false; renderTreatmentCalendar(); }
function changeCalMonth(o) { currentCalDate.setMonth(currentCalDate.getMonth() + o); renderTreatmentCalendar(); }
function selectDateFromCal(d) { const i = document.getElementById('filterDate'); if(i._flatpickr) i._flatpickr.setDate(d, true); else { i.value = d; applyLogFilters(); } renderTreatmentCalendar(); }
function resetTreatmentFilter() { document.getElementById('filterTherapist').value = ""; const i = document.getElementById('filterDate'); if(i._flatpickr) i._flatpickr.clear(); else i.value = ""; applyLogFilters(); isMonthPickerMode = false; currentCalDate = new Date(); renderTreatmentCalendar(); }
function editClientInfo() { alert("編輯功能開發中..."); }
function applyLogFilters() { const t=document.getElementById('filterTherapist').value; const d=document.getElementById('filterDate').value; renderTreatmentList(allTreatmentLogs.filter(l => (!t || l['執行治療師']===t) && (!d || l['治療日期']===d))); }

// ==========================================
// 影像功能 (上傳與檢視)
// ==========================================
function loadClientImages() {
  const c = document.getElementById('imageGalleryContainer');
  const st = document.getElementById('img-stats-text');
  if (!currentClient) return;
  c.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-300"><span class="material-icons-outlined text-4xl animate-spin mb-3">sync</span><p>讀取影像中...</p></div>`;
  google.script.run.withSuccessHandler(res => {
    if (res.success) { renderImageGallery(res.images); st.textContent = `共 ${res.images.length} 張影像紀錄`; }
    else { c.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-16 bg-red-50 rounded-[2rem] border border-red-100 text-red-400 gap-3"><span class="material-icons-outlined text-4xl">error_outline</span><p>${res.message}</p></div>`; st.textContent = "讀取失敗"; }
  }).getClientImages(currentClient['個案編號']);
}
function renderImageGallery(imgs) {
  const c = document.getElementById('imageGalleryContainer');
  if (!imgs || imgs.length === 0) { c.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-24 bg-white border-2 border-dashed border-slate-200 rounded-[2.5rem] group hover:border-emerald-300 transition-colors"><div class="p-4 bg-slate-50 rounded-full mb-4 text-slate-300 group-hover:text-emerald-400 transition-colors"><span class="material-icons-outlined text-3xl">add_photo_alternate</span></div><p class="text-slate-400 font-bold mb-2">尚無影像紀錄</p><button onclick="openUploadModal()" class="text-emerald-500 font-bold text-sm hover:text-emerald-600 transition">立即上傳</button></div>`; return; }
  c.innerHTML = imgs.map(i => `<div class="group relative bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden card-hover cursor-pointer" onclick="openLightbox('${i.id}', '${i.name}')"><div class="aspect-square bg-slate-50 relative overflow-hidden"><img src="${i.thumbnail}" loading="lazy" class="w-full h-full object-cover transition duration-500 group-hover:scale-105" alt="${i.name}" onerror="this.src='https://via.placeholder.com/400?text=Error'"><div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-all"></div></div><div class="p-4"><div class="flex justify-between items-start"><div class="text-xs font-bold text-slate-400 mb-1">${i.date}</div><span class="material-icons-outlined text-slate-300 text-sm group-hover:text-emerald-500 transition-colors z-10 hover:bg-slate-100 rounded" onclick="event.stopPropagation(); window.open('${i.url}', '_blank')">open_in_new</span></div><h4 class="text-sm font-bold text-slate-700 truncate" title="${i.name}">${i.name}</h4></div></div>`).join('');
}

function openUploadModal() {
  if (!currentClient) { alert("請先選擇個案"); return; }
  document.getElementById('uploadImageModal').classList.remove('hidden');
  document.getElementById('uploadInput').value = "";
  document.getElementById('previewList').innerHTML = "";
  document.getElementById('fileRemark').value = ""; // 清空備註
  document.getElementById('uploadPreviewArea').classList.add('hidden');
  filesToUpload = [];
}
function previewFiles(input) {
  const files = input.files;
  if (!files || files.length === 0) return;
  const listEl = document.getElementById('previewList');
  document.getElementById('uploadPreviewArea').classList.remove('hidden');
  filesToUpload = Array.from(files);
  listEl.innerHTML = filesToUpload.map(f => `<div class="flex items-center justify-between bg-white p-3 rounded-xl border border-slate-100 shadow-sm"><div class="flex items-center gap-3 overflow-hidden"><div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-500"><span class="material-icons-outlined text-base">image</span></div><span class="text-sm font-bold text-slate-600 truncate">${f.name}</span></div><span class="text-xs text-slate-400 font-mono">${(f.size/1024/1024).toFixed(1)} MB</span></div>`).join('');
}
function startUpload() {
  if (filesToUpload.length === 0) { alert("請選擇檔案"); return; }
  const remark = document.getElementById('fileRemark').value.trim(); // 取得備註
  const btn = document.getElementById('btnStartUpload');
  const ot = btn.innerHTML;
  let count = 0; const total = filesToUpload.length;
  btn.disabled = true; btn.innerHTML = `<span class="material-icons-outlined animate-spin mr-2 text-sm">sync</span> 上傳中 (0/${total})...`;
  const next = (idx) => {
    if (idx >= total) { btn.disabled = false; btn.innerHTML = ot; alert("上傳完成！"); closeModal('uploadImageModal'); loadClientImages(); return; }
    const f = filesToUpload[idx]; const r = new FileReader();
    r.onload = function(e) {
      const content = e.target.result.split(',')[1];
      // ★★★ 修正處：傳入 remark 參數 ★★★
      google.script.run
        .withSuccessHandler(() => { count++; btn.innerHTML = `<span class="material-icons-outlined animate-spin mr-2 text-sm">sync</span> 上傳中 (${count}/${total})...`; next(idx + 1); })
        .uploadClientImage(currentClient['個案編號'], content, f.name, f.type, remark);
    };
    r.readAsDataURL(f);
  };
  next(0);
}

// ==========================================
// Lightbox 燈箱
// ==========================================
function openLightbox(id, name) {
    const modal = document.getElementById('imageLightbox');
    const img = document.getElementById('lightboxImage');
    const loading = document.getElementById('lightboxLoading');
    const titleDiv = document.getElementById('lightboxTitle');
    if (!modal || !img) return;
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    img.style.opacity = '0';
    img.style.transform = 'scale(0.95)';
    img.src = ""; 
    if (titleDiv) titleDiv.textContent = name || '';
    const highResUrl = `https://lh3.googleusercontent.com/d/${id}=s0`;
    img.onload = function() {
        loading.classList.add('hidden');
        img.style.opacity = '1';
        img.style.transform = 'scale(1)';
    };
    img.src = highResUrl;
    document.body.style.overflow = 'hidden'; 
}
function closeLightbox() {
    const modal = document.getElementById('imageLightbox');
    if (modal) modal.classList.add('hidden');
    const img = document.getElementById('lightboxImage');
    if (img) img.src = '';
    document.body.style.overflow = ''; 
}
document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") closeLightbox();
});
</script>