<script>
// ==========================================
// 全域變數宣告
// ==========================================
let currentClient = null;
let allTreatmentLogs = [];
let allOverviewRecords = []; 
let currentOverviewCategory = 'all'; 
let filesToUpload = []; 
let searchTimer = null;
let allCalendarEvents = []; 

// ==========================================
// 初始化與 UI 設定
// ==========================================

function setupEnhancedFlatpickr(selector, options = {}) {
  const defaults = {
    locale: "zh_tw", 
    dateFormat: "Y-m-d", 
    disableMobile: true, 
    allowInput: true, 
    static: false, 
    position: "auto center",
    onDayCreate: function(dObj, dStr, fp, dayElem) {
      if (!dayElem || !dayElem.dateObj) return;
      const dateKey = dayElem.dateObj.toISOString().split('T')[0];
      const dayEvents = allCalendarEvents.filter(e => e.date === dateKey);
      
      if (dayEvents.length > 0) {
        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'dots-container';
        const categories = [...new Set(dayEvents.map(e => e.category))];
        
        categories.forEach(cat => {
          const dot = document.createElement('div');
          dot.className = 'cal-dot';
          if (cat === 'treatment') dot.classList.add('dot-treatment');
          else if (cat === 'maintenance') dot.classList.add('dot-maintenance');
          else if (cat === 'doctor') dot.classList.add('dot-doctor');
          else if (cat === 'tracking') dot.classList.add('dot-tracking');
          dotsContainer.appendChild(dot);
        });
        dayElem.appendChild(dotsContainer);
      }
    }
  };
  return flatpickr(selector, { ...defaults, ...options });
}

window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('#treatmentDate, #maintenanceDate, #doctorConsultDate, #trackDate').forEach(el => el.value = today);
  setupEnhancedFlatpickr('input[type="date"], #trackDate');
  
  const overviewConfig = { onChange: function() { renderOverviewList(); } };
  setupEnhancedFlatpickr('#overviewStartDate', overviewConfig);
  setupEnhancedFlatpickr('#overviewEndDate', overviewConfig);
  
  loadSystemStaff();
  loadTreatmentItems();
};

function loadSystemStaff() {
  if (typeof google === 'undefined' || !google.script) return;
  google.script.run.withSuccessHandler(staff => {
    const setOptions = (id, list, placeholder) => {
      const el = document.getElementById(id);
      if(el) { el.innerHTML = `<option value="" disabled selected>${placeholder}</option>` + list.map(n => `<option value="${n}">${n}</option>`).join(''); }
    };
    setOptions('selectDoctor', staff.doctors, '請選擇醫師');
    setOptions('selectNurse', staff.nurses, '請選擇護理師');
    setOptions('inputTherapist', staff.therapists, '請選擇治療師');
    setOptions('selectMaintStaff', staff.allStaff, '請選擇執行人員');
    setOptions('selectMaintItem', staff.maintItems, '請選擇項目');
    setOptions('trackStaff', staff.allStaff, '請選擇人員');
    setOptions('trackType', staff.trackingTypes || [], '請選擇項目');
    setOptions('addTherapist', staff.therapists, '請選擇負責治療師');
    setOptions('inputTreatmentItem', staff.treatmentItems, '請選擇項目');
  }).getSystemStaff();
}

function loadTreatmentItems() {
  google.script.run.withSuccessHandler(function(items) {
      var select = document.getElementById("inputTreatmentItem");
      if (select && select.options.length <= 1) {
          select.innerHTML = '<option value="" disabled selected>請選擇項目</option>';
          items.forEach(function(item) {
            var option = document.createElement("option");
            option.value = item;
            option.textContent = item;
            select.appendChild(option);
          });
      }
    }).getTreatmentItemsFromSystem(); 
}

// ==========================================
// 導覽與頁面切換
// ==========================================
function navTo(viewName) {
  if (!currentClient && viewName !== 'search') { 
      showNotification('提示', '請先選取個案以進行操作。', 'info'); 
      return; 
  }
  
  const views = ['search', 'basic', 'images', 'treatment', 'maintenance', 'doctor', 'tracking', 'overview'];
  views.forEach(v => {
    document.getElementById('view-' + v)?.classList.add('hidden');
    document.getElementById('btn-' + v)?.classList.remove('active');
  });
  const target = document.getElementById('view-' + viewName);
  if(target) {
    target.classList.remove('hidden');
    target.classList.add('view-animate'); 
  }
  document.getElementById('btn-' + viewName)?.classList.add('active');
  
  const titles = { 'search':'首頁','basic':'基本資料','images':'影像總覽','treatment':'治療紀錄','maintenance':'保養項目','doctor':'醫師看診','tracking':'個管追蹤','overview':'個案總覽' };
  document.getElementById('pageTitle').textContent = titles[viewName] || '康飛運醫';
  
  if (currentClient) {
    if (['treatment', 'maintenance', 'doctor', 'tracking', 'overview'].includes(viewName)) {
        if (allCalendarEvents.length === 0) {
            fetchCalendarData();
        }
    }
    if(viewName === 'basic') renderBasicInfo();
    if(viewName === 'doctor') loadDoctorHistory();
    if(viewName === 'treatment') loadTreatmentHistory();
    if(viewName === 'maintenance') loadMaintenanceHistory();
    if(viewName === 'tracking') loadTrackingHistory();
    if(viewName === 'overview') loadOverviewData(); 
    if(viewName === 'images') loadClientImages();
  }
}

function fetchCalendarData() {
    google.script.run.withSuccessHandler(data => {
        allCalendarEvents = data || [];
    }).getCaseOverviewData(currentClient['個案編號']);
}

// ==========================================
// 新增個案相關函式
// ==========================================
function autoDetectGender(input) {
  const val = input.value.toUpperCase();
  input.value = val; 
  if (val.length >= 2) {
    const secondChar = val.charAt(1);
    if (secondChar === '1') { } else if (secondChar === '2') { }
  }
}

function submitNewClient() {
  const btn = document.getElementById('btnSubmitClient');
  const originalText = btn.innerHTML;
  
  const data = {
    name: document.getElementById('addName').value.trim(),
    dob: document.getElementById('addDob').value.trim(),
    idNo: document.getElementById('addIdNo').value.trim(),
    phone: document.getElementById('addPhone').value.trim(),
    gender: '', 
    emerName: document.getElementById('addEmerName').value.trim(),
    emerPhone: document.getElementById('addEmerPhone').value.trim(),
    therapist: document.getElementById('addTherapist').value.trim(),
    chronic: document.getElementById('addChronic').value.trim()
  };

  if (!data.name || !data.dob || !data.idNo || !data.phone) { 
      showNotification('資料缺漏', '請填寫所有必填欄位 (*)', 'error'); 
      return; 
  }
  if (data.idNo.length < 2) { 
      showNotification('格式錯誤', '身分證字號格式錯誤', 'error'); 
      return; 
  }
  
  const secondChar = data.idNo.charAt(1);
  if (secondChar === '1') data.gender = '男';
  else if (secondChar === '2') data.gender = '女';
  else data.gender = '其他';

  btn.disabled = true;
  btn.innerHTML = '<span class="material-icons-outlined animate-spin">sync</span> 建立中...';

  google.script.run
    .withSuccessHandler(function(res) {
      btn.disabled = false;
      btn.innerHTML = originalText;
      if (res.success) { 
          showNotification('成功', '個案建立成功！', 'success'); 
          document.getElementById('addClientForm').reset(); 
          closeModal('addClientModal'); 
          selectClient(res.fullData); 
      } 
      else { 
          showNotification('建立失敗', res.message, 'error'); 
      }
    })
    .withFailureHandler(function(e) { 
        btn.disabled = false; 
        btn.innerHTML = originalText; 
        showNotification('系統錯誤', e.message, 'error'); 
    })
    .createNewClient(data);
}

// ==========================================
// 列印功能
// ==========================================
function handlePrint() {
  const today = new Date();
  const dateStr = today.getFullYear() + "-" + 
                  String(today.getMonth() + 1).padStart(2, '0') + "-" + 
                  String(today.getDate()).padStart(2, '0');
  const dateEl = document.getElementById('print-date-display');
  if(dateEl) dateEl.innerText = dateStr;
  const infoEl = document.getElementById('print-patient-info');
  if (infoEl) {
      if (currentClient) { infoEl.innerText = `${currentClient['姓名']} - ${currentClient['生日']}`; } 
      else { infoEl.innerText = "個案列表"; }
  }
  window.print();
}

// ==========================================
// 基本資料渲染
// ==========================================
function renderBasicInfo() {
  if(!currentClient) return;
  const fieldMap = {
    'display-client-id': '個案編號',
    'display-name': '姓名',
    'display-gender': '性別',
    'display-birthday': '生日',
    'display-id-number': '身分證字號',
    'display-phone': '電話',
    'display-emergency-name': '緊急聯絡人',
    'display-emergency-phone': '緊急聯絡人電話',
    'display-therapist': '負責治療師',
    'display-notes': '慢性病或特殊疾病'
  };
  for (const [domId, dbKey] of Object.entries(fieldMap)) {
    const el = document.getElementById(domId);
    if(el) {
       if(domId === 'display-notes' && (!currentClient[dbKey] || currentClient[dbKey] === '')) continue;
       el.textContent = currentClient[dbKey] || '--';
    }
  }
  const statusEl = document.getElementById('display-status');
  if(statusEl && currentClient['狀態']) statusEl.textContent = currentClient['狀態'];
}

// ==========================================
// 搜尋功能
// ==========================================
function handleSearchDebounced(val) {
  const kw = val.trim();
  const container = document.getElementById('searchResults');
  if (searchTimer) clearTimeout(searchTimer);
  if (!kw) { container.innerHTML = ''; return; }
  searchTimer = setTimeout(() => { handleSearch(kw); }, 400); 
}

function handleSearch(keyword) {
  const kw = keyword || document.getElementById('searchInput').value.trim();
  if (!kw) return; 
  const container = document.getElementById('searchResults');
  container.innerHTML = '<div class="text-center py-8 text-slate-400 flex flex-col items-center gap-2"><span class="material-icons-outlined animate-spin">sync</span><span>搜尋中...</span></div>';
  
  google.script.run.withSuccessHandler(data => {
      container.innerHTML = '';
      if(data.length === 0) { container.innerHTML = '<div class="text-center py-6 text-slate-400 bg-white rounded-2xl border border-slate-100 shadow-sm">查無此個案資料</div>'; return; }
      
      data.forEach(c => {
        const div = document.createElement('div');
        div.className = "bg-white p-5 rounded-3xl shadow-sm border border-slate-100 hover:border-emerald-400 hover:shadow-md cursor-pointer transition-all flex justify-between items-center group mb-3 relative overflow-hidden";
        div.onclick = () => selectClient(c);
        div.innerHTML = `
          <div class="absolute left-0 top-0 bottom-0 w-1 bg-emerald-500 opacity-0 group-hover:opacity-100 transition-opacity"></div>
          <div class="pl-2"> 
            <div class="font-black text-slate-800 text-lg flex items-center gap-2">
              ${c['姓名']} 
              <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100 flex items-center gap-1">
                <span class="material-icons-outlined text-[10px]">cake</span> ${c['生日']}
              </span>
            </div>
            <div class="text-sm text-slate-400 mt-1 flex items-center gap-1 font-mono">
              <span class="material-icons-outlined text-[14px]">phone</span> ${c['電話']}
            </div>
          </div>
          <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-300 group-hover:bg-emerald-500 group-hover:text-white transition-all">
            <span class="material-icons-outlined">arrow_forward</span>
          </div>`;
        container.appendChild(div);
      });
  }).searchClient(kw);
}

function selectClient(c) {
  currentClient = c;
  allCalendarEvents = [];
  
  document.getElementById('topBarClientInfo').classList.remove('hidden');
  document.getElementById('headerClientName').textContent = c['姓名'];
  document.getElementById('headerClientDob').textContent = c['生日'];
  document.querySelectorAll('.auto-fill-id').forEach(el => el.value = c['個案編號']);
  
  const therapistSelect = document.getElementById('inputTherapist');
  if (therapistSelect) {
      therapistSelect.value = c['負責治療師'] || ""; 
  }
  const itemSelect = document.getElementById('inputTreatmentItem');
  if (itemSelect) {
      itemSelect.value = "1600";
  }
  navTo('treatment');
}

// ==========================================
// ★★★ 編輯功能相關函式 (修復 ID 判斷) ★★★
// ==========================================

function findIdFromData(data) {
    if (!data) return "";
    const candidates = ['紀錄id', '紀錄ID', '追蹤ID', '追蹤id', '影像ID', '影像id', 'id', 'ID', 'Id', 'RecordId', 'record_id'];
    for (const key of candidates) {
        if (data[key] !== undefined && data[key] !== "") return data[key];
    }
    const keys = Object.keys(data);
    for (const key of keys) {
        const cleanKey = key.replace(/\s+/g, '').toLowerCase();
        if (cleanKey === '紀錄id' || cleanKey === '追蹤id' || cleanKey === '影像id' || cleanKey === 'id') {
            return data[key];
        }
    }
    if (Array.isArray(data) && data.length > 0) return data[0];
    return "";
}

function startEdit(type, data) {
  console.log("Start Edit Data:", data); 

  let id = findIdFromData(data);
  
  if (!id) {
     showNotification('資料錯誤', '無法讀取此筆紀錄的 ID。請確認資料庫中是否有「紀錄id」或「追蹤ID」欄位。', 'error');
     console.error("ID not found in object:", data);
     return;
  }
  
  const idField = document.getElementById('edit_id_' + type);
  if (idField) idField.value = id;

  const cancelDiv = document.getElementById('edit-cancel-' + type);
  if (cancelDiv) cancelDiv.classList.remove('hidden');

  const submitBtn = getSubmitBtn(type);
  if (submitBtn) {
    if (!submitBtn.hasAttribute('data-original-text')) {
       submitBtn.setAttribute('data-original-text', submitBtn.innerHTML);
    }
    submitBtn.innerHTML = '<span class="material-icons-outlined text-lg mr-1">update</span> 確認更新修改';
    submitBtn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600', 'bg-violet-600', 'hover:bg-violet-700', 'bg-gradient-to-r', 'from-orange-400', 'to-orange-600', 'hover:from-orange-500', 'hover:to-orange-700');
    submitBtn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'text-white');
  }

  try {
    if (type === 'treatment') {
        if(document.getElementById('treatmentDate')._flatpickr)
        document.getElementById('treatmentDate')._flatpickr.setDate(data['治療日期'] || data['date']);
        
        document.getElementById('inputTherapist').value = data['執行治療師'] || data['therapist'] || "";
        document.getElementById('inputTreatmentItem').value = data['治療項目'] || data['item'] || "";
        document.getElementById('inputComplaint').value = data['當日主訴'] || data['complaint'] || "";
        document.getElementById('inputContent').value = data['治療內容'] || data['content'] || "";
        document.getElementById('inputNextPlan').value = data['備註/下次治療'] || data['nextPlan'] || "";
        
        document.getElementById('view-treatment').scrollIntoView({ behavior: 'smooth' });
    } 
    else if (type === 'doctor') {
        if(document.getElementById('doctorConsultDate')._flatpickr)
        document.getElementById('doctorConsultDate')._flatpickr.setDate(data['看診日期']);
        
        document.getElementById('selectDoctor').value = data['看診醫師'] || "";
        document.getElementById('selectNurse').value = data['護理師'] || "";
        document.querySelector('#view-doctor textarea[name="主訴"]').value = data['S_主訴'] || "";
        document.querySelector('#view-doctor textarea[name="客觀檢查"]').value = data['O_客觀檢查'] || "";
        document.querySelector('#view-doctor textarea[name="診斷"]').value = data['A_診斷'] || "";
        document.querySelector('#view-doctor textarea[name="治療計畫"]').value = data['P_治療計劃'] || "";
        document.getElementById('nursingRecord').value = data['護理紀錄'] || "";
        document.getElementById('doctorRemark').value = data['備註'] || "";
        document.getElementById('view-doctor').scrollIntoView({ behavior: 'smooth' });
    }
    else if (type === 'maintenance') {
        if(document.getElementById('maintenanceDate')._flatpickr)
        document.getElementById('maintenanceDate')._flatpickr.setDate(data['保養日期']);
        
        document.getElementById('selectMaintStaff').value = data['執行人員'] || "";
        document.getElementById('selectMaintItem').value = data['保養項目'] || "";
        const f = document.getElementById('maintenanceForm');
        f.querySelector('input[name="血壓"]').value = data['血壓'] || "";
        f.querySelector('input[name="血氧"]').value = data['血氧'] || "";
        f.querySelector('input[name="心律"]').value = data['心律'] || "";
        f.querySelector('input[name="體溫"]').value = data['體溫'] || "";
        f.querySelector('textarea[name="備註"]').value = data['備註'] || "";
        document.getElementById('view-maintenance').scrollIntoView({ behavior: 'smooth' });
    }
    else if (type === 'tracking') {
        if(document.getElementById('trackDate')._flatpickr)
        document.getElementById('trackDate')._flatpickr.setDate(data.date || data['追蹤日期']);
        
        document.getElementById('trackStaff').value = data.staff || data['追蹤人員'] || "";
        document.getElementById('trackType').value = data.type || data['追蹤項目'] || "";
        document.getElementById('trackContent').value = data.content || data['追蹤內容'] || "";
        document.getElementById('view-tracking').scrollIntoView({ behavior: 'smooth' });
    }
  } catch(e) {
      console.error("Error populating form:", e);
  }
}

function cancelEdit(type) {
  document.getElementById('edit_id_' + type).value = "";
  document.getElementById('edit-cancel-' + type).classList.add('hidden');
  
  if(type === 'tracking') {
      document.getElementById('trackingForm').reset();
  } else {
      document.getElementById(type + 'Form').reset();
  }
  
  const today = new Date();
  if(type === 'treatment' && document.getElementById('treatmentDate')._flatpickr) document.getElementById('treatmentDate')._flatpickr.setDate(today);
  if(type === 'doctor' && document.getElementById('doctorConsultDate')._flatpickr) document.getElementById('doctorConsultDate')._flatpickr.setDate(today);
  if(type === 'maintenance' && document.getElementById('maintenanceDate')._flatpickr) document.getElementById('maintenanceDate')._flatpickr.setDate(today);
  if(type === 'tracking' && document.getElementById('trackDate')._flatpickr) document.getElementById('trackDate')._flatpickr.setDate(today);

  document.querySelectorAll('.auto-fill-id').forEach(el => el.value = currentClient ? currentClient['個案編號'] : "");

  const submitBtn = getSubmitBtn(type);
  if (submitBtn) {
    if (submitBtn.hasAttribute('data-original-text')) {
       submitBtn.innerHTML = submitBtn.getAttribute('data-original-text');
    } else {
       submitBtn.innerHTML = "儲存紀錄"; 
    }
    submitBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600', 'text-white');
    
    if(type === 'tracking') {
        submitBtn.classList.add('bg-violet-600', 'hover:bg-violet-700', 'text-white');
    } else if(type === 'maintenance') {
        submitBtn.classList.add('bg-gradient-to-r', 'from-orange-400', 'to-orange-600', 'hover:from-orange-500', 'hover:to-orange-700', 'text-white');
    } else {
        submitBtn.classList.add('bg-emerald-500', 'hover:bg-emerald-600', 'text-white');
    }
  }
}

function getSubmitBtn(type) {
  if (type === 'tracking') return document.querySelector('#trackingForm button[type="submit"]');
  if (type === 'maintenance') return document.querySelector('#maintenanceForm button[onclick*="submitForm"]');
  if (type === 'doctor') return document.querySelector('#doctorForm button[onclick*="submitForm"]');
  if (type === 'treatment') return document.querySelector('#treatmentForm button[onclick*="submitForm"]');
  return null;
}

// ==========================================
// 表單提交 (★ 修改版：支援編輯模式)
// ==========================================
function submitForm(type) {
  if (!currentClient) { 
      showNotification('流程錯誤', '未選取個案，請重新搜尋。', 'error'); 
      return; 
  }
  
  const clientId = currentClient['個案編號'];
  const editIdField = document.getElementById('edit_id_' + type);
  const editId = editIdField ? editIdField.value : "";
  const isEdit = (editId && editId !== "");

  let btn = null;
  if(type === 'tracking') btn = document.querySelector('#trackingForm button[type="submit"]');
  else if(event && event.target) btn = event.target;
  const safeBtn = getSubmitBtn(type);
  if(safeBtn) btn = safeBtn;

  const ot = btn ? btn.innerHTML : "儲存"; 
  if(btn) { btn.disabled = true; btn.innerHTML = '<span class="material-icons-outlined animate-spin">sync</span> 處理中...'; }
  
  const onSuccess = (res, formId, reloadFunc) => {
      btn.disabled = false; 
      btn.innerHTML = ot;
      if (res.success) { 
          showNotification('成功', res.message, 'success'); 
          if (isEdit) {
             cancelEdit(type);
          } else {
             if(formId) document.getElementById(formId).reset(); 
             document.querySelectorAll('.auto-fill-id').forEach(el => el.value = clientId);
          }
          if(reloadFunc) reloadFunc(); 
          fetchCalendarData(); 
      } else { 
          showNotification('錯誤', res.message, 'error'); 
      }
  };

  let d = {};

  if (type === 'doctor') {
    d = { 
      record_id: editId, 
      clientId: clientId,
      date: document.getElementById('doctorConsultDate').value, 
      doctor: document.getElementById('selectDoctor').value, 
      nurse: document.getElementById('selectNurse').value, 
      complaint: document.querySelector('#view-doctor textarea[name="主訴"]').value, 
      objective: document.querySelector('#view-doctor textarea[name="客觀檢查"]').value, 
      diagnosis: document.querySelector('#view-doctor textarea[name="診斷"]').value, 
      plan: document.querySelector('#view-doctor textarea[name="治療計畫"]').value, 
      nursingRecord: document.getElementById('nursingRecord').value, 
      remark: document.getElementById('doctorRemark').value 
    };
    if (!d.date || !d.doctor) { 
        showNotification('欄位未填', '請填寫日期與醫師', 'warning'); 
        if(btn){btn.disabled=false; btn.innerHTML=ot;} return; 
    }
  } 
  else if (type === 'treatment') {
    d = { 
      record_id: editId,
      '個案編號': clientId,
      '治療日期': document.getElementById('treatmentDate').value, 
      '執行治療師': document.getElementById('inputTherapist').value, 
      '治療項目': document.getElementById('inputTreatmentItem').value,
      '當日主訴': document.getElementById('inputComplaint').value, 
      '治療內容': document.getElementById('inputContent').value, 
      '備註/下次治療': document.getElementById('inputNextPlan').value,
      date: document.getElementById('treatmentDate').value,
      therapist: document.getElementById('inputTherapist').value,
      item: document.getElementById('inputTreatmentItem').value,
      complaint: document.getElementById('inputComplaint').value,
      content: document.getElementById('inputContent').value,
      nextPlan: document.getElementById('inputNextPlan').value
    };
    if (!d['治療日期'] || !d['執行治療師']) { 
        showNotification('欄位未填', '請填寫日期與治療師', 'warning'); 
        if(btn){btn.disabled=false; btn.innerHTML=ot;} return; 
    }
  } 
  else if (type === 'maintenance') {
    const f = document.getElementById('maintenanceForm');
    d = { 
      record_id: editId,
      clientId: clientId,
      date: document.getElementById('maintenanceDate').value, 
      staff: document.getElementById('selectMaintStaff').value, 
      item: document.getElementById('selectMaintItem').value, 
      bp: f.querySelector('input[name="血壓"]').value, 
      spo2: f.querySelector('input[name="血氧"]').value, 
      hr: f.querySelector('input[name="心律"]').value, 
      temp: f.querySelector('input[name="體溫"]').value, 
      remark: f.querySelector('textarea[name="備註"]').value 
    };
    if (!d.date || !d.staff || !d.item) { 
        showNotification('欄位未填', '請完整填寫必填欄位', 'warning'); 
        if(btn){btn.disabled=false; btn.innerHTML=ot;} return; 
    }
  } 
  else if (type === 'tracking') {
    d = { 
      record_id: editId,
      clientId: clientId,
      trackDate: document.getElementById('trackDate').value, 
      trackStaff: document.getElementById('trackStaff').value, 
      trackType: document.getElementById('trackType').value, 
      content: document.getElementById('trackContent').value 
    };
    if (!d.trackDate || !d.trackStaff || !d.trackType || !d.content) { 
        showNotification('欄位未填', '請完整填寫追蹤資料', 'warning'); 
        if(btn){btn.disabled=false; btn.innerHTML=ot;} return; 
    }
  }

  if (isEdit) {
     google.script.run
       .withSuccessHandler(res => onSuccess(res, null, getReloadFunc(type)))
       .updateRecord(type, d);
  } else {
     if (type === 'doctor') google.script.run.withSuccessHandler(res => onSuccess(res, 'doctorForm', loadDoctorHistory)).saveDoctorConsultation(d);
     else if (type === 'treatment') google.script.run.withSuccessHandler(res => onSuccess(res, 'treatmentForm', loadTreatmentHistory)).saveData('Treatment_Logs', d); 
     else if (type === 'maintenance') google.script.run.withSuccessHandler(res => onSuccess(res, 'maintenanceForm', loadMaintenanceHistory)).saveMaintenanceRecord(d);
     else if (type === 'tracking') google.script.run.withSuccessHandler(res => { document.getElementById('trackContent').value = ""; onSuccess(res, null, loadTrackingHistory); }).saveTrackingRecord(d);
  }
}

function getReloadFunc(type) {
    if(type === 'treatment') return loadTreatmentHistory;
    if(type === 'doctor') return loadDoctorHistory;
    if(type === 'maintenance') return loadMaintenanceHistory;
    if(type === 'tracking') return loadTrackingHistory;
    return null;
}

// ==========================================
// 歷史列表載入與渲染
// ==========================================

function loadTrackingHistory() {
  const c = document.getElementById('trackingHistoryList'); c.innerHTML = '<div class="text-center py-6 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(recs => {
    if (!recs || !recs.length) { c.innerHTML = `<div class="text-center text-slate-400 py-12 bg-white rounded-[2rem] border border-slate-100"><span class="material-icons-outlined text-4xl mb-2 text-slate-300">history_edu</span><p>尚無任何追蹤紀錄</p></div>`; return; }
    c.innerHTML = recs.map(r => {
      const dataStr = encodeURIComponent(JSON.stringify(r));
      return `
      <div class="bg-white p-3 rounded-[1.5rem] border border-slate-100 shadow-sm card-hover mb-2 relative overflow-hidden group print:break-inside-avoid print:mb-4 print:border print:border-slate-300">
        <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-violet-500 opacity-80 print:hidden"></div>
        <div class="pl-2">
          <div class="flex justify-between items-start mb-1">
            <div class="flex items-center gap-2">
              <span class="bg-violet-50 text-violet-700 text-xs font-bold px-3 py-1 rounded-full border border-violet-100 print:border-slate-300 print:text-black">${r.type}</span>
              <div class="text-slate-500 text-xs font-bold flex items-center bg-slate-50 px-2 py-1 rounded-lg print:bg-white">
                <span class="material-icons-outlined text-[14px] mr-1 text-slate-400 print:hidden">person</span>${r.staff||'--'}
              </div>
              <button onclick="startEdit('tracking', JSON.parse(decodeURIComponent('${dataStr}')))" class="text-slate-300 hover:text-violet-500 transition print:hidden" title="編輯">
                  <span class="material-icons-outlined text-sm">edit</span>
              </button>
            </div>
            <span class="text-slate-400 text-xs font-mono print:text-black">${r.date}</span>
          </div>
          <div class="text-slate-700 text-sm leading-relaxed whitespace-pre-line bg-slate-50/50 p-2 rounded-xl print:bg-white print:p-0">${r.content}</div>
        </div>
      </div>`;
    }).join('');
  }).getTrackingHistory(currentClient['個案編號']);
}

function loadTreatmentHistory() {
  const c = document.getElementById('historyListContainer'); c.innerHTML = '<div class="text-center py-6 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(logs => { 
      allTreatmentLogs = logs || []; 
      renderTreatmentList(allTreatmentLogs); 
  }).getClientHistory(currentClient['個案編號'], 'Treatment_Logs');
}

function renderTreatmentList(logs) {
  const c = document.getElementById('historyListContainer');
  const countBadge = document.getElementById('treatmentHistoryCount');
  if(countBadge) countBadge.textContent = `共 ${logs ? logs.length : 0} 次`;

  if(!logs || !logs.length) { 
    c.innerHTML = '<div class="text-center py-10 text-slate-300 bg-slate-50 rounded-2xl">無相關紀錄</div>'; 
    return; 
  }
  
  c.innerHTML = logs.map(l => {
    const dataStr = encodeURIComponent(JSON.stringify(l));
    return `
    <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 card-hover mb-4 relative overflow-hidden group print:break-inside-avoid print:mb-4 print:border print:border-slate-300">
      <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500 print:hidden"></div>
      <div class="flex justify-between items-center mb-3">
        <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded-lg print:bg-white print:text-black print:border print:border-slate-300">${l['治療日期']}</span>
            <button onclick="startEdit('treatment', JSON.parse(decodeURIComponent('${dataStr}')))" class="text-slate-400 hover:text-emerald-500 transition px-2 print:hidden" title="編輯">
                <span class="material-icons-outlined text-sm">edit</span>
            </button>
        </div>
        
        <div class="flex items-center gap-2">
            ${l['治療項目'] ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100 print:text-black">${l['治療項目']}</span>` : ''}
            <div class="flex items-center gap-1 text-xs font-bold text-slate-500 print:text-black">
              <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span>${l['執行治療師']}
            </div>
        </div>
      </div>
      <div class="space-y-3">
        ${l['當日主訴'] ? `
        <div class="text-xs text-slate-500 bg-slate-50 p-3 rounded-xl border border-slate-100 print:bg-white print:border-0 print:p-0">
          <span class="font-bold text-slate-400 block mb-1 uppercase tracking-widest text-[10px] print:text-black">Complaint</span>${l['當日主訴']}
        </div>` : ''}
        
        <div class="text-sm text-slate-700 whitespace-pre-wrap px-1 print:text-black">${l['治療內容']}</div>
        
        ${l['備註/下次治療']?`<div class="mt-2 text-xs text-slate-600 bg-amber-50 p-3 rounded-xl border border-amber-100 print:bg-white print:border-slate-300"><span class="font-bold text-amber-500 block mb-1 flex items-center gap-1 print:text-black"><span class="material-icons-outlined text-[12px] print:hidden">flag</span> Next Plan</span>${l['備註/下次治療']}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

function loadMaintenanceHistory() {
  const c = document.getElementById('maintenanceHistoryList'); c.innerHTML = '<div class="text-center py-10 text-slate-400">紀錄載入中...</div>';
  google.script.run.withSuccessHandler(logs => {
    if(!logs || !logs.length) { c.innerHTML = '<div class="bg-white/50 border-2 border-dashed border-slate-200 rounded-[2.5rem] p-12 text-center text-slate-300">尚無歷史紀錄</div>'; return; }
    
    c.innerHTML = logs.map(l => {
      const dataStr = encodeURIComponent(JSON.stringify(l));
      return `
      <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 card-hover mb-4 flex flex-col md:flex-row gap-4 items-center print:break-inside-avoid print:mb-4 print:border print:border-slate-300 relative group">
        <button onclick="startEdit('maintenance', JSON.parse(decodeURIComponent('${dataStr}')))" class="absolute top-4 right-4 text-slate-300 hover:text-orange-500 transition print:hidden" title="編輯">
            <span class="material-icons-outlined text-sm">edit</span>
        </button>

        <div class="w-full md:w-auto flex flex-col gap-1 border-b md:border-b-0 md:border-r border-slate-100 pb-4 md:pb-0 md:pr-6 min-w-[140px] print:border-r print:border-slate-300">
          <div class="text-sm font-mono text-slate-500 tracking-tight print:text-black">${l['保養日期']||'--'}</div>
          <span class="px-2.5 py-1 bg-orange-50 text-orange-600 text-[11px] font-bold rounded-lg w-fit mt-1 print:bg-white print:text-black print:border print:border-slate-300">${l['保養項目']||'一般'}</span>
          <div class="text-xs font-bold text-slate-400 flex items-center gap-1 mt-2 print:text-black">
             <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span>${l['執行人員']||'--'}
          </div>
        </div>
        <div class="w-full grid grid-cols-4 gap-2 text-center">
          <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">BP</div><div class="text-sm font-black text-slate-700 print:text-black">${l['血壓']||'-'}</div></div>
          <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">SpO2</div><div class="text-sm font-black text-slate-700 print:text-black">${l['血氧']||'-'}</div></div>
          <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">HR</div><div class="text-sm font-black text-slate-700 print:text-black">${l['心律']||'-'}</div></div>
          <div class="p-2 rounded-xl bg-slate-50 print:bg-white print:border print:border-slate-300"><div class="text-[9px] font-bold text-slate-400 mb-1 print:text-black">Temp</div><div class="text-sm font-black text-slate-700 print:text-black">${l['體溫']||'-'}</div></div>
        </div>
      </div>`;
    }).join('');
  }).getMaintenanceHistory(currentClient['個案編號']);
}

function loadDoctorHistory() {
  const c = document.getElementById('doctorHistoryList'); c.innerHTML = '<div class="text-center py-10 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(logs => {
    if(!logs || !logs.length) { c.innerHTML = '<div class="py-12 text-center text-slate-300 bg-white rounded-[2rem] border border-slate-100">尚無看診紀錄</div>'; return; }
    
    c.innerHTML = logs.map(l => {
      const dataStr = encodeURIComponent(JSON.stringify(l));
      return `
      <div class="bg-white border border-slate-100 rounded-[2.5rem] p-4 shadow-sm mb-3 card-hover relative overflow-hidden print:break-inside-avoid print:mb-4 print:border print:border-slate-300 print:p-4 group">
        <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-50 print:mb-2 print:pb-2 print:border-slate-300">
          <div class="flex items-center gap-3">
              <span class="text-xs font-bold bg-emerald-50 text-emerald-600 px-4 py-2 rounded-full font-mono print:bg-white print:text-black print:border print:border-slate-300">${l['看診日期']||'--'}</span>
              <button onclick="startEdit('doctor', JSON.parse(decodeURIComponent('${dataStr}')))" class="text-slate-300 hover:text-emerald-500 transition print:hidden" title="編輯">
                  <span class="material-icons-outlined text-sm">edit</span>
              </button>
          </div>
          <div class="text-sm font-bold text-slate-500 flex items-center gap-4 print:text-black">
            <div class="flex items-center gap-1">
              <span class="material-icons-outlined text-base text-slate-400 print:hidden">person</span> ${l['看診醫師']||'--'}
            </div>
            <div class="flex items-center gap-1">
              <span class="material-icons-outlined text-base text-slate-400 print:hidden">person</span> ${l['護理師']||'--'}
            </div>
          </div>
        </div>
        
        <div class="soap-grid-container grid grid-cols-1 md:grid-cols-2 gap-2 text-sm print:gap-2">
          <div class="bg-blue-50/40 p-2 rounded-[1.5rem] border border-blue-50/50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-1 text-blue-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">S</span> 主訴</div>
             <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['S_主訴']||'--'}</div>
          </div>
          <div class="bg-indigo-50/40 p-2 rounded-[1.5rem] border border-indigo-50/50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-1 text-indigo-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">O</span> 檢查</div>
             <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['O_客觀檢查']||'--'}</div>
          </div>
          <div class="bg-amber-50/40 p-2 rounded-[1.5rem] border border-amber-50/50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-1 text-amber-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-amber-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">A</span> 診斷</div>
             <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['A_診斷']||'--'}</div>
          </div>
          <div class="bg-emerald-50/40 p-2 rounded-[1.5rem] border border-emerald-50/50 print:bg-white print:border-slate-300 print:p-2">
             <div class="flex items-center gap-2 mb-1 text-emerald-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">P</span> 計畫</div>
             <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['P_治療計劃']||'--'}</div>
          </div>
          
          ${l['護理紀錄'] && l['護理紀錄']!=='--' ? `
          <div class="md:col-span-2 bg-rose-50/40 p-2 rounded-[1.5rem] border border-rose-50/50 print:bg-white print:border-slate-300 print:p-2">
              <div class="flex items-center gap-2 mb-1 text-rose-600 font-black print:text-black"><span class="w-6 h-6 rounded-full bg-rose-100 flex items-center justify-center text-xs print:border print:border-black print:bg-white">N</span> 護理紀錄</div>
              <div class="text-slate-600 leading-relaxed pl-1 print:text-black">${l['護理紀錄']}</div>
          </div>` : ''}

          ${l['備註'] && l['備註']!=='--' ? `
          <div class="md:col-span-2 bg-slate-50 p-2 rounded-2xl text-xs text-slate-500 border border-slate-100 flex gap-2 print:bg-white print:border-slate-300 print:p-2">
              <span class="font-bold shrink-0 print:text-black">Note:</span><span class="print:text-black">${l['備註']}</span>
          </div>` : ''}
        </div>
      </div>`;
    }).join('');
  }).getClientHistory(currentClient['個案編號'], 'Doctor_Consultation');
}

// ==========================================
// 個案總覽
// ==========================================
function loadOverviewData() {
  const container = document.getElementById('overviewListContainer'); container.innerHTML = '<div class="text-center py-12 text-slate-400 flex flex-col items-center gap-2"><span class="material-icons-outlined animate-spin">sync</span><span>讀取個案歷程中...</span></div>';
  google.script.run.withSuccessHandler(data => { 
      allOverviewRecords = data || []; 
      allCalendarEvents = data || []; 
      renderOverviewList(); 
  }).withFailureHandler(err => { container.innerHTML = `<div class="text-red-500 text-center py-10">載入失敗: ${err.message}</div>`; }).getCaseOverviewData(currentClient['個案編號']);
}

function renderOverviewList() {
  const c = document.getElementById('overviewListContainer'); 
  const f = getFilteredOverviewData();
  
  document.getElementById('overviewStats').textContent = `共 ${f.length} 筆紀錄`;
  
  if (!f.length) { 
    c.innerHTML = `<div class="flex flex-col items-center justify-center py-24 bg-white rounded-[2.5rem] border border-slate-100"><div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-300"><span class="material-icons-outlined text-3xl">search_off</span></div><p class="text-slate-400 font-bold">無符合資料</p></div>`; 
    return; 
  }
  
  c.innerHTML = f.map(i => {
    const cardClass = "bg-white border border-slate-100 rounded-[2rem] p-5 shadow-sm mb-4 card-hover relative overflow-hidden group print:break-inside-avoid print:mb-4 print:border-slate-300 print:p-3";
    const headerClass = "flex justify-between items-center mb-3 pb-2 border-b border-slate-50 pl-3 print:mb-1 print:pb-1 print:border-slate-300";
    const badgeClass = "text-xs font-bold px-3 py-1 rounded-full font-mono print:bg-white print:text-black print:border print:border-slate-300";
    
    if (i.category === 'doctor') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-500 opacity-80 print:hidden"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-blue-50 text-blue-600">${i.date}</span>
                  <span class="text-sm font-black text-slate-700 print:text-black">醫師看診</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-3 print:text-black">
                  <div class="flex items-center gap-1"><span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.doctor||'--'}</div>
                  <div class="flex items-center gap-1"><span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.nurse||'--'}</div>
              </div>
          </div>
          <div class="pl-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm mb-2 print:gap-1">
              <div class="bg-blue-50/40 p-2.5 rounded-xl border border-blue-50 print:bg-white print:border-slate-300"><span class="text-blue-600 font-black text-xs mr-1 print:text-black">S</span> <span class="text-slate-700 leading-snug print:text-black">${i.s||'--'}</span></div>
              <div class="bg-indigo-50/40 p-2.5 rounded-xl border border-indigo-50 print:bg-white print:border-slate-300"><span class="text-indigo-600 font-black text-xs mr-1 print:text-black">O</span> <span class="text-slate-700 leading-snug print:text-black">${i.o||'--'}</span></div>
              <div class="bg-amber-50/40 p-2.5 rounded-xl border border-amber-50 print:bg-white print:border-slate-300"><span class="text-amber-600 font-black text-xs mr-1 print:text-black">A</span> <span class="text-slate-700 leading-snug print:text-black">${i.a||'--'}</span></div>
              <div class="bg-emerald-50/40 p-2.5 rounded-xl border border-emerald-50 print:bg-white print:border-slate-300"><span class="text-emerald-600 font-black text-xs mr-1 print:text-black">P</span> <span class="text-slate-700 leading-snug print:text-black">${i.p||'--'}</span></div>
          </div>
          <div class="pl-3 space-y-2">
              ${i.nursingRecord && i.nursingRecord !== '--' ? `<div class="bg-rose-50/50 p-3 rounded-xl text-sm border border-rose-100 print:bg-white print:border-slate-300"><div class="flex items-center gap-1.5 mb-1 text-rose-600 font-black text-xs print:text-black"><span class="material-icons-outlined text-[14px] print:hidden">favorite</span> 護理紀錄</div><div class="text-slate-600 leading-snug whitespace-pre-wrap pl-1 print:text-black">${i.nursingRecord}</div></div>` : ''}
              ${i.remark && i.remark !== '--' ? `<div class="bg-slate-50 p-2.5 rounded-xl text-xs text-slate-500 border border-slate-100 flex gap-2 items-start print:bg-white print:border-slate-300"><span class="font-bold shrink-0 bg-slate-200 px-1.5 rounded text-[10px] text-slate-600 print:bg-white print:text-black print:border">Note</span><span class="leading-snug print:text-black">${i.remark}</span></div>` : ''}
          </div>
      </div>`;
    } 
    else if (i.category === 'treatment') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-500 opacity-80 print:hidden"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-emerald-50 text-emerald-600">${i.date}</span>
                  <span class="text-sm font-black text-slate-700 print:text-black">治療紀錄</span>
                  ${i.item ? `<span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded border border-slate-200 print:bg-white print:text-black">${i.item}</span>` : ''}
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1 print:text-black">
                  <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 space-y-3 print:space-y-1">
              ${i.complaint ? `<div><div class="text-[10px] font-bold text-slate-400 mb-1 print:text-black">當日主訴</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed print:text-black">${i.complaint}</div></div>` : ''}
              <div><div class="text-[10px] font-bold text-slate-400 mb-1 print:text-black">治療內容</div><div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed print:text-black">${i.content}</div></div>
              ${i.nextPlan ? `<div class="bg-amber-50 p-2.5 rounded-xl border border-amber-100 print:bg-white print:border-slate-300"><div class="text-[10px] font-bold text-amber-500 uppercase tracking-wider mb-1 flex items-center gap-1 print:text-black"><span class="material-icons-outlined text-[10px] print:hidden">flag</span> 備註 / 下次治療</div><div class="text-xs text-slate-600 whitespace-pre-wrap leading-snug print:text-black">${i.nextPlan}</div></div>` : ''}
          </div>
      </div>`;
    }
    else if (i.category === 'maintenance') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-orange-400 opacity-80 print:hidden"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-orange-50 text-orange-600">${i.date}</span>
                  <span class="text-sm font-black text-slate-700 print:text-black">${i.item||'保養'}</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1 print:text-black">
                  <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 grid grid-cols-4 gap-2 mb-2">
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center print:bg-white print:border-slate-300"><span class="text-[9px] font-bold text-slate-400 print:text-black">BP</span><span class="text-xs font-black text-slate-700 print:text-black">${i.bp||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center print:bg-white print:border-slate-300"><span class="text-[9px] font-bold text-slate-400 print:text-black">SpO2</span><span class="text-xs font-black text-slate-700 print:text-black">${i.spo2||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center print:bg-white print:border-slate-300"><span class="text-[9px] font-bold text-slate-400 print:text-black">HR</span><span class="text-xs font-black text-slate-700 print:text-black">${i.hr||'-'}</span></div>
              <div class="p-2 rounded-xl bg-slate-50 border border-slate-100 flex flex-col items-center justify-center print:bg-white print:border-slate-300"><span class="text-[9px] font-bold text-slate-400 print:text-black">Temp</span><span class="text-xs font-black text-slate-700 print:text-black">${i.temp||'-'}</span></div>
          </div>
          ${i.remark && i.remark !== '--' ? `<div class="pl-3 mt-2"><div class="text-xs text-slate-600 bg-orange-50/50 p-2.5 rounded-xl border border-orange-100 flex gap-2 items-start print:bg-white print:border-slate-300"><span class="font-bold text-orange-400 shrink-0 text-[10px] pt-0.5 print:text-black">NOTE</span><span class="leading-snug whitespace-pre-wrap print:text-black">${i.remark}</span></div></div>` : ''}
      </div>`;
    }
    else if (i.category === 'tracking') {
      return `
      <div class="${cardClass}">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-violet-500 opacity-80 print:hidden"></div>
          <div class="${headerClass}">
              <div class="flex items-center gap-3">
                  <span class="${badgeClass} bg-violet-50 text-violet-600">${i.date}</span>
                  <span class="text-xs font-bold text-white bg-violet-400 px-2 py-0.5 rounded-md print:bg-white print:text-black print:border print:border-slate-300">${i.type||'追蹤'}</span>
              </div>
              <div class="text-xs font-bold text-slate-500 flex items-center gap-1 print:text-black">
                  <span class="material-icons-outlined text-sm text-slate-400 print:hidden">person</span> ${i.staff||'--'}
              </div>
          </div>
          <div class="pl-3 text-sm text-slate-700 leading-relaxed whitespace-pre-line print:text-black">${i.content}</div>
      </div>`;
    }
    return '';
  }).join('');
}

function printOverviewReport() { handlePrint(); } 

// ==========================================
// ★★★ 新增：影像載入與上傳邏輯 ★★★
// ==========================================

function loadClientImages() {
  const container = document.getElementById('imageGalleryContainer');
  const countText = document.getElementById('img-stats-text');

  container.innerHTML = '<div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-300"><span class="material-icons-outlined text-4xl animate-spin mb-3">sync</span><p>讀取影像中...</p></div>';
  if(countText) countText.textContent = '讀取中...';

  const clientId = currentClient['個案編號'];

  google.script.run.withSuccessHandler(function(res) {
     if (!res.success) {
        container.innerHTML = '<div class="col-span-full text-center py-10 text-red-400">讀取失敗: ' + res.message + '</div>';
        return;
     }

     const images = res.images;
     if (countText) countText.textContent = '共 ' + images.length + ' 張影像紀錄';

     if (images.length === 0) {
        container.innerHTML = `
          <div class="col-span-full flex flex-col items-center justify-center py-24 bg-white rounded-[2.5rem] border border-slate-100">
              <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-300">
                  <span class="material-icons-outlined text-3xl">broken_image</span>
              </div>
              <p class="text-slate-400 font-bold">無影像資料</p>
              <p class="text-xs text-slate-300 mt-1">請確認雲端資料夾是否已有檔案</p>
          </div>`;
        return;
     }

     container.innerHTML = images.map(img => `
        <div class="group relative bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden aspect-square cursor-pointer hover:shadow-md transition-all" onclick="openLightbox('${img.id}', '${img.name}')">
            <img src="${img.thumbnail}" alt="${img.name}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                <p class="text-white font-bold text-sm truncate">${img.name}</p>
                <p class="text-white/80 text-xs font-mono">${img.date}</p>
            </div>
        </div>
     `).join('');

  }).getClientImages(clientId);
}

function previewFiles(input) {
  const container = document.getElementById('previewList');
  const previewArea = document.getElementById('uploadPreviewArea');
  
  filesToUpload = Array.from(input.files);
  container.innerHTML = '';
  
  if (filesToUpload.length > 0) {
    previewArea.classList.remove('hidden');
    filesToUpload.forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const div = document.createElement('div');
        div.className = "flex items-center gap-3 p-2 bg-slate-50 rounded-xl border border-slate-100";
        div.innerHTML = `
          <div class="w-10 h-10 rounded-lg overflow-hidden bg-white shrink-0">
             <img src="${e.target.result}" class="w-full h-full object-cover">
          </div>
          <div class="flex-1 min-w-0">
             <p class="text-xs font-bold text-slate-700 truncate">${file.name}</p>
             <p class="text-[10px] text-slate-400">${(file.size/1024).toFixed(1)} KB</p>
          </div>`;
        container.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  } else {
    previewArea.classList.add('hidden');
  }
}

function startUpload() {
  if (filesToUpload.length === 0) { 
      showNotification('提示', '請先選擇檔案', 'info'); 
      return; 
  }
  const btn = document.getElementById('btnStartUpload');
  const originalText = btn.innerHTML;
  const remark = document.getElementById('fileRemark').value;
  
  btn.disabled = true;
  btn.innerHTML = '<span class="material-icons-outlined animate-spin mr-2">sync</span>上傳中...';
  
  let successCount = 0;
  
  const processNext = (idx) => {
      if (idx >= filesToUpload.length) {
         showNotification('上傳完成', '成功 ' + successCount + ' / ' + filesToUpload.length, 'success');
         btn.disabled = false; 
         btn.innerHTML = originalText;
         closeModal('uploadImageModal');
         document.getElementById('uploadInput').value = '';
         document.getElementById('fileRemark').value = '';
         document.getElementById('previewList').innerHTML = '';
         document.getElementById('uploadPreviewArea').classList.add('hidden');
         filesToUpload = [];
         loadClientImages();
         return;
      }

      const file = filesToUpload[idx];
      const reader = new FileReader();
      reader.onload = function(e) {
          const content = e.target.result.split(',')[1]; 
          google.script.run.withSuccessHandler(res => {
             if(res.success) successCount++;
             processNext(idx + 1);
          }).withFailureHandler(err => {
             console.error(err);
             processNext(idx + 1);
          }).uploadClientImage(currentClient['個案編號'], content, file.name, file.type, remark);
      };
      reader.readAsDataURL(file);
  };
  
  processNext(0);
}

function openUploadModal() {
  if (!currentClient) { 
      showNotification('提示', '請先選取個案', 'info'); 
      return; 
  }
  document.getElementById('uploadInput').value = '';
  document.getElementById('fileRemark').value = '';
  document.getElementById('previewList').innerHTML = '';
  document.getElementById('uploadPreviewArea').classList.add('hidden');
  filesToUpload = [];
  openModal('uploadImageModal');
}

// ==========================================
// 工具函式
// ==========================================
function resetSearch() { currentClient = null; document.getElementById('topBarClientInfo').classList.add('hidden'); navTo('search'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }

// ==========================================
// Lightbox
// ==========================================
function openLightbox(id, name) {
    const modal = document.getElementById('imageLightbox');
    const img = document.getElementById('lightboxImage');
    const loading = document.getElementById('lightboxLoading');
    const titleDiv = document.getElementById('lightboxTitle');
    if (!modal || !img) return;
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    img.style.opacity = '0';
    img.style.transform = 'scale(0.95)';
    img.src = ""; 
    if (titleDiv) titleDiv.textContent = name || '';
    const highResUrl = `https://lh3.googleusercontent.com/d/${id}=s0`;
    img.onload = function() {
        loading.classList.add('hidden');
        img.style.opacity = '1';
        img.style.transform = 'scale(1)';
    };
    img.src = highResUrl;
    document.body.style.overflow = 'hidden'; 
}
function closeLightbox() {
    const modal = document.getElementById('imageLightbox');
    if (modal) modal.classList.add('hidden');
    const img = document.getElementById('lightboxImage');
    if (img) img.src = '';
    document.body.style.overflow = ''; 
}
document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") closeLightbox();
});

// ==========================================
// 回到頂部按鈕邏輯
// ==========================================
window.addEventListener('scroll', function() {
  const btn = document.getElementById('btnBackToTop');
  if (!btn) return;
  
  if (window.scrollY > 300) {
    btn.classList.remove('hidden');
    btn.classList.add('animate-bounce-in'); 
  } else {
    btn.classList.add('hidden');
  }
});

function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth' 
  });
}

// ==========================================
// ★★★ 自訂通知 (Custom Notification) ★★★
// ==========================================

/**
 * 顯示自訂通知視窗
 * @param {string} title - 標題
 * @param {string} message - 內容訊息
 * @param {string} type - 類型 ('success', 'error', 'info', 'warning')
 */
function showNotification(title, message, type = 'info') {
  const modal = document.getElementById('custom-modal');
  const titleEl = document.getElementById('modal-title');
  const msgEl = document.getElementById('modal-message');
  const iconEl = document.getElementById('modal-icon');
  const iconContainer = document.getElementById('modal-icon-container');
  const btn = document.getElementById('modal-confirm-btn');

  if (!modal) return;

  titleEl.innerText = title;
  msgEl.innerText = message;

  // 重置樣式
  iconContainer.className = 'mx-auto flex items-center justify-center w-16 h-16 rounded-full mb-2';
  btn.className = 'w-full py-3.5 px-4 font-bold rounded-2xl shadow-lg transition-all active:scale-95 text-white';

  if (type === 'success') {
      iconEl.innerText = 'check_circle';
      iconEl.className = 'material-icons-outlined text-3xl text-emerald-600';
      iconContainer.classList.add('bg-emerald-100');
      btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600', 'shadow-emerald-500/20');
  } else if (type === 'error') {
      iconEl.innerText = 'error';
      iconEl.className = 'material-icons-outlined text-3xl text-rose-600';
      iconContainer.classList.add('bg-rose-100');
      btn.classList.add('bg-rose-500', 'hover:bg-rose-600', 'shadow-rose-500/20');
  } else if (type === 'warning') {
      iconEl.innerText = 'warning';
      iconEl.className = 'material-icons-outlined text-3xl text-amber-600';
      iconContainer.classList.add('bg-amber-100');
      btn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'shadow-amber-500/20');
  } else {
      // Info / Default
      iconEl.innerText = 'info';
      iconEl.className = 'material-icons-outlined text-3xl text-slate-500';
      iconContainer.classList.add('bg-slate-100');
      btn.classList.add('bg-slate-700', 'hover:bg-slate-800', 'shadow-slate-500/20');
  }

  modal.classList.remove('hidden');
}

/**
 * 關閉自訂通知視窗
 */
function closeNotification() {
  const modal = document.getElementById('custom-modal');
  if (modal) modal.classList.add('hidden');
}
</script>