<script>
let currentClient = null;
let allTreatmentLogs = [];

window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  
  // 1. 設定所有日期欄位初始值為今日
  document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);

  // 2. 初始化 Flatpickr 美化日曆
  flatpickr('input[type="date"]', {
    locale: "zh_tw",
    dateFormat: "Y-m-d",
    disableMobile: "true", 
    allowInput: true,
    static: true, 
    // 【新增修改】：將月份顯示方式改為下拉選單 (Dropdown)
    monthSelectorType: "dropdown", 
    onChange: function(selectedDates, dateStr, instance) {
      if (instance.element.id === 'filterDate') {
        applyLogFilters();
      }
    }
  });

  loadSystemStaff();
  renderCalendar();
};

// 載入醫師、護理師、治療師
function loadSystemStaff() {
  google.script.run.withSuccessHandler(staff => {
    const ds = document.getElementById('selectDoctor');
    if(ds) {
      ds.innerHTML = '<option value="" disabled selected>請選擇醫師</option>';
      staff.doctors.forEach(n => ds.innerHTML += `<option value="${n}">${n}</option>`);
    }
    const ns = document.getElementById('selectNurse');
    if(ns) {
      ns.innerHTML = '<option value="" disabled selected>請選擇護理師</option>';
      staff.nurses.forEach(n => ns.innerHTML += `<option value="${n}">${n}</option>`);
    }
    const ts = document.getElementById('inputTherapist');
    const fts = document.getElementById('filterTherapist');
    if(ts) {
      ts.innerHTML = '<option value="" disabled selected>請選擇治療師</option>';
      staff.therapists.forEach(n => ts.innerHTML += `<option value="${n}">${n}</option>`);
    }
    if(fts) {
      fts.innerHTML = '<option value="">所有執行人員</option>';
      staff.therapists.forEach(n => fts.innerHTML += `<option value="${n}">${n}</option>`);
    }
  }).getSystemStaff();
}

function navTo(viewName) {
  if (!currentClient && viewName !== 'search') { alert("請先選取個案。"); return; }
  
  const views = ['search', 'basic', 'images', 'treatment', 'maintenance', 'doctor', 'tracking', 'overview'];
  views.forEach(v => {
    const el = document.getElementById('view-' + v);
    if(el) el.classList.add('hidden');
    const btn = document.getElementById('btn-' + v);
    if(btn) btn.classList.remove('bg-slate-800', 'text-white', 'font-bold');
  });

  const target = document.getElementById('view-' + viewName);
  if(target) target.classList.remove('hidden');
  const targetBtn = document.getElementById('btn-' + viewName);
  if(targetBtn) targetBtn.classList.add('bg-slate-800', 'text-white', 'font-bold');

  const titles = { 'search':'搜尋','basic':'基本資料','images':'影像總覽','treatment':'治療紀錄','maintenance':'保養項目','doctor':'醫師看診','tracking':'個管追蹤','overview':'個案總覽'};
  document.getElementById('pageTitle').textContent = titles[viewName] || '康飛運醫';

  if(viewName === 'doctor') loadDoctorHistory();
  if(viewName === 'treatment') loadTreatmentHistory();
}

function handleSearch() {
  const kw = document.getElementById('searchInput').value.trim();
  if (!kw) return;
  const container = document.getElementById('searchResults');
  container.innerHTML = '<div class="text-center py-10 text-slate-400">搜尋中...</div>';
  google.script.run.withSuccessHandler(data => {
    container.innerHTML = '';
    if(data.length === 0) { container.innerHTML = '<div class="text-center py-10">查無資料</div>'; return; }
    data.forEach(c => {
      const div = document.createElement('div');
      div.className = "bg-white p-5 rounded-3xl shadow-sm border border-slate-100 hover:border-emerald-500 cursor-pointer transition flex justify-between items-center group";
      div.onclick = () => selectClient(c);
      div.innerHTML = `<div><div class="font-black text-slate-800">${c['姓名']} <span class="text-xs font-normal text-slate-400">${c['個案編號']}</span></div><div class="text-sm text-slate-400">${c['電話']}</div></div><div class="text-emerald-500 opacity-0 group-hover:opacity-100 transition">選取 →</div>`;
      container.appendChild(div);
    });
  }).searchClient(kw);
}

function selectClient(c) {
  currentClient = c;
  document.getElementById('topBarClientInfo').classList.remove('hidden');
  document.getElementById('headerClientName').textContent = c['姓名'];
  document.getElementById('headerClientDob').textContent = c['生日'];
  document.querySelectorAll('.auto-fill-id').forEach(el => el.value = c['個案編號']);
  navTo('treatment');
}

// 治療紀錄讀取
function loadTreatmentHistory() {
  const container = document.getElementById('historyListContainer');
  container.innerHTML = '<div class="text-center py-10 text-slate-400">讀取中...</div>';
  google.script.run.withSuccessHandler(logs => {
    allTreatmentLogs = logs;
    applyLogFilters();
  }).getClientHistory(currentClient['個案編號'], 'Treatment_Logs');
}

function applyLogFilters() {
  const t = document.getElementById('filterTherapist').value;
  const d = document.getElementById('filterDate').value;
  const filtered = allTreatmentLogs.filter(log => {
    let mt = t ? log['執行治療師'] === t : true;
    let md = d ? log['治療日期'].includes(d) : true;
    return mt && md;
  });
  renderTreatmentList(filtered);
}

function renderTreatmentList(logs) {
  const container = document.getElementById('historyListContainer');
  if(!logs.length) { container.innerHTML = '<div class="text-center py-10 text-slate-300">無紀錄</div>'; return; }
  let html = '';
  logs.forEach(log => {
    html += `
      <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-50 border-l-4 border-l-emerald-500">
        <div class="flex justify-between items-center mb-2">
          <span class="text-xs font-bold text-slate-400">${log['治療日期']}</span>
          <span class="text-sm font-bold text-emerald-600">${log['執行治療師']}</span>
        </div>
        <p class="text-xs text-slate-400 mb-2">主訴: ${log['當日主訴']||'--'}</p>
        <p class="text-sm text-slate-700 whitespace-pre-wrap">${log['治療內容']}</p>
      </div>`;
  });
  container.innerHTML = html;
}/**
 * 統一處理表單提交
 */
function submitForm(type) {
  if (!currentClient) { alert("請先選擇個案"); return; }

  // --- 醫師看診儲存邏輯 ---
  if (type === 'doctor') {
    const formData = {
      clientId: currentClient['個案編號'],
      date: document.getElementById('doctorDate').value,
      doctor: document.getElementById('selectDoctor').value,
      nurse: document.getElementById('selectNurse').value,
      complaint: document.querySelector('#view-doctor textarea[name="主訴"]').value,
      objective: document.querySelector('#view-doctor textarea[name="客觀檢查"]').value,
      diagnosis: document.querySelector('#view-doctor textarea[name="診斷"]').value,
      plan: document.querySelector('#view-doctor textarea[name="治療計畫"]').value,
      remark: document.getElementById('doctorRemark').value // 抓取備註資料
    };

    if (!formData.date || !formData.doctor) { alert("請填寫日期與醫師"); return; }

    // 儲存按鈕狀態切換 (Loading 效果)
    const btn = event.target;
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "儲存中...";

    google.script.run
      .withSuccessHandler(res => {
        btn.disabled = false;
        btn.innerText = originalText;
        alert(res.message);
        
        if(res.success) {
          // 重置表單
          document.getElementById('doctorForm').reset();
          
          // 【關鍵修改位置】：手動清空備註欄位，確保 UI 完全乾淨
          document.getElementById('doctorRemark').value = '';
          
          // 重新整理歷史列表以顯示最新資料
          loadDoctorHistory(); 
        }
      })
      .withFailureHandler(err => {
        btn.disabled = false;
        btn.innerText = originalText;
        alert("儲存失敗（系統錯誤）：" + err);
      })
      .saveDoctorConsultation(formData);

  // --- 治療紀錄儲存邏輯 ---
  } else if (type === 'treatment') {
    const formData = {
      '個案編號': currentClient['個案編號'],
      '治療日期': document.getElementById('inputDate').value,
      '執行治療師': document.getElementById('inputTherapist').value,
      '當日主訴': document.getElementById('inputComplaint').value,
      '治療內容': document.getElementById('inputContent').value
    };

    if (!formData['治療日期'] || !formData['執行治療師']) { alert("請填寫日期與治療師"); return; }

    google.script.run
      .withSuccessHandler(res => {
        alert(res.message);
        if(res.success) {
          document.getElementById('treatmentForm').reset();
          loadTreatmentHistory();
        }
      })
      .saveData('Treatment_Logs', formData);
  }
}

/**
 * 醫師歷史紀錄渲染：顯示完整 SOAP (S, O, A, P) + 備註
 */
function loadDoctorHistory() {
  const container = document.getElementById('doctorHistoryList');
  container.innerHTML = '<div class="text-center py-10 text-slate-400">讀取中...</div>';
  
  google.script.run.withSuccessHandler(logs => {
    if(!logs || !logs.length) { 
      container.innerHTML = '<div class="py-10 text-center text-slate-300">尚無看診紀錄</div>'; 
      return; 
    }
    
    let html = '';
    logs.forEach(log => {
      html += `
        <div class="bg-white border border-slate-100 rounded-3xl p-8 shadow-sm mb-6 transition hover:shadow-md">
          <!-- 頂部資訊：日期、醫師、護理師 -->
          <div class="flex justify-between items-center mb-6">
            <span class="text-xs font-bold bg-emerald-50 text-emerald-600 px-4 py-1.5 rounded-full ring-1 ring-emerald-100">
              ${log['看診日期'] || '--'}
            </span>
            <span class="text-sm font-bold text-slate-500">
              醫師：<span class="text-slate-800 mr-3">${log['看診醫師'] || '--'}</span>
              護理：<span class="text-slate-800">${log['護理師'] || '--'}</span>
            </span>
          </div>
          
          <!-- 核心 SOAP 2x2 網格 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-xs">
            <!-- S: 主訴 -->
            <div class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100">
              <p class="text-blue-600 mb-2 font-black flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>主訴 (S)
              </p>
              <div class="text-slate-700 leading-relaxed whitespace-pre-wrap">${log['S_主訴'] || '--'}</div>
            </div>
            
            <!-- O: 檢查 -->
            <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100">
              <p class="text-indigo-600 mb-2 font-black flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span>客觀檢查 (O)
              </p>
              <div class="text-slate-700 leading-relaxed whitespace-pre-wrap">${log['O_客觀檢查'] || '--'}</div>
            </div>
            
            <!-- A: 診斷 -->
            <div class="bg-amber-50/50 p-4 rounded-2xl border border-amber-100">
              <p class="text-amber-600 mb-2 font-black flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 bg-amber-500 rounded-full"></span>診斷評估 (A)
              </p>
              <div class="text-slate-700 leading-relaxed whitespace-pre-wrap">${log['A_診斷'] || '--'}</div>
            </div>
            
            <!-- P: 計畫 -->
            <div class="bg-emerald-50/50 p-4 rounded-2xl border border-emerald-100">
              <p class="text-emerald-600 mb-2 font-black flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>治療計畫 (P)
              </p>
              <div class="text-slate-700 leading-relaxed whitespace-pre-wrap">${log['P_治療計劃'] || '--'}</div>
            </div>
          </div>

          <!-- 備註區塊 (若有內容才顯示) -->
          ${log['備註'] && log['備註'] !== '--' ? `
          <div class="bg-slate-50 p-5 rounded-2xl border border-dashed border-slate-200">
            <p class="text-slate-400 mb-2 font-black text-[10px] uppercase tracking-widest flex items-center gap-1.5">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
              備註 REMARK
            </p>
            <div class="text-slate-600 text-xs leading-relaxed whitespace-pre-wrap">${log['備註']}</div>
          </div>` : ''}
        </div>`;
    });
    container.innerHTML = html;
  }).getClientHistory(currentClient['個案編號'], 'Doctor_Consultation');
}

// 基礎工具函數
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function resetSearch() { currentClient = null; document.getElementById('topBarClientInfo').classList.add('hidden'); navTo('search'); }
function renderCalendar() { /* 支援治療紀錄分頁的月曆渲染 */ }

</script>